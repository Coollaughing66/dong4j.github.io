(window.webpackJsonp=window.webpackJsonp||[]).push([[70],{324:function(s,t,a){"use strict";a.r(t);var n=a(0),e=Object(n.a)({},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("div",{staticClass:"tip custom-block"},[a("p",[s._v("使用 Redis Sentinel 重构现有架构")])]),s._v(" "),a("h1",{attrs:{id:"redis-proxy-重构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis-proxy-重构","aria-hidden":"true"}},[s._v("#")]),s._v(" redis-proxy 重构")]),s._v(" "),a("hr"),s._v(" "),a("p",[s._v("[toc]")]),s._v(" "),a("blockquote",[a("p",[s._v("对于搭建高可用 Redis 服务, 网上已有了很多方案, 例如 Keepalived, Codis, Twemproxy, Redis Sentinel.\n其中 Codis 和 Twemproxy 主要是用于大规模的 Redis 集群中, 也是在 Redis 官方发布 Redis Sentinel 之前 豌豆荚 和 twitter 提供的开源解决方案.\nRedis Sentinel可以理解为一个监控 Redis Server 服务是否正常的进程, 并且一旦检测到不正常, 可以自动地将备份(slave)Redis Server启用, 使得外部用户对Redis服务内部出现的异常无感知.")])]),s._v(" "),a("h2",{attrs:{id:"原有架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#原有架构","aria-hidden":"true"}},[s._v("#")]),s._v(" 原有架构")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-3915800D-B858-4AB4-BABD-23CCC8E72DFB.png",alt:"3915800D-B858-4AB4-BABD-23CCC8E72DFB"}})]),s._v(" "),a("h3",{attrs:{id:"存在的问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#存在的问题","aria-hidden":"true"}},[s._v("#")]),s._v(" 存在的问题")]),s._v(" "),a("ol",[a("li",[s._v("配置部署复杂")]),s._v(" "),a("li",[s._v("不稳定")])]),s._v(" "),a("h2",{attrs:{id:"redis-sentinel-高可用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis-sentinel-高可用","aria-hidden":"true"}},[s._v("#")]),s._v(" Redis Sentinel 高可用")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-1F89EC1A-910B-4F58-B1BA-8B4ED8F1B1A8.png",alt:"1F89EC1A-910B-4F58-B1BA-8B4ED8F1B1A8"}})]),s._v(" "),a("p",[s._v("下面以1个主节点、2个从节点、3个Sentinel节点组成的Redis Sentinel为例子")]),s._v(" "),a("p",[a("strong",[s._v("故障转移处理逻辑:")])]),s._v(" "),a("ol",[a("li",[a("p",[s._v("主节点出现故障, 此时两个从节点与主节点时区连接, 主从复制失败;")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-85406409-6B92-4CE0-A282-6E67A5DBA68D.png",alt:"85406409-6B92-4CE0-A282-6E67A5DBA68D"}})])]),s._v(" "),a("li",[a("p",[s._v("每个 Sentinel 节点通过定期监控发现主节点出现故障;")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-00FDFC3B-4DD0-4324-812B-B7FC4ED1D211.png",alt:"00FDFC3B-4DD0-4324-812B-B7FC4ED1D211"}})])]),s._v(" "),a("li",[a("p",[s._v("多个 Sentinel 节点对主节点的故障达成一致, 选举出 sentinel-3 节点作为领导者负责故障转移;")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-212E5E3C-AB42-41B9-8DAF-61BFB3EDFC6B.png",alt:"212E5E3C-AB42-41B9-8DAF-61BFB3EDFC6B"}})]),s._v(" "),a("ol",[a("li",[s._v("原来的从节点 slave-1 成为新的主节点后, 更新应用方的主节点信息;")]),s._v(" "),a("li",[s._v("客户端命令另一个从节点 slave-2 去复制新的主节点;")]),s._v(" "),a("li",[s._v("待原来的主节点恢复后, 让它去复制新的主节点;")])]),s._v(" "),a("p",[a("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-0151B897-8FC5-4700-8DD7-E596BAFAF002.png",alt:"0151B897-8FC5-4700-8DD7-E596BAFAF002"}})])]),s._v(" "),a("li",[a("p",[s._v("故障转移后的结构图")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-19036242-6602-47DF-85DA-042602A80A11.png",alt:"19036242-6602-47DF-85DA-042602A80A11"}})])])]),s._v(" "),a("h3",{attrs:{id:"redis-sentinel-功能"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis-sentinel-功能","aria-hidden":"true"}},[s._v("#")]),s._v(" Redis Sentinel 功能")]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("监控:")]),s._v(" Sentinel 节点会定期检测 Redis 数据节点和其余 Sentinel 节点是否可达;")]),s._v(" "),a("li",[a("strong",[s._v("通知:")]),s._v(" Sentinel 节点会将故障转移的结果通知给应用方;")]),s._v(" "),a("li",[a("strong",[s._v("主节点故障转移:")]),s._v(" 实现从节点晋升为主节点并维护后续正确的主从关系;")]),s._v(" "),a("li",[a("strong",[s._v("配置提供者:")]),s._v(" 客户端在初始化时, 连接 Sentinel 节点集群, 从中获取主节点信息;")])]),s._v(" "),a("p",[s._v("采用多个 Sentinel 节点的优点:")]),s._v(" "),a("ol",[a("li",[s._v("对于节点故障判断由多个 Sentinel 节点共同完成, 有效防止误判;")]),s._v(" "),a("li",[s._v("避免单点故障;")])]),s._v(" "),a("h3",{attrs:{id:"几个概念"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#几个概念","aria-hidden":"true"}},[s._v("#")]),s._v(" 几个概念")]),s._v(" "),a("h4",{attrs:{id:"三个定时监控任务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三个定时监控任务","aria-hidden":"true"}},[s._v("#")]),s._v(" 三个定时监控任务")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("每隔 10 秒. 每个 Sentinel 节点会向主节点和从节点发送 info 命令获取最新的拓扑结构;\n"),a("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-915859E8-EA7B-4A1E-BBC0-A7D1FA91C6CC.png",alt:"-w400"}})])]),s._v(" "),a("li",[a("p",[s._v("每隔 2 秒, 每个 Sentinel 节点向 "),a("em",[s._v("sentinel")]),s._v(":hello 频道上发送该 Sentinel 节点对于主节点的判断一级当前 Sentinel 节点的信息, 同时每个 Sentinel 节点也会订阅该频道;\n"),a("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-F5B2D7CD-4E0C-4F40-BCD0-B827BC26D8F2.png",alt:"-w400"}})])]),s._v(" "),a("li",[a("p",[s._v("每隔 1 秒, 每个 Sentine 会向主从节点, 其他 Sentinel 节点发送 ping 命令做心跳检测, 来确保节点当前是否可达\n"),a("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-8666FF6B-28E5-4F5F-B44E-0FDADBA8AE5A.png",alt:"-w400"}})])])]),s._v(" "),a("h4",{attrs:{id:"主观下线（subjectively-down-简称-sdown）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#主观下线（subjectively-down-简称-sdown）","aria-hidden":"true"}},[s._v("#")]),s._v(" 主观下线（Subjectively Down,  简称 SDOWN）")]),s._v(" "),a("blockquote",[a("p",[s._v("指的是单个 Sentinel 实例对服务器做出的下线判断.")])]),s._v(" "),a("p",[s._v("每个 Sentinel 节点会每隔1秒对主节 点、从节点、其他 Sentinel 节点发送 ping 命令做心跳检测, 当这些节点超过 down-after-milliseconds 没有进行有效回复, Sentinel 节点就会对该节点做失败 判定, 这个行为叫做主观下线")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-F743A8AB-F913-4949-B6EE-CD35D4C532F9.png",alt:"-w400"}})]),s._v(" "),a("h4",{attrs:{id:"客观下线（objectively-down-简称-odown）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#客观下线（objectively-down-简称-odown）","aria-hidden":"true"}},[s._v("#")]),s._v(" 客观下线（Objectively Down,  简称 ODOWN）")]),s._v(" "),a("blockquote",[a("p",[s._v("指的是多个 Sentinel 实例在对同一个服务器做出 SDOWN 判断,  并且通过 SENTINEL is-master-down-by-addr 命令互相交流之后,  得出的服务器下线判断.  （一个 Sentinel 可以通过向另一个 Sentinel 发送 SENTINEL is-master-down-by-addr 命令来询问对方是否认为给定的服务器已下线. ）")])]),s._v(" "),a("h2",{attrs:{id:"redis-sentinel-安装与部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis-sentinel-安装与部署","aria-hidden":"true"}},[s._v("#")]),s._v(" Redis Sentinel 安装与部署")]),s._v(" "),a("p",[s._v("下面将以3个Sentinel节点、1个主节点、2个从节点组成一个Redis Sentinel进行说明")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-109FCB47-B219-49C7-B36E-6E234765C931.png",alt:"109FCB47-B219-49C7-B36E-6E234765"}})]),s._v(" "),a("p",[s._v("具体的物理部署:")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[s._v("角色")]),s._v(" "),a("th",{staticStyle:{"text-align":"left"}},[s._v("ip")]),s._v(" "),a("th",{staticStyle:{"text-align":"left"}},[s._v("port")]),s._v(" "),a("th",{staticStyle:{"text-align":"left"}},[s._v("别名")])])]),s._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[s._v("master")]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("127.0.0.1")]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("6379")]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("主节点")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[s._v("slave-1")]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("127.0.0.1")]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("6380")]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("slave-1")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[s._v("slave-2")]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("127.0.0.1")]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("6381")]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("slave-2")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[s._v("sentinel-1")]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("127.0.0.1")]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("26379")]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("sentinel-1")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[s._v("sentinel-2")]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("127.0.0.1")]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("26380")]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("sentinel-2")])]),s._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[s._v("sentinel-3")]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("127.0.0.1")]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("26381")]),s._v(" "),a("td",{staticStyle:{"text-align":"left"}},[s._v("sentinel-3")])])])]),s._v(" "),a("p",[a("strong",[s._v("1. master 配置")])]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("daemonize yes\ndbfilename "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6379.db"')]),s._v("\ndir "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/Users/codeai/Develop/logs/redis/db/"')]),s._v("\nlogfile "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/Users/codeai/Develop/logs/redis/log/6379.log"')]),s._v("\nport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\nrequirepass "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1234")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[a("strong",[s._v("2. slave-1 配置")])]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("daemonize yes\ndbfilename "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6380.db"')]),s._v("\ndir "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/Users/codeai/Develop/logs/redis/db/"')]),s._v("\nlogfile "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/Users/codeai/Develop/logs/redis/log/6380.log"')]),s._v("\nport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6380")]),s._v("\nslaveof "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 设置 master 验证密码\nmasterauth "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1234")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 设置 slave 密码\nrequirepass "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1234")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[a("strong",[s._v("3. slave-2 配置")])]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("daemonize yes\ndbfilename "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6381.db"')]),s._v("\ndir "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/Users/codeai/Develop/logs/redis/db/"')]),s._v("\nlogfile "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/Users/codeai/Develop/logs/redis/log/6381.log"')]),s._v("\nport "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6381")]),s._v("\nslaveof "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 设置 master 验证密码\nmasterauth "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1234")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 设置 slave 密码\nrequirepass "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1234")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[a("strong",[s._v("4. 启动 redis 服务")])]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("server redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379.")]),s._v("conf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("server redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6380.")]),s._v("conf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("server redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6381.")]),s._v("conf\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-A62CC675-0FA4-4A6A-B432-5CAD116B95C5.png",alt:"A62CC675-0FA4-4A6A-B432-5CAD116B95"}})]),s._v(" "),a("p",[a("strong",[s._v("5. 确认主从关系")])]),s._v(" "),a("p",[s._v("主节点视角")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("cli "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("h "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" info replication\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" Replication\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 主节点\nrole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("master\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 有 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" 个 从节点\nconnected_slaves"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 从节点 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" 信息\nslave0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6380")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("state"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("online"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("offset"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("112")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("lag"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 从节点 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" 信息\nslave1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6381")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("state"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("online"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("offset"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("112")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("lag"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nmaster_replid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("8f43dc48cca779f46fa1516a38e24fb8c5423d94\nmaster_replid2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0000000000000000000000000000000000000000")]),s._v("\nmaster_repl_offset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("112")]),s._v("\nsecond_repl_offset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nrepl_backlog_active"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nrepl_backlog_size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1048576")]),s._v("\nrepl_backlog_first_byte_offset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nrepl_backlog_histlen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("112")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("p",[s._v("从节点视角")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("cli "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("h "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6380")]),s._v(" info replication\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" Replication\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 从节点\nrole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("slave\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 主节点信息\nmaster_host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),s._v("\nmaster_port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\nmaster_link_status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("up\nmaster_last_io_seconds_ago"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\nmaster_sync_in_progress"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nslave_repl_offset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("238")]),s._v("\nslave_priority"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\nslave_read_only"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nconnected_slaves"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nmaster_replid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("8f43dc48cca779f46fa1516a38e24fb8c5423d94\nmaster_replid2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0000000000000000000000000000000000000000")]),s._v("\nmaster_repl_offset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("238")]),s._v("\nsecond_repl_offset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nrepl_backlog_active"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nrepl_backlog_size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1048576")]),s._v("\nrepl_backlog_first_byte_offset"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nrepl_backlog_histlen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("238")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("p",[a("strong",[s._v("6. 部署 Sentinel 节点")])]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v("\ndaemonize yes\nlogfile "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/Users/codeai/Develop/logs/redis/log/26379.log"')]),s._v("\ndir "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/Users/codeai/Develop/logs/redis/db/"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 监控 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" 主节点"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" 表示判断主节点失败至少需要 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" 个 sentinel 节点同意\nsentinel monitor mymaster "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 设置监听的 master 密码\nsentinel auth"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("pass mymaster "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1234")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v(" 秒内 ping 失败"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sentinel 则认为 master 不可用\nsentinel down"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("after"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("milliseconds mymaster "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 在发生failover主备切换时"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 这个选项指定了最多可以有多少个slave同时对新的master进行同步\nsentinel parallel"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("syncs mymaster "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 如果在该时间（ms）内未能完成failover操作"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 则认为该failover失败\nsentinel failover"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("timeout mymaster "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("180000")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("其他节点只是端口不同")]),s._v(" "),a("p",[a("strong",[s._v("7. 启动 sentinel 节点")])]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 方式一\nredis"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("sentinel redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("sentinel"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379.")]),s._v("conf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("sentinel redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("sentinel"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26380.")]),s._v("conf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("sentinel redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("sentinel"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26381.")]),s._v("conf\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 方式二\nredis"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("server redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("sentinel"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379.")]),s._v("conf "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--sentinel; redis-server redis-sentinel-26380.conf --sentinel; redis-server redis-sentinel-26381.conf --sentinel; ")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[a("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-4B44AF64-E724-4A23-A09A-297489A6F834.png",alt:"4B44AF64-E724-4A23-A09A-297489A6F834"}})]),s._v(" "),a("p",[a("strong",[s._v("8. 确认关系")])]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("redis"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("cli "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("h "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),s._v(" info sentinel\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" Sentinel\nsentinel_masters"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nsentinel_tilt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nsentinel_running_scripts"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nsentinel_scripts_queue_length"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nsentinel_simulate_failure_flags"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nmaster0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mymaster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("status"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ok"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("address"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("slaves"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sentinels"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h2",{attrs:{id:"部署方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署方案","aria-hidden":"true"}},[s._v("#")]),s._v(" 部署方案")]),s._v(" "),a("ol",[a("li",[s._v("Sentinel 部署在不同物理机上;")]),s._v(" "),a("li",[s._v("部署至少三个且奇数个的 Sentinel 节点;")])]),s._v(" "),a("h3",{attrs:{id:"一套-sentinel-监控所有主节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一套-sentinel-监控所有主节点","aria-hidden":"true"}},[s._v("#")]),s._v(" 一套 Sentinel 监控所有主节点")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-1656C749-77D9-4004-971A-5E6A751AA602.png",alt:"-w500"}})]),s._v(" "),a("p",[s._v("优点:")]),s._v(" "),a("ol",[a("li",[s._v("维护成本低")])]),s._v(" "),a("p",[s._v("缺点:")]),s._v(" "),a("ol",[a("li",[s._v("集群出现异常, 将导致服务不可用")]),s._v(" "),a("li",[s._v("过多的网络连接")])]),s._v(" "),a("h3",{attrs:{id:"每个主节点各一套-sentinel"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#每个主节点各一套-sentinel","aria-hidden":"true"}},[s._v("#")]),s._v(" 每个主节点各一套 Sentinel")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-6D2AAB5C-054B-4595-94C2-9BEAD0EAABAB.png",alt:"-w500"}})]),s._v(" "),a("p",[s._v("优点:")]),s._v(" "),a("ol",[a("li",[s._v("某个 Sentinel 集群出现故障, 不会影响其他业务")]),s._v(" "),a("li",[s._v("网络连接少")])]),s._v(" "),a("p",[s._v("缺点:")]),s._v(" "),a("ol",[a("li",[s._v("维护成本高")])]),s._v(" "),a("blockquote",[a("p",[s._v("如果监控同一个业务的多个主节点集合, 推荐使用方案一\n如果是多个业务不同主节点集合, 推荐方案二 (推荐)")])]),s._v(" "),a("h2",{attrs:{id:"redis-连接数太多导致"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis-连接数太多导致","aria-hidden":"true"}},[s._v("#")]),s._v(" Redis 连接数太多导致")]),s._v(" "),a("h3",{attrs:{id:"原因分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#原因分析","aria-hidden":"true"}},[s._v("#")]),s._v(" 原因分析")]),s._v(" "),a("p",[s._v("Redis 默认最大连接数为 10000个")]),s._v(" "),a("ol",[a("li",[s._v("网络通信差, 按照 TCP 协议, 客户端断开连接时, 向服务器端发送 FIN 信号, 但是服务端未接收到, 客户端超时后放弃等待, 直接断开, 服务端由于通信故障, 保持了 ESTABLISHED 状态;")]),s._v(" "),a("li",[s._v("客户端异常, 客户端连接之后, 由于代码运行过程中产生异常, 导致未正常释放或者关闭连接;")]),s._v(" "),a("li",[s._v("client 设置不合理 (client 数 * maxTotal 是不能超过redis的最大连接数)")])]),s._v(" "),a("h3",{attrs:{id:"解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决方案","aria-hidden":"true"}},[s._v("#")]),s._v(" 解决方案")]),s._v(" "),a("p",[a("strong",[s._v("1. 修改 redis.config 配置")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# 连接的空闲实现超过 360s, 则主动关闭连接;默认配置为 0 ,导致所有空闲 idle 连接未被释放, 服务端连接泄漏\ntimeout 360\n# 默认关闭, 导致服务端不知客户端连接状态; 开启长连接, 服务端主动(60s)探测客户端 socket 状态\ntcp-keeplive 60\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[a("strong",[s._v("2. 完善代码")])]),s._v(" "),a("blockquote",[a("p",[s._v("客户端每次执行完 jedis 里面的方法之后必须关闭链接, 释放资源")])]),s._v(" "),a("p",[a("strong",[s._v("3. redis-proxy 服务化")])]),s._v(" "),a("hr"),s._v(" "),a("h2",{attrs:{id:"重构方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#重构方案","aria-hidden":"true"}},[s._v("#")]),s._v(" 重构方案")]),s._v(" "),a("blockquote",[a("p",[s._v("使用 Redis Sentinel 代替 Redis + Keepalived")])]),s._v(" "),a("h3",{attrs:{id:"架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#架构","aria-hidden":"true"}},[s._v("#")]),s._v(" 架构")]),s._v(" "),a("p",[s._v("重构 redis-proxy")]),s._v(" "),a("p",[s._v("提供 6 种 连接模式")]),s._v(" "),a("p",[a("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-0652C208-B9C1-4505-92BB-C1BFBC09E9C4.png",alt:"0652C208-B9C1-4505-92BB-C1BFBC09E9"}})]),s._v(" "),a("h3",{attrs:{id:"component-redis-介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#component-redis-介绍","aria-hidden":"true"}},[s._v("#")]),s._v(" component-redis 介绍")]),s._v(" "),a("p",[s._v("项目中有单独使用 Redis 的, 也有使用分片方式连接的, 也有使用 redis-proxy 组件来连接 Redis 的.\n造成代码不好管理, 因此使用 component-redis 组件为其他模块提供连接 Redis 的功能, 统一管理 Redis 相关代码.")]),s._v(" "),a("p",[s._v("作为连接 Redis 的工具模块, 为其他模块提供操作 Redis 的功能, 具有多种模式选择.\n客户端不需要再写连接 Redis 相关代码, 只需要按照要求配置即可,减少了冗余代码;")]),s._v(" "),a("p",[s._v("兼容原有代码, 只需要将 redis-proxy 依赖替换成 component-redis 即可使用.")]),s._v(" "),a("h4",{attrs:{id:"功能"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#功能","aria-hidden":"true"}},[s._v("#")]),s._v(" 功能")]),s._v(" "),a("ol",[a("li",[s._v("多种模式任君选择 (standalone, sentinel, shard, shard-sentinel, cluster, hybrid);")]),s._v(" "),a("li",[s._v("使用简单, 引入 jar 即可使用;")]),s._v(" "),a("li",[s._v("扩展方便, 如果 "),a("code",[s._v("RedisService")]),s._v(" 满足不了现有业务需要, 可直接使用各种 Pool 获取 jedis, shardedJedis, jedisCluster 自由发挥;")])]),s._v(" "),a("h4",{attrs:{id:"使用方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用方式","aria-hidden":"true"}},[s._v("#")]),s._v(" 使用方式")]),s._v(" "),a("h5",{attrs:{id:"_1-引入依赖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-引入依赖","aria-hidden":"true"}},[s._v("#")]),s._v(" 1. 引入依赖")]),s._v(" "),a("div",{staticClass:"language-xml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("com.iflytek.musicsearch"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("component-redis"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("最新版本"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h5",{attrs:{id:"_2-配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-配置","aria-hidden":"true"}},[s._v("#")]),s._v(" 2. 配置")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" jedis pool 配置\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 连接超时时间（毫秒）\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("connectionTimeout"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 等待Response超时时间 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("新增"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("soTimeout"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("maxActive"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("maxWait"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("maxIdle"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v("\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("minIdleTime"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("120")]),s._v("\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testOnBorrow"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("true")]),s._v("\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testOnReturn"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("false")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" Redis 配置\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("model"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("standalone\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("node"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("h5",{attrs:{id:"_3-注入-service"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-注入-service","aria-hidden":"true"}},[s._v("#")]),s._v(" 3. 注入 service")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Autowired")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RedisService")]),s._v(" redisService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Test")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("testRedisService")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    redisService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"redisServiceTest"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"redisServiceTest"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h3",{attrs:{id:"component-redis-配置规范"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#component-redis-配置规范","aria-hidden":"true"}},[s._v("#")]),s._v(" component-redis 配置规范")]),s._v(" "),a("blockquote",[a("p",[s._v("由于 component-redis 组件需要支持多种模式, 配置需要规范的格式才能避免出错.")])]),s._v(" "),a("ol",[a("li",[s._v("节点使用 "),a("code",[s._v(",")]),s._v(" 分隔, 模式分组使用 "),a("code",[s._v(";")]),s._v(" 分隔;")]),s._v(" "),a("li",[s._v("使用某个 Redis 时, 不要把所有配置全部加上;")])]),s._v(" "),a("p",[s._v("jedisPool 配置是固定配置, 每种模式都会使用到, 只需要根据业务调整即可.")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 连接超时时间（毫秒）\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("connectionTimeout"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 等待Response超时时间 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("新增"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("soTimeout"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 连接池最大连接数（使用负值表示没有限制）\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("maxActive"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 连接池最大阻塞等待时间（使用负值表示没有限制）\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("maxWait"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 连接池中的最大空闲连接\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("maxIdle"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 连接池中的最小空闲连接\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("minIdleTime"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("120")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 当调用borrow Object方法时"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 是否进行有效性检查\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testOnBorrow"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("true")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 调用"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" 一个对象方法时"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 是否检查其有效性\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("testOnReturn"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("false")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("model"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("模式名\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("node"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("业务名"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v("模式名"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("password@"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("ip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("port"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("database"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("这里以现有业务为例子:")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("model"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("hybrid\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" callout 使用单机模式"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" biz 使用哨兵模式\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("node"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("callout"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v("standalone"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1234")]),s._v("@"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6382")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("biz"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v("sentinel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5678")]),s._v("@"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sentinel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26380")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sentinel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26381")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h4",{attrs:{id:"配置优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置优化","aria-hidden":"true"}},[s._v("#")]),s._v(" 配置优化")]),s._v(" "),a("p",[a("strong",[s._v("使用标准的 uri 协议代替 host 和 port")])]),s._v(" "),a("p",[s._v("避免手动解析出错")]),s._v(" "),a("p",[s._v("格式如下:")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 完整格式\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("password@ip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("database\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 不需要用户名的格式\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("password@ip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("database\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 不需要密码的格式\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),s._v("ip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("database\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" 不需要 database 的配置"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" 将默认使用 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" db\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),s._v("ip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("port\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[a("strong",[s._v("密码设置")])]),s._v(" "),a("p",[s._v("redis的查询速度是非常快的, 外部用户一秒内可以尝试多大150K个密码；所以密码要尽量长;")]),s._v(" "),a("p",[s._v("建议设置为 64 位长度密码")]),s._v(" "),a("h5",{attrs:{id:"standalone-单机-模式配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#standalone-单机-模式配置","aria-hidden":"true"}},[s._v("#")]),s._v(" standalone (单机)模式配置")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("model"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("standalone\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" password 前面的 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 不能少\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("node"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("password@"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6382")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("demo:")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("model"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("standalone\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("node"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h5",{attrs:{id:"sentinel"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sentinel","aria-hidden":"true"}},[s._v("#")]),s._v(" sentinel")]),s._v(" "),a("p",[s._v("哨兵模式是对单机模式高可用的一种实现方式, 可以实现故障主从自动切换")]),s._v(" "),a("p",[s._v("哨兵模式需要配置 master name, 和 "),a("code",[s._v("redis-sentinel")]),s._v(".conf 中的 "),a("code",[s._v("sentinel monitor masterName xxx")]),s._v(" 保持一致")]),s._v(" "),a("p",[s._v("哨兵模式只能接收一个密码, 密码设置在任意节点即可(第一个最好了)")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("model"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sentinel\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("node"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mymaster"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1234")]),s._v("@"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26380")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26381")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("哨兵模式就是单机模式的增强版, 需要配置多个哨兵节点(避免造成主从切换失败, 最少3组哨兵), 节点之间使用 "),a("code",[s._v(",")]),s._v(" 分隔")]),s._v(" "),a("p",[s._v("demo:")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("model"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sentinel\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("node"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mymaster"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("s4jRcLhAcUdKrNmqv9XQxwbEUZ6p4sK3kTFE4k9ts3PLahnswEzE4aPgXEQ6QdMa@"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26380")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26381")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h5",{attrs:{id:"sharding-分片-模式配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sharding-分片-模式配置","aria-hidden":"true"}},[s._v("#")]),s._v(" sharding (分片)模式配置")]),s._v(" "),a("p",[a("strong",[s._v("每组 redis 实例可以设置不同的密码")])]),s._v(" "),a("p",[s._v("分片实例之间使用 "),a("code",[s._v(",")]),s._v(" 分隔")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("model"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sharding\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("node"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1234")]),s._v("@"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6382")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5678")]),s._v("@"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6382")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("demo:")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v(" redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("password@ip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("database 没有密码则使用 redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),s._v("ip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("database\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("model"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sharding\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("node"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1234")]),s._v("@"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6382")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("s4jRcLhAcUdKrNmqv9XQxwbEUZ6p4sK3kTFE4k9ts3PLahnswEzE4aPgXEQ6QdMa@"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h5",{attrs:{id:"sharding-sentinel"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sharding-sentinel","aria-hidden":"true"}},[s._v("#")]),s._v(" sharding-sentinel")]),s._v(" "),a("p",[s._v("分片哨兵模式是对分片模式高可用的一种实现方式, 可以实现分片模式下, 故障主从自动切换")]),s._v(" "),a("p",[s._v("分片哨兵模式是哨兵模式和分片模式的结合, 配置可")]),s._v(" "),a("p",[s._v("demo:")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("model"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("sharding"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("sentinel\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("node"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mymaster"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26380")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26381")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("mymaster1"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26380")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26381")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h5",{attrs:{id:"cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cluster","aria-hidden":"true"}},[s._v("#")]),s._v(" cluster")]),s._v(" "),a("p",[s._v("redis 3.x 远程集群模式")]),s._v(" "),a("p",[s._v("demo:")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("model"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("cluster\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("node"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6380")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6381")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h5",{attrs:{id:"hybrid"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#hybrid","aria-hidden":"true"}},[s._v("#")]),s._v(" hybrid")]),s._v(" "),a("p",[s._v("混合模式, 为了兼容现有 Redis 环境, 一种临时的解决方案, 改造完成后, 将配置修改为 "),a("code",[s._v("sentinel")]),s._v(" 即可")]),s._v(" "),a("p",[s._v("demo:")]),s._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[s._v("redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("model"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("hybrid\nredis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("node"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("callout"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v("standalone"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1234")]),s._v("@"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6382")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("mymaster"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v("sentinel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("s4jRcLhAcUdKrNmqv9XQxwbEUZ6p4sK3kTFE4k9ts3PLahnswEzE4aPgXEQ6QdMa@"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26379")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sentinel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26380")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sentinel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26381")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("混合模式实现了 "),a("code",[s._v("standalone")]),s._v(", "),a("code",[s._v("sentinel")]),s._v(", "),a("code",[s._v("sharding")]),s._v(" 模式的混合使用")]),s._v(" "),a("h3",{attrs:{id:"代码重构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#代码重构","aria-hidden":"true"}},[s._v("#")]),s._v(" 代码重构")]),s._v(" "),a("ol",[a("li",[s._v("使用 "),a("code",[s._v("@Value")]),s._v(" 实现自动配置, 代替 xml 中的 bean 标签;")]),s._v(" "),a("li",[s._v("使用 logbok 简化代码;")]),s._v(" "),a("li",[s._v("不在使用 RedisServiceFacotry 获取 redisService, 某个模块需要使用该组件时, import xml 即可 (多容器问题);")]),s._v(" "),a("li",[s._v("使用 log4j2 代替 log4j;")]),s._v(" "),a("li",[s._v("编译版本由 jdk1.6 改为 jdk1.7;")]),s._v(" "),a("li",[s._v("使用代理类重构安全关闭 jedis 连接的方式;")])]),s._v(" "),a("p",[s._v("重构前:")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" flag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RedisCallBack")]),a("span",{pre:!0,attrs:{class:"token generics"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("doCallback")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Jedis")]),s._v(" jedis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" jedis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("callback")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getJedisPoolByFlag")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("flag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("重构后:")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" flag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RedisUtil")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("jedisProxy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("model"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" flag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])])])},[],!1,null,null,null);t.default=e.exports}}]);
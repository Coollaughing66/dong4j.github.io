(window.webpackJsonp=window.webpackJsonp||[]).push([[69],{325:function(s,t,e){"use strict";e.r(t);var n=e(0),a=Object(n.a)({},function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("div",{staticClass:"tip custom-block"},[e("p",[s._v("记录 Redis Sentinel 的搭建过程")])]),s._v(" "),e("h2",{attrs:{id:"现有架构的问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#现有架构的问题","aria-hidden":"true"}},[s._v("#")]),s._v(" 现有架构的问题")]),s._v(" "),e("ol",[e("li",[s._v("master 挂掉之后, 需要手动切换, 运维复杂")])]),s._v(" "),e("h2",{attrs:{id:"redis-sentinel-高可用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#redis-sentinel-高可用","aria-hidden":"true"}},[s._v("#")]),s._v(" Redis Sentinel 高可用")]),s._v(" "),e("p",[e("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-1F89EC1A-910B-4F58-B1BA-8B4ED8F1B1A8.png",alt:"1F89EC1A-910B-4F58-B1BA-8B4ED8F1B1A8"}})]),s._v(" "),e("p",[s._v("下面以1个主节点、2个从节点、3个Sentinel节点组成的Redis Sentinel为例子")]),s._v(" "),e("p",[s._v("故障转移处理逻辑:")]),s._v(" "),e("ol",[e("li",[e("p",[s._v("主节点出现故障, 此时两个从节点与主节点时区连接, 主从复制失败;")]),s._v(" "),e("p",[e("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-85406409-6B92-4CE0-A282-6E67A5DBA68D.png",alt:"85406409-6B92-4CE0-A282-6E67A5DBA68D"}})])]),s._v(" "),e("li",[e("p",[s._v("每个 Sentinel 节点通过定期监控发现主节点出现故障;")]),s._v(" "),e("p",[e("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-00FDFC3B-4DD0-4324-812B-B7FC4ED1D211.png",alt:"00FDFC3B-4DD0-4324-812B-B7FC4ED1D211"}})])]),s._v(" "),e("li",[e("p",[s._v("多个 Sentinel 节点对主节点的故障达成一致, 选举出 sentinel-3 节点作为领导者负责故障转移;")]),s._v(" "),e("p",[e("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-212E5E3C-AB42-41B9-8DAF-61BFB3EDFC6B.png",alt:"212E5E3C-AB42-41B9-8DAF-61BFB3EDFC6B"}})]),s._v(" "),e("ol",[e("li",[s._v("原来的从节点 slave-1 称为新的主节点后, 更新应用方的主节点信息, 重新启动应用方;")]),s._v(" "),e("li",[s._v("客户端命令另一个从节点 slave-2 去复制性的主节点;")]),s._v(" "),e("li",[s._v("待原来的主节点恢复后, 让它去复制新的主节点;")])]),s._v(" "),e("p",[e("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-0151B897-8FC5-4700-8DD7-E596BAFAF002.png",alt:"0151B897-8FC5-4700-8DD7-E596BAFAF002"}})])]),s._v(" "),e("li",[e("p",[s._v("故障转移后的结构图")]),s._v(" "),e("p",[e("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-19036242-6602-47DF-85DA-042602A80A11.png",alt:"19036242-6602-47DF-85DA-042602A80A11"}})]),s._v(" "),e("h2",{attrs:{id:"redis-sentinel-功能"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#redis-sentinel-功能","aria-hidden":"true"}},[s._v("#")]),s._v(" Redis Sentinel 功能")]),s._v(" "),e("ol",[e("li",[e("strong",[s._v("监控:")]),s._v(" Sentinel 节点会定期检测 Redis 数据节点和其余 Sentinel 节点是否可达;")]),s._v(" "),e("li",[e("strong",[s._v("通知:")]),s._v(" Sentinel 节点会将故障转移的结果通知给应用方;")]),s._v(" "),e("li",[e("strong",[s._v("主节点故障转移:")]),s._v(" 实现从节点晋升为主节点并维护后续正确的主从关系;")]),s._v(" "),e("li",[e("strong",[s._v("配置提供者:")]),s._v(" 客户端在初始化时, 连接 Sentinel 节点集群, 从中获取主节点信息;")])])])]),s._v(" "),e("h2",{attrs:{id:"redis-sentinel-安装与部署"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#redis-sentinel-安装与部署","aria-hidden":"true"}},[s._v("#")]),s._v(" Redis Sentinel 安装与部署")]),s._v(" "),e("p",[s._v("下面将以3个Sentinel节点、1个主节点、2个从节点组成一个Redis Sentinel进行说明")]),s._v(" "),e("p",[e("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-109FCB47-B219-49C7-B36E-6E234765C931.png",alt:"109FCB47-B219-49C7-B36E-6E234765"}})]),s._v(" "),e("p",[s._v("具体的物理部署:")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"left"}},[s._v("角色")]),s._v(" "),e("th",{staticStyle:{"text-align":"left"}},[s._v("ip")]),s._v(" "),e("th",{staticStyle:{"text-align":"left"}},[s._v("port")]),s._v(" "),e("th",{staticStyle:{"text-align":"left"}},[s._v("别名")])])]),s._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"left"}},[s._v("master")]),s._v(" "),e("td",{staticStyle:{"text-align":"left"}},[s._v("127.0.0.1")]),s._v(" "),e("td",{staticStyle:{"text-align":"left"}},[s._v("6379")]),s._v(" "),e("td",{staticStyle:{"text-align":"left"}},[s._v("主节点")])]),s._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[s._v("slave-1")]),s._v(" "),e("td",{staticStyle:{"text-align":"left"}},[s._v("127.0.0.1")]),s._v(" "),e("td",{staticStyle:{"text-align":"left"}},[s._v("6380")]),s._v(" "),e("td",{staticStyle:{"text-align":"left"}},[s._v("slave-1")])]),s._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[s._v("slave-2")]),s._v(" "),e("td",{staticStyle:{"text-align":"left"}},[s._v("127.0.0.1")]),s._v(" "),e("td",{staticStyle:{"text-align":"left"}},[s._v("6381")]),s._v(" "),e("td",{staticStyle:{"text-align":"left"}},[s._v("slave-2")])]),s._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[s._v("sentinel-1")]),s._v(" "),e("td",{staticStyle:{"text-align":"left"}},[s._v("127.0.0.1")]),s._v(" "),e("td",{staticStyle:{"text-align":"left"}},[s._v("26379")]),s._v(" "),e("td",{staticStyle:{"text-align":"left"}},[s._v("sentinel-1")])]),s._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[s._v("sentinel-2")]),s._v(" "),e("td",{staticStyle:{"text-align":"left"}},[s._v("127.0.0.1")]),s._v(" "),e("td",{staticStyle:{"text-align":"left"}},[s._v("26380")]),s._v(" "),e("td",{staticStyle:{"text-align":"left"}},[s._v("sentinel-2")])]),s._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[s._v("sentinel-3")]),s._v(" "),e("td",{staticStyle:{"text-align":"left"}},[s._v("127.0.0.1")]),s._v(" "),e("td",{staticStyle:{"text-align":"left"}},[s._v("26381")]),s._v(" "),e("td",{staticStyle:{"text-align":"left"}},[s._v("sentinel-3")])])])]),s._v(" "),e("p",[e("strong",[s._v("1. master 配置")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('daemonize yes\ndbfilename "6379.db"\ndir "/Users/codeai/Develop/logs/redis/db/"\nlogfile "/Users/codeai/Develop/logs/redis/log/6379.log"\nport 6379\nrequirepass 1234\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[e("strong",[s._v("2. slave-1 配置")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('daemonize yes\ndbfilename "6380.db"\ndir "/Users/codeai/Develop/logs/redis/db/"\nlogfile "/Users/codeai/Develop/logs/redis/log/6380.log"\nport 6380\nslaveof 127.0.0.1 6379\n# 设置 master 验证密码\nmasterauth 1234\n# 设置 slave 密码\nrequirepass 1234\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[e("strong",[s._v("3. slave-2 配置")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('daemonize yes\ndbfilename "6381.db"\ndir "/Users/codeai/Develop/logs/redis/db/"\nlogfile "/Users/codeai/Develop/logs/redis/log/6381.log"\nport 6381\nslaveof 127.0.0.1 6379\n# 设置 master 验证密码\nmasterauth 1234\n# 设置 slave 密码\nrequirepass 1234\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[e("strong",[s._v("4. 启动 redis 服务")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("redis-server redis-6379.conf; redis-server redis-6380.conf; redis-server redis-6381.conf\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-A62CC675-0FA4-4A6A-B432-5CAD116B95C5.png",alt:"A62CC675-0FA4-4A6A-B432-5CAD116B95"}})]),s._v(" "),e("p",[e("strong",[s._v("5. 确认主从关系")])]),s._v(" "),e("p",[s._v("主节点视角")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("redis-cli -h 127.0.0.1 -p 6379 info replication\n# Replication\n# 主节点\nrole:master\n# 有 2 个 从节点\nconnected_slaves:2\n# 从节点 1 信息\nslave0:ip=127.0.0.1,port=6380,state=online,offset=112,lag=0\n# 从节点 2 信息\nslave1:ip=127.0.0.1,port=6381,state=online,offset=112,lag=0\nmaster_replid:8f43dc48cca779f46fa1516a38e24fb8c5423d94\nmaster_replid2:0000000000000000000000000000000000000000\nmaster_repl_offset:112\nsecond_repl_offset:-1\nrepl_backlog_active:1\nrepl_backlog_size:1048576\nrepl_backlog_first_byte_offset:1\nrepl_backlog_histlen:112\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("p",[s._v("从节点视角")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("redis-cli -h 127.0.0.1 -p 6380 info replication\n# Replication\n# 从节点\nrole:slave\n# 主节点信息\nmaster_host:127.0.0.1\nmaster_port:6379\nmaster_link_status:up\nmaster_last_io_seconds_ago:2\nmaster_sync_in_progress:0\nslave_repl_offset:238\nslave_priority:100\nslave_read_only:1\nconnected_slaves:0\nmaster_replid:8f43dc48cca779f46fa1516a38e24fb8c5423d94\nmaster_replid2:0000000000000000000000000000000000000000\nmaster_repl_offset:238\nsecond_repl_offset:-1\nrepl_backlog_active:1\nrepl_backlog_size:1048576\nrepl_backlog_first_byte_offset:1\nrepl_backlog_histlen:238\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br")])]),e("p",[e("strong",[s._v("6. 部署 Sentinel 节点")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('port 26379\ndaemonize yes\nlogfile "/Users/codeai/Develop/logs/redis/log/26379.log"\ndir "/Users/codeai/Develop/logs/redis/db/"\n# 监控 127.0.0.1:6379 主节点; 2 表示判断主节点失败至少需要 2 个 sentinel 节点同意\nsentinel monitor mymaster 127.0.0.1 6379 2\n# 设置监听的 master 密码\nsentinel auth-pass mymaster 1234\n# 30 秒内 ping 失败, sentinel 则认为 master 不可用\nsentinel down-after-milliseconds mymaster 30000\n# 在发生failover主备切换时, 这个选项指定了最多可以有多少个slave同时对新的master进行同步\nsentinel parallel-syncs mymaster 1\n# 如果在该时间（ms）内未能完成failover操作, 则认为该failover失败\nsentinel failover-timeout mymaster 180000\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br")])]),e("p",[s._v("其他节点只是端口不同")]),s._v(" "),e("p",[e("strong",[s._v("7. 启动 sentinel 节点")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# 方式一\nredis-sentinel redis-sentinel-26379.conf; redis-sentinel redis-sentinel-26380.conf; redis-sentinel redis-sentinel-26381.conf\n# 方式二\nredis-server redis-sentinel-26379.conf --sentinel; redis-server redis-sentinel-26380.conf --sentinel; redis-server redis-sentinel-26381.conf --sentinel; \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[e("img",{attrs:{src:"http://qiniu.dong4j.info/2019-07-03-4B44AF64-E724-4A23-A09A-297489A6F834.png",alt:"4B44AF64-E724-4A23-A09A-297489A6F834"}})]),s._v(" "),e("p",[e("strong",[s._v("8. 确认关系")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("redis-cli -h 127.0.0.1 -p 26379 info sentinel\n# Sentinel\nsentinel_masters:1\nsentinel_tilt:0\nsentinel_running_scripts:0\nsentinel_scripts_queue_length:0\nsentinel_simulate_failure_flags:0\nmaster0:name=mymaster,status=ok,address=127.0.0.1:6379,slaves=2,sentinels=3\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("h2",{attrs:{id:"通过-jedis-操作-redis"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#通过-jedis-操作-redis","aria-hidden":"true"}},[s._v("#")]),s._v(" 通过 Jedis 操作 Redis")]),s._v(" "),e("p",[e("a",{attrs:{href:"https://github.com/dong4j/redis-toolkit",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/dong4j/redis-toolkit"),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("包含 redis 配置文件, 搭建方式与单元测试")]),s._v(" "),e("h3",{attrs:{id:"jedis-操作-redis-的-三种方式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#jedis-操作-redis-的-三种方式","aria-hidden":"true"}},[s._v("#")]),s._v(" Jedis 操作 Redis 的 三种方式")]),s._v(" "),e("h4",{attrs:{id:"单机模式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#单机模式","aria-hidden":"true"}},[s._v("#")]),s._v(" 单机模式")]),s._v(" "),e("p",[s._v("直接通过 JedisPool 操作 Redis")]),s._v(" "),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Jedis")]),s._v(" jedis "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 从连接池获取一个Jedis实例")]),s._v("\n    jedis "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" jedisPool"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("getResource")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    jedis"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" value"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    log"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("jedis"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" e"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    log"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("error")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"set error"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" e"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("finally")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" jedis"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 释放资源还给连接池")]),s._v("\n        jedis"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("close")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br")])]),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Jedis")]),s._v(" jedis "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" jedisPool"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("getResource")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    jedis"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" value"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    log"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("jedis"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" e"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    log"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("error")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"set error"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" e"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("h4",{attrs:{id:"分片模式（shardedjedis）"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#分片模式（shardedjedis）","aria-hidden":"true"}},[s._v("#")]),s._v(" 分片模式（ShardedJedis）")]),s._v(" "),e("p",[s._v("使用一致性哈希算法, 将 key 存储在对应实例中")]),s._v(" "),e("div",{staticClass:"language-java line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ShardedJedis")]),s._v(" jedis "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" shardedJedisPool"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("getResource")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    jedis"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" value"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    log"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("jedis"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("key"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" e"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    log"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("error")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"set error"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" e"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("h4",{attrs:{id:"集群模式（binaryjediscluster）"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#集群模式（binaryjediscluster）","aria-hidden":"true"}},[s._v("#")]),s._v(" 集群模式（BinaryJedisCluster）")]),s._v(" "),e("p",[s._v("需要 Redis 3.0 以上才自带集群功能")]),s._v(" "),e("h3",{attrs:{id:"集成-jedis-的两种方式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#集成-jedis-的两种方式","aria-hidden":"true"}},[s._v("#")]),s._v(" 集成 Jedis 的两种方式")]),s._v(" "),e("ol",[e("li",[s._v("使用 spring-data-redis 集成 redis, 使用 RedisTemplate 或者 JedisConnectionFactory 获取 jedis 操作 Redis")]),s._v(" "),e("li",[s._v("直接使用 JedisPool , ShardedJedisPool, ShardedJedisPool, ShardedJedisSentinelPool  获取 jedis 操作 Redis")])]),s._v(" "),e("h4",{attrs:{id:"spring-data-redis"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#spring-data-redis","aria-hidden":"true"}},[s._v("#")]),s._v(" spring-data-redis")]),s._v(" "),e("h4",{attrs:{id:"原生-jedis"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#原生-jedis","aria-hidden":"true"}},[s._v("#")]),s._v(" 原生 jedis")]),s._v(" "),e("h5",{attrs:{id:"jedispool"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#jedispool","aria-hidden":"true"}},[s._v("#")]),s._v(" JedisPool")]),s._v(" "),e("h5",{attrs:{id:"shardedjedispool"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#shardedjedispool","aria-hidden":"true"}},[s._v("#")]),s._v(" ShardedJedisPool")]),s._v(" "),e("h4",{attrs:{id:"高可用的-redis"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#高可用的-redis","aria-hidden":"true"}},[s._v("#")]),s._v(" 高可用的 Redis")]),s._v(" "),e("h5",{attrs:{id:"jedissentinelpool"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#jedissentinelpool","aria-hidden":"true"}},[s._v("#")]),s._v(" JedisSentinelPool")]),s._v(" "),e("h5",{attrs:{id:"shardedjedissentinelpool"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#shardedjedissentinelpool","aria-hidden":"true"}},[s._v("#")]),s._v(" ShardedJedisSentinelPool")]),s._v(" "),e("p",[s._v("代码详见: "),e("a",{attrs:{href:"https://github.com/dong4j/redis-toolkit",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/dong4j/redis-toolkit"),e("OutboundLink")],1)]),s._v(" "),e("h3",{attrs:{id:"问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题","aria-hidden":"true"}},[s._v("#")]),s._v(" 问题")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(" All sentinels down, cannot determine where is mymaster master is running...\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("sentinel 安全模式默认是打开的, 又因为没有绑定可以访问的ip和设置访问密码, 就不允许从外部访问;\nredis内部把127的地址转换成了192.168.2.101了, 也就是你的本机的ip地址. 所以访问192的地址就相当于从外部访问哨兵;")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("Cannot get master address from sentinel running @ 192.168.2.101:26379. \nReason: redis.clients.jedis.exceptions.JedisDataException: DENIED Redis is running in protected mode because protected mode is enabled, no bind address was specified, no authentication password is requested to clients. In this mode connections are only accepted from the loopback interface. If you want to connect from external computers to Redis you may adopt one of the following solutions: \n1) Just disable protected mode sending the command 'CONFIG SET protected-mode no' from the loopback interface by connecting to Redis from the same host the server is running, however MAKE SURE Redis is not publicly accessible from internet if you do so. Use CONFIG REWRITE to make this change permanent. \n2) Alternatively you can just disable the protected mode by editing the Redis configuration file, and setting the protected mode option to 'no', and then restarting the server. \n3) If you started the server manually just for testing, restart it with the '--protected-mode no' option. \n4) Setup a bind address or an authentication password. NOTE: You only need to do one of the above things in order for the server to start accepting connections from the outside.. Trying next one\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])])])},[],!1,null,null,null);t.default=a.exports}}]);
<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis 架构重构 | Black House</title>
    <meta name="description" content="代码千万行, 注释第一行, 编码不规范, 同事两行泪.">
    <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.35477964.css" as="style"><link rel="preload" href="/assets/js/app.23d4d300.js" as="script"><link rel="preload" href="/assets/js/4.28fd9624.js" as="script"><link rel="preload" href="/assets/js/1.928d15b1.js" as="script"><link rel="preload" href="/assets/js/70.2308210c.js" as="script"><link rel="prefetch" href="/assets/js/10.c2349238.js"><link rel="prefetch" href="/assets/js/100.031b764c.js"><link rel="prefetch" href="/assets/js/11.597103f4.js"><link rel="prefetch" href="/assets/js/12.01e326a5.js"><link rel="prefetch" href="/assets/js/13.6937eabc.js"><link rel="prefetch" href="/assets/js/14.0e95ab13.js"><link rel="prefetch" href="/assets/js/15.43c0e778.js"><link rel="prefetch" href="/assets/js/16.8c75ae64.js"><link rel="prefetch" href="/assets/js/17.02d12878.js"><link rel="prefetch" href="/assets/js/18.6b597676.js"><link rel="prefetch" href="/assets/js/19.524d893b.js"><link rel="prefetch" href="/assets/js/20.11686f52.js"><link rel="prefetch" href="/assets/js/21.ad025f0d.js"><link rel="prefetch" href="/assets/js/22.dca96777.js"><link rel="prefetch" href="/assets/js/23.121a28ab.js"><link rel="prefetch" href="/assets/js/24.99537c05.js"><link rel="prefetch" href="/assets/js/25.8f31fa14.js"><link rel="prefetch" href="/assets/js/26.a121c6cc.js"><link rel="prefetch" href="/assets/js/27.a57ec579.js"><link rel="prefetch" href="/assets/js/28.3f009b45.js"><link rel="prefetch" href="/assets/js/29.9c269e5b.js"><link rel="prefetch" href="/assets/js/30.168f09f3.js"><link rel="prefetch" href="/assets/js/31.ed454542.js"><link rel="prefetch" href="/assets/js/32.5f77ac76.js"><link rel="prefetch" href="/assets/js/33.3b921274.js"><link rel="prefetch" href="/assets/js/34.2e2dd8bc.js"><link rel="prefetch" href="/assets/js/35.457382a4.js"><link rel="prefetch" href="/assets/js/36.097474f8.js"><link rel="prefetch" href="/assets/js/37.2914dab3.js"><link rel="prefetch" href="/assets/js/38.bd900eff.js"><link rel="prefetch" href="/assets/js/39.00b0bb76.js"><link rel="prefetch" href="/assets/js/40.6d5aae82.js"><link rel="prefetch" href="/assets/js/41.e00929aa.js"><link rel="prefetch" href="/assets/js/42.b0c12805.js"><link rel="prefetch" href="/assets/js/43.7a60ce77.js"><link rel="prefetch" href="/assets/js/44.adf74ab9.js"><link rel="prefetch" href="/assets/js/45.36b6b8e2.js"><link rel="prefetch" href="/assets/js/46.a254f56a.js"><link rel="prefetch" href="/assets/js/47.aec9ad68.js"><link rel="prefetch" href="/assets/js/48.e3477ba7.js"><link rel="prefetch" href="/assets/js/49.5d974cde.js"><link rel="prefetch" href="/assets/js/5.c7e63593.js"><link rel="prefetch" href="/assets/js/50.c71471a2.js"><link rel="prefetch" href="/assets/js/51.de15920e.js"><link rel="prefetch" href="/assets/js/52.1eabf9c1.js"><link rel="prefetch" href="/assets/js/53.ada4082c.js"><link rel="prefetch" href="/assets/js/54.985c146e.js"><link rel="prefetch" href="/assets/js/55.33da5078.js"><link rel="prefetch" href="/assets/js/56.8b899006.js"><link rel="prefetch" href="/assets/js/57.f7ea6441.js"><link rel="prefetch" href="/assets/js/58.55ca22b7.js"><link rel="prefetch" href="/assets/js/59.3b16a882.js"><link rel="prefetch" href="/assets/js/6.8843ac12.js"><link rel="prefetch" href="/assets/js/60.7365ec6c.js"><link rel="prefetch" href="/assets/js/61.0508510a.js"><link rel="prefetch" href="/assets/js/62.8c3a0bf0.js"><link rel="prefetch" href="/assets/js/63.99503945.js"><link rel="prefetch" href="/assets/js/64.1193b17d.js"><link rel="prefetch" href="/assets/js/65.40a7b476.js"><link rel="prefetch" href="/assets/js/66.c95c74fb.js"><link rel="prefetch" href="/assets/js/67.dcc1ce00.js"><link rel="prefetch" href="/assets/js/68.e8aeba6d.js"><link rel="prefetch" href="/assets/js/69.13b69234.js"><link rel="prefetch" href="/assets/js/7.cda98f34.js"><link rel="prefetch" href="/assets/js/71.bdac7c88.js"><link rel="prefetch" href="/assets/js/72.d5e7dabc.js"><link rel="prefetch" href="/assets/js/73.f1cec72d.js"><link rel="prefetch" href="/assets/js/74.13cbda62.js"><link rel="prefetch" href="/assets/js/75.5ec77696.js"><link rel="prefetch" href="/assets/js/76.e80c98fb.js"><link rel="prefetch" href="/assets/js/77.edf10bf3.js"><link rel="prefetch" href="/assets/js/78.9472aec2.js"><link rel="prefetch" href="/assets/js/79.2f59f6d2.js"><link rel="prefetch" href="/assets/js/8.64e66a3d.js"><link rel="prefetch" href="/assets/js/80.9d9b311d.js"><link rel="prefetch" href="/assets/js/81.112c831f.js"><link rel="prefetch" href="/assets/js/82.e98222ae.js"><link rel="prefetch" href="/assets/js/83.a7741563.js"><link rel="prefetch" href="/assets/js/84.47f9ec86.js"><link rel="prefetch" href="/assets/js/85.4b288089.js"><link rel="prefetch" href="/assets/js/86.d01d1b2a.js"><link rel="prefetch" href="/assets/js/87.26f71539.js"><link rel="prefetch" href="/assets/js/88.0cdca4ad.js"><link rel="prefetch" href="/assets/js/89.fca9f86b.js"><link rel="prefetch" href="/assets/js/9.8fcc4a9b.js"><link rel="prefetch" href="/assets/js/90.49e1e9ad.js"><link rel="prefetch" href="/assets/js/91.58ec2d07.js"><link rel="prefetch" href="/assets/js/92.0da2a72c.js"><link rel="prefetch" href="/assets/js/93.9d312aaf.js"><link rel="prefetch" href="/assets/js/94.e94db684.js"><link rel="prefetch" href="/assets/js/95.ed2aa34a.js"><link rel="prefetch" href="/assets/js/96.6a2e264d.js"><link rel="prefetch" href="/assets/js/97.8a055f18.js"><link rel="prefetch" href="/assets/js/98.1284385e.js"><link rel="prefetch" href="/assets/js/99.830ddc7a.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.3ceaf8af.js">
    <link rel="stylesheet" href="/assets/css/0.styles.35477964.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container"><div><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/head.png" alt="Black House" class="logo"> <span class="site-name">Black House</span></a> <div class="links"><div class="color-picker"><a href="#" class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><!----> <div class="dark-theme-options toggle-option"><label for="dark-theme-toggle">Enable Dark Theme?</label> <input id="dark-theme-toggle" type="checkbox" checked="checked"></div></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/Design.html" class="nav-link"><i class="iconfont undefined"></i>
  Design
</a></li><li class="dropdown-item"><!----> <a href="/category/Framework.html" class="nav-link"><i class="iconfont undefined"></i>
  Framework
</a></li><li class="dropdown-item"><!----> <a href="/category/Spring.html" class="nav-link"><i class="iconfont undefined"></i>
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/category/Issue.html" class="nav-link"><i class="iconfont undefined"></i>
  Issue
</a></li><li class="dropdown-item"><!----> <a href="/category/Java.html" class="nav-link"><i class="iconfont undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/category/Mac.html" class="nav-link"><i class="iconfont undefined"></i>
  Mac
</a></li><li class="dropdown-item"><!----> <a href="/category/Other.html" class="nav-link"><i class="iconfont undefined"></i>
  Other
</a></li><li class="dropdown-item"><!----> <a href="/category/Middleware.html" class="nav-link"><i class="iconfont undefined"></i>
  Middleware
</a></li><li class="dropdown-item"><!----> <a href="/category/NoSQL.html" class="nav-link"><i class="iconfont undefined"></i>
  NoSQL
</a></li><li class="dropdown-item"><!----> <a href="/category/Python.html" class="nav-link"><i class="iconfont undefined"></i>
  Python
</a></li><li class="dropdown-item"><!----> <a href="/category/Tools.html" class="nav-link"><i class="iconfont undefined"></i>
  Tools
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/dong4j" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/Design.html" class="nav-link"><i class="iconfont undefined"></i>
  Design
</a></li><li class="dropdown-item"><!----> <a href="/category/Framework.html" class="nav-link"><i class="iconfont undefined"></i>
  Framework
</a></li><li class="dropdown-item"><!----> <a href="/category/Spring.html" class="nav-link"><i class="iconfont undefined"></i>
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/category/Issue.html" class="nav-link"><i class="iconfont undefined"></i>
  Issue
</a></li><li class="dropdown-item"><!----> <a href="/category/Java.html" class="nav-link"><i class="iconfont undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/category/Mac.html" class="nav-link"><i class="iconfont undefined"></i>
  Mac
</a></li><li class="dropdown-item"><!----> <a href="/category/Other.html" class="nav-link"><i class="iconfont undefined"></i>
  Other
</a></li><li class="dropdown-item"><!----> <a href="/category/Middleware.html" class="nav-link"><i class="iconfont undefined"></i>
  Middleware
</a></li><li class="dropdown-item"><!----> <a href="/category/NoSQL.html" class="nav-link"><i class="iconfont undefined"></i>
  NoSQL
</a></li><li class="dropdown-item"><!----> <a href="/category/Python.html" class="nav-link"><i class="iconfont undefined"></i>
  Python
</a></li><li class="dropdown-item"><!----> <a href="/category/Tools.html" class="nav-link"><i class="iconfont undefined"></i>
  Tools
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/dong4j" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Redis 架构重构</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/views/nosql/2018/07192103.html#原有架构" class="sidebar-link">原有架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/nosql/2018/07192103.html#存在的问题" class="sidebar-link">存在的问题</a></li></ul></li><li><a href="/views/nosql/2018/07192103.html#redis-sentinel-高可用" class="sidebar-link">Redis Sentinel 高可用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/nosql/2018/07192103.html#redis-sentinel-功能" class="sidebar-link">Redis Sentinel 功能</a></li><li class="sidebar-sub-header"><a href="/views/nosql/2018/07192103.html#几个概念" class="sidebar-link">几个概念</a></li></ul></li><li><a href="/views/nosql/2018/07192103.html#redis-sentinel-安装与部署" class="sidebar-link">Redis Sentinel 安装与部署</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/nosql/2018/07192103.html#部署方案" class="sidebar-link">部署方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/nosql/2018/07192103.html#一套-sentinel-监控所有主节点" class="sidebar-link">一套 Sentinel 监控所有主节点</a></li><li class="sidebar-sub-header"><a href="/views/nosql/2018/07192103.html#每个主节点各一套-sentinel" class="sidebar-link">每个主节点各一套 Sentinel</a></li></ul></li><li><a href="/views/nosql/2018/07192103.html#redis-连接数太多导致" class="sidebar-link">Redis 连接数太多导致</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/nosql/2018/07192103.html#原因分析" class="sidebar-link">原因分析</a></li><li class="sidebar-sub-header"><a href="/views/nosql/2018/07192103.html#解决方案" class="sidebar-link">解决方案</a></li></ul></li><li><a href="/views/nosql/2018/07192103.html#重构方案" class="sidebar-link">重构方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/nosql/2018/07192103.html#架构" class="sidebar-link">架构</a></li><li class="sidebar-sub-header"><a href="/views/nosql/2018/07192103.html#component-redis-介绍" class="sidebar-link">component-redis 介绍</a></li><li class="sidebar-sub-header"><a href="/views/nosql/2018/07192103.html#component-redis-配置规范" class="sidebar-link">component-redis 配置规范</a></li><li class="sidebar-sub-header"><a href="/views/nosql/2018/07192103.html#代码重构" class="sidebar-link">代码重构</a></li></ul></li></ul></section></li></ul> </aside> <div><main class="page reco-hide"> <div class="page-title"><h1>Redis 架构重构</h1> <hr> <div data-v-0b496ca7><i class="iconfont reco-account" data-v-0b496ca7><span data-v-0b496ca7>dong4j</span></i> <i class="iconfont reco-date" data-v-0b496ca7><span data-v-0b496ca7>7/19/2018</span></i> <!----> <i class="iconfont reco-tag tags" data-v-0b496ca7><span class="tag-item" data-v-0b496ca7>
      Redis
    </span></i></div></div> <div class="content__default"><div class="tip custom-block"><p>使用 Redis Sentinel 重构现有架构</p></div> <h1 id="redis-proxy-重构"><a href="#redis-proxy-重构" aria-hidden="true" class="header-anchor">#</a> redis-proxy 重构</h1> <hr> <p>[toc]</p> <blockquote><p>对于搭建高可用 Redis 服务, 网上已有了很多方案, 例如 Keepalived, Codis, Twemproxy, Redis Sentinel.
其中 Codis 和 Twemproxy 主要是用于大规模的 Redis 集群中, 也是在 Redis 官方发布 Redis Sentinel 之前 豌豆荚 和 twitter 提供的开源解决方案.
Redis Sentinel可以理解为一个监控 Redis Server 服务是否正常的进程, 并且一旦检测到不正常, 可以自动地将备份(slave)Redis Server启用, 使得外部用户对Redis服务内部出现的异常无感知.</p></blockquote> <h2 id="原有架构"><a href="#原有架构" aria-hidden="true" class="header-anchor">#</a> 原有架构</h2> <p><img src="http://qiniu.dong4j.info/2019-07-03-3915800D-B858-4AB4-BABD-23CCC8E72DFB.png" alt="3915800D-B858-4AB4-BABD-23CCC8E72DFB"></p> <h3 id="存在的问题"><a href="#存在的问题" aria-hidden="true" class="header-anchor">#</a> 存在的问题</h3> <ol><li>配置部署复杂</li> <li>不稳定</li></ol> <h2 id="redis-sentinel-高可用"><a href="#redis-sentinel-高可用" aria-hidden="true" class="header-anchor">#</a> Redis Sentinel 高可用</h2> <p><img src="http://qiniu.dong4j.info/2019-07-03-1F89EC1A-910B-4F58-B1BA-8B4ED8F1B1A8.png" alt="1F89EC1A-910B-4F58-B1BA-8B4ED8F1B1A8"></p> <p>下面以1个主节点、2个从节点、3个Sentinel节点组成的Redis Sentinel为例子</p> <p><strong>故障转移处理逻辑:</strong></p> <ol><li><p>主节点出现故障, 此时两个从节点与主节点时区连接, 主从复制失败;</p> <p><img src="http://qiniu.dong4j.info/2019-07-03-85406409-6B92-4CE0-A282-6E67A5DBA68D.png" alt="85406409-6B92-4CE0-A282-6E67A5DBA68D"></p></li> <li><p>每个 Sentinel 节点通过定期监控发现主节点出现故障;</p> <p><img src="http://qiniu.dong4j.info/2019-07-03-00FDFC3B-4DD0-4324-812B-B7FC4ED1D211.png" alt="00FDFC3B-4DD0-4324-812B-B7FC4ED1D211"></p></li> <li><p>多个 Sentinel 节点对主节点的故障达成一致, 选举出 sentinel-3 节点作为领导者负责故障转移;</p> <p><img src="http://qiniu.dong4j.info/2019-07-03-212E5E3C-AB42-41B9-8DAF-61BFB3EDFC6B.png" alt="212E5E3C-AB42-41B9-8DAF-61BFB3EDFC6B"></p> <ol><li>原来的从节点 slave-1 成为新的主节点后, 更新应用方的主节点信息;</li> <li>客户端命令另一个从节点 slave-2 去复制新的主节点;</li> <li>待原来的主节点恢复后, 让它去复制新的主节点;</li></ol> <p><img src="http://qiniu.dong4j.info/2019-07-03-0151B897-8FC5-4700-8DD7-E596BAFAF002.png" alt="0151B897-8FC5-4700-8DD7-E596BAFAF002"></p></li> <li><p>故障转移后的结构图</p> <p><img src="http://qiniu.dong4j.info/2019-07-03-19036242-6602-47DF-85DA-042602A80A11.png" alt="19036242-6602-47DF-85DA-042602A80A11"></p></li></ol> <h3 id="redis-sentinel-功能"><a href="#redis-sentinel-功能" aria-hidden="true" class="header-anchor">#</a> Redis Sentinel 功能</h3> <ol><li><strong>监控:</strong> Sentinel 节点会定期检测 Redis 数据节点和其余 Sentinel 节点是否可达;</li> <li><strong>通知:</strong> Sentinel 节点会将故障转移的结果通知给应用方;</li> <li><strong>主节点故障转移:</strong> 实现从节点晋升为主节点并维护后续正确的主从关系;</li> <li><strong>配置提供者:</strong> 客户端在初始化时, 连接 Sentinel 节点集群, 从中获取主节点信息;</li></ol> <p>采用多个 Sentinel 节点的优点:</p> <ol><li>对于节点故障判断由多个 Sentinel 节点共同完成, 有效防止误判;</li> <li>避免单点故障;</li></ol> <h3 id="几个概念"><a href="#几个概念" aria-hidden="true" class="header-anchor">#</a> 几个概念</h3> <h4 id="三个定时监控任务"><a href="#三个定时监控任务" aria-hidden="true" class="header-anchor">#</a> 三个定时监控任务</h4> <ol><li><p>每隔 10 秒. 每个 Sentinel 节点会向主节点和从节点发送 info 命令获取最新的拓扑结构;
<img src="http://qiniu.dong4j.info/2019-07-03-915859E8-EA7B-4A1E-BBC0-A7D1FA91C6CC.png" alt="-w400"></p></li> <li><p>每隔 2 秒, 每个 Sentinel 节点向 <em>sentinel</em>:hello 频道上发送该 Sentinel 节点对于主节点的判断一级当前 Sentinel 节点的信息, 同时每个 Sentinel 节点也会订阅该频道;
<img src="http://qiniu.dong4j.info/2019-07-03-F5B2D7CD-4E0C-4F40-BCD0-B827BC26D8F2.png" alt="-w400"></p></li> <li><p>每隔 1 秒, 每个 Sentine 会向主从节点, 其他 Sentinel 节点发送 ping 命令做心跳检测, 来确保节点当前是否可达
<img src="http://qiniu.dong4j.info/2019-07-03-8666FF6B-28E5-4F5F-B44E-0FDADBA8AE5A.png" alt="-w400"></p></li></ol> <h4 id="主观下线（subjectively-down-简称-sdown）"><a href="#主观下线（subjectively-down-简称-sdown）" aria-hidden="true" class="header-anchor">#</a> 主观下线（Subjectively Down,  简称 SDOWN）</h4> <blockquote><p>指的是单个 Sentinel 实例对服务器做出的下线判断.</p></blockquote> <p>每个 Sentinel 节点会每隔1秒对主节 点、从节点、其他 Sentinel 节点发送 ping 命令做心跳检测, 当这些节点超过 down-after-milliseconds 没有进行有效回复, Sentinel 节点就会对该节点做失败 判定, 这个行为叫做主观下线</p> <p><img src="http://qiniu.dong4j.info/2019-07-03-F743A8AB-F913-4949-B6EE-CD35D4C532F9.png" alt="-w400"></p> <h4 id="客观下线（objectively-down-简称-odown）"><a href="#客观下线（objectively-down-简称-odown）" aria-hidden="true" class="header-anchor">#</a> 客观下线（Objectively Down,  简称 ODOWN）</h4> <blockquote><p>指的是多个 Sentinel 实例在对同一个服务器做出 SDOWN 判断,  并且通过 SENTINEL is-master-down-by-addr 命令互相交流之后,  得出的服务器下线判断.  （一个 Sentinel 可以通过向另一个 Sentinel 发送 SENTINEL is-master-down-by-addr 命令来询问对方是否认为给定的服务器已下线. ）</p></blockquote> <h2 id="redis-sentinel-安装与部署"><a href="#redis-sentinel-安装与部署" aria-hidden="true" class="header-anchor">#</a> Redis Sentinel 安装与部署</h2> <p>下面将以3个Sentinel节点、1个主节点、2个从节点组成一个Redis Sentinel进行说明</p> <p><img src="http://qiniu.dong4j.info/2019-07-03-109FCB47-B219-49C7-B36E-6E234765C931.png" alt="109FCB47-B219-49C7-B36E-6E234765"></p> <p>具体的物理部署:</p> <table><thead><tr><th style="text-align:left;">角色</th> <th style="text-align:left;">ip</th> <th style="text-align:left;">port</th> <th style="text-align:left;">别名</th></tr></thead> <tbody><tr><td style="text-align:left;">master</td> <td style="text-align:left;">127.0.0.1</td> <td style="text-align:left;">6379</td> <td style="text-align:left;">主节点</td></tr> <tr><td style="text-align:left;">slave-1</td> <td style="text-align:left;">127.0.0.1</td> <td style="text-align:left;">6380</td> <td style="text-align:left;">slave-1</td></tr> <tr><td style="text-align:left;">slave-2</td> <td style="text-align:left;">127.0.0.1</td> <td style="text-align:left;">6381</td> <td style="text-align:left;">slave-2</td></tr> <tr><td style="text-align:left;">sentinel-1</td> <td style="text-align:left;">127.0.0.1</td> <td style="text-align:left;">26379</td> <td style="text-align:left;">sentinel-1</td></tr> <tr><td style="text-align:left;">sentinel-2</td> <td style="text-align:left;">127.0.0.1</td> <td style="text-align:left;">26380</td> <td style="text-align:left;">sentinel-2</td></tr> <tr><td style="text-align:left;">sentinel-3</td> <td style="text-align:left;">127.0.0.1</td> <td style="text-align:left;">26381</td> <td style="text-align:left;">sentinel-3</td></tr></tbody></table> <p><strong>1. master 配置</strong></p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code>daemonize yes
dbfilename <span class="token string">&quot;6379.db&quot;</span>
dir <span class="token string">&quot;/Users/codeai/Develop/logs/redis/db/&quot;</span>
logfile <span class="token string">&quot;/Users/codeai/Develop/logs/redis/log/6379.log&quot;</span>
port <span class="token number">6379</span>
requirepass <span class="token number">1234</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>2. slave-1 配置</strong></p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code>daemonize yes
dbfilename <span class="token string">&quot;6380.db&quot;</span>
dir <span class="token string">&quot;/Users/codeai/Develop/logs/redis/db/&quot;</span>
logfile <span class="token string">&quot;/Users/codeai/Develop/logs/redis/log/6380.log&quot;</span>
port <span class="token number">6380</span>
slaveof <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token number">6379</span>
<span class="token operator">#</span> 设置 master 验证密码
masterauth <span class="token number">1234</span>
<span class="token operator">#</span> 设置 slave 密码
requirepass <span class="token number">1234</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>3. slave-2 配置</strong></p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code>daemonize yes
dbfilename <span class="token string">&quot;6381.db&quot;</span>
dir <span class="token string">&quot;/Users/codeai/Develop/logs/redis/db/&quot;</span>
logfile <span class="token string">&quot;/Users/codeai/Develop/logs/redis/log/6381.log&quot;</span>
port <span class="token number">6381</span>
slaveof <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token number">6379</span>
<span class="token operator">#</span> 设置 master 验证密码
masterauth <span class="token number">1234</span>
<span class="token operator">#</span> 设置 slave 密码
requirepass <span class="token number">1234</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>4. 启动 redis 服务</strong></p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code>redis<span class="token operator">-</span>server redis<span class="token operator">-</span><span class="token number">6379.</span>conf<span class="token punctuation">;</span> redis<span class="token operator">-</span>server redis<span class="token operator">-</span><span class="token number">6380.</span>conf<span class="token punctuation">;</span> redis<span class="token operator">-</span>server redis<span class="token operator">-</span><span class="token number">6381.</span>conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="http://qiniu.dong4j.info/2019-07-03-A62CC675-0FA4-4A6A-B432-5CAD116B95C5.png" alt="A62CC675-0FA4-4A6A-B432-5CAD116B95"></p> <p><strong>5. 确认主从关系</strong></p> <p>主节点视角</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code>redis<span class="token operator">-</span>cli <span class="token operator">-</span>h <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token operator">-</span>p <span class="token number">6379</span> info replication
<span class="token operator">#</span> Replication
<span class="token operator">#</span> 主节点
role<span class="token punctuation">:</span>master
<span class="token operator">#</span> 有 <span class="token number">2</span> 个 从节点
connected_slaves<span class="token punctuation">:</span><span class="token number">2</span>
<span class="token operator">#</span> 从节点 <span class="token number">1</span> 信息
slave0<span class="token punctuation">:</span>ip<span class="token operator">=</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">,</span>port<span class="token operator">=</span><span class="token number">6380</span><span class="token punctuation">,</span>state<span class="token operator">=</span>online<span class="token punctuation">,</span>offset<span class="token operator">=</span><span class="token number">112</span><span class="token punctuation">,</span>lag<span class="token operator">=</span><span class="token number">0</span>
<span class="token operator">#</span> 从节点 <span class="token number">2</span> 信息
slave1<span class="token punctuation">:</span>ip<span class="token operator">=</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">,</span>port<span class="token operator">=</span><span class="token number">6381</span><span class="token punctuation">,</span>state<span class="token operator">=</span>online<span class="token punctuation">,</span>offset<span class="token operator">=</span><span class="token number">112</span><span class="token punctuation">,</span>lag<span class="token operator">=</span><span class="token number">0</span>
master_replid<span class="token punctuation">:</span>8f43dc48cca779f46fa1516a38e24fb8c5423d94
master_replid2<span class="token punctuation">:</span><span class="token number">0000000000000000000000000000000000000000</span>
master_repl_offset<span class="token punctuation">:</span><span class="token number">112</span>
second_repl_offset<span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span>
repl_backlog_active<span class="token punctuation">:</span><span class="token number">1</span>
repl_backlog_size<span class="token punctuation">:</span><span class="token number">1048576</span>
repl_backlog_first_byte_offset<span class="token punctuation">:</span><span class="token number">1</span>
repl_backlog_histlen<span class="token punctuation">:</span><span class="token number">112</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>从节点视角</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code>redis<span class="token operator">-</span>cli <span class="token operator">-</span>h <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token operator">-</span>p <span class="token number">6380</span> info replication
<span class="token operator">#</span> Replication
<span class="token operator">#</span> 从节点
role<span class="token punctuation">:</span>slave
<span class="token operator">#</span> 主节点信息
master_host<span class="token punctuation">:</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span>
master_port<span class="token punctuation">:</span><span class="token number">6379</span>
master_link_status<span class="token punctuation">:</span>up
master_last_io_seconds_ago<span class="token punctuation">:</span><span class="token number">2</span>
master_sync_in_progress<span class="token punctuation">:</span><span class="token number">0</span>
slave_repl_offset<span class="token punctuation">:</span><span class="token number">238</span>
slave_priority<span class="token punctuation">:</span><span class="token number">100</span>
slave_read_only<span class="token punctuation">:</span><span class="token number">1</span>
connected_slaves<span class="token punctuation">:</span><span class="token number">0</span>
master_replid<span class="token punctuation">:</span>8f43dc48cca779f46fa1516a38e24fb8c5423d94
master_replid2<span class="token punctuation">:</span><span class="token number">0000000000000000000000000000000000000000</span>
master_repl_offset<span class="token punctuation">:</span><span class="token number">238</span>
second_repl_offset<span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span>
repl_backlog_active<span class="token punctuation">:</span><span class="token number">1</span>
repl_backlog_size<span class="token punctuation">:</span><span class="token number">1048576</span>
repl_backlog_first_byte_offset<span class="token punctuation">:</span><span class="token number">1</span>
repl_backlog_histlen<span class="token punctuation">:</span><span class="token number">238</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>6. 部署 Sentinel 节点</strong></p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code>port <span class="token number">26379</span>
daemonize yes
logfile <span class="token string">&quot;/Users/codeai/Develop/logs/redis/log/26379.log&quot;</span>
dir <span class="token string">&quot;/Users/codeai/Develop/logs/redis/db/&quot;</span>
<span class="token operator">#</span> 监控 <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6379</span> 主节点<span class="token punctuation">;</span> <span class="token number">2</span> 表示判断主节点失败至少需要 <span class="token number">2</span> 个 sentinel 节点同意
sentinel monitor mymaster <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token number">6379</span> <span class="token number">2</span>
<span class="token operator">#</span> 设置监听的 master 密码
sentinel auth<span class="token operator">-</span>pass mymaster <span class="token number">1234</span>
<span class="token operator">#</span> <span class="token number">30</span> 秒内 ping 失败<span class="token punctuation">,</span> sentinel 则认为 master 不可用
sentinel down<span class="token operator">-</span>after<span class="token operator">-</span>milliseconds mymaster <span class="token number">30000</span>
<span class="token operator">#</span> 在发生failover主备切换时<span class="token punctuation">,</span> 这个选项指定了最多可以有多少个slave同时对新的master进行同步
sentinel parallel<span class="token operator">-</span>syncs mymaster <span class="token number">1</span>
<span class="token operator">#</span> 如果在该时间（ms）内未能完成failover操作<span class="token punctuation">,</span> 则认为该failover失败
sentinel failover<span class="token operator">-</span>timeout mymaster <span class="token number">180000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>其他节点只是端口不同</p> <p><strong>7. 启动 sentinel 节点</strong></p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token operator">#</span> 方式一
redis<span class="token operator">-</span>sentinel redis<span class="token operator">-</span>sentinel<span class="token operator">-</span><span class="token number">26379.</span>conf<span class="token punctuation">;</span> redis<span class="token operator">-</span>sentinel redis<span class="token operator">-</span>sentinel<span class="token operator">-</span><span class="token number">26380.</span>conf<span class="token punctuation">;</span> redis<span class="token operator">-</span>sentinel redis<span class="token operator">-</span>sentinel<span class="token operator">-</span><span class="token number">26381.</span>conf
<span class="token operator">#</span> 方式二
redis<span class="token operator">-</span>server redis<span class="token operator">-</span>sentinel<span class="token operator">-</span><span class="token number">26379.</span>conf <span class="token comment">--sentinel; redis-server redis-sentinel-26380.conf --sentinel; redis-server redis-sentinel-26381.conf --sentinel; </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="http://qiniu.dong4j.info/2019-07-03-4B44AF64-E724-4A23-A09A-297489A6F834.png" alt="4B44AF64-E724-4A23-A09A-297489A6F834"></p> <p><strong>8. 确认关系</strong></p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code>redis<span class="token operator">-</span>cli <span class="token operator">-</span>h <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token operator">-</span>p <span class="token number">26379</span> info sentinel
<span class="token operator">#</span> Sentinel
sentinel_masters<span class="token punctuation">:</span><span class="token number">1</span>
sentinel_tilt<span class="token punctuation">:</span><span class="token number">0</span>
sentinel_running_scripts<span class="token punctuation">:</span><span class="token number">0</span>
sentinel_scripts_queue_length<span class="token punctuation">:</span><span class="token number">0</span>
sentinel_simulate_failure_flags<span class="token punctuation">:</span><span class="token number">0</span>
master0<span class="token punctuation">:</span>name<span class="token operator">=</span>mymaster<span class="token punctuation">,</span>status<span class="token operator">=</span>ok<span class="token punctuation">,</span>address<span class="token operator">=</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6379</span><span class="token punctuation">,</span>slaves<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>sentinels<span class="token operator">=</span><span class="token number">3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="部署方案"><a href="#部署方案" aria-hidden="true" class="header-anchor">#</a> 部署方案</h2> <ol><li>Sentinel 部署在不同物理机上;</li> <li>部署至少三个且奇数个的 Sentinel 节点;</li></ol> <h3 id="一套-sentinel-监控所有主节点"><a href="#一套-sentinel-监控所有主节点" aria-hidden="true" class="header-anchor">#</a> 一套 Sentinel 监控所有主节点</h3> <p><img src="http://qiniu.dong4j.info/2019-07-03-1656C749-77D9-4004-971A-5E6A751AA602.png" alt="-w500"></p> <p>优点:</p> <ol><li>维护成本低</li></ol> <p>缺点:</p> <ol><li>集群出现异常, 将导致服务不可用</li> <li>过多的网络连接</li></ol> <h3 id="每个主节点各一套-sentinel"><a href="#每个主节点各一套-sentinel" aria-hidden="true" class="header-anchor">#</a> 每个主节点各一套 Sentinel</h3> <p><img src="http://qiniu.dong4j.info/2019-07-03-6D2AAB5C-054B-4595-94C2-9BEAD0EAABAB.png" alt="-w500"></p> <p>优点:</p> <ol><li>某个 Sentinel 集群出现故障, 不会影响其他业务</li> <li>网络连接少</li></ol> <p>缺点:</p> <ol><li>维护成本高</li></ol> <blockquote><p>如果监控同一个业务的多个主节点集合, 推荐使用方案一
如果是多个业务不同主节点集合, 推荐方案二 (推荐)</p></blockquote> <h2 id="redis-连接数太多导致"><a href="#redis-连接数太多导致" aria-hidden="true" class="header-anchor">#</a> Redis 连接数太多导致</h2> <h3 id="原因分析"><a href="#原因分析" aria-hidden="true" class="header-anchor">#</a> 原因分析</h3> <p>Redis 默认最大连接数为 10000个</p> <ol><li>网络通信差, 按照 TCP 协议, 客户端断开连接时, 向服务器端发送 FIN 信号, 但是服务端未接收到, 客户端超时后放弃等待, 直接断开, 服务端由于通信故障, 保持了 ESTABLISHED 状态;</li> <li>客户端异常, 客户端连接之后, 由于代码运行过程中产生异常, 导致未正常释放或者关闭连接;</li> <li>client 设置不合理 (client 数 * maxTotal 是不能超过redis的最大连接数)</li></ol> <h3 id="解决方案"><a href="#解决方案" aria-hidden="true" class="header-anchor">#</a> 解决方案</h3> <p><strong>1. 修改 redis.config 配置</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code># 连接的空闲实现超过 360s, 则主动关闭连接;默认配置为 0 ,导致所有空闲 idle 连接未被释放, 服务端连接泄漏
timeout 360
# 默认关闭, 导致服务端不知客户端连接状态; 开启长连接, 服务端主动(60s)探测客户端 socket 状态
tcp-keeplive 60
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>2. 完善代码</strong></p> <blockquote><p>客户端每次执行完 jedis 里面的方法之后必须关闭链接, 释放资源</p></blockquote> <p><strong>3. redis-proxy 服务化</strong></p> <hr> <h2 id="重构方案"><a href="#重构方案" aria-hidden="true" class="header-anchor">#</a> 重构方案</h2> <blockquote><p>使用 Redis Sentinel 代替 Redis + Keepalived</p></blockquote> <h3 id="架构"><a href="#架构" aria-hidden="true" class="header-anchor">#</a> 架构</h3> <p>重构 redis-proxy</p> <p>提供 6 种 连接模式</p> <p><img src="http://qiniu.dong4j.info/2019-07-03-0652C208-B9C1-4505-92BB-C1BFBC09E9C4.png" alt="0652C208-B9C1-4505-92BB-C1BFBC09E9"></p> <h3 id="component-redis-介绍"><a href="#component-redis-介绍" aria-hidden="true" class="header-anchor">#</a> component-redis 介绍</h3> <p>项目中有单独使用 Redis 的, 也有使用分片方式连接的, 也有使用 redis-proxy 组件来连接 Redis 的.
造成代码不好管理, 因此使用 component-redis 组件为其他模块提供连接 Redis 的功能, 统一管理 Redis 相关代码.</p> <p>作为连接 Redis 的工具模块, 为其他模块提供操作 Redis 的功能, 具有多种模式选择.
客户端不需要再写连接 Redis 相关代码, 只需要按照要求配置即可,减少了冗余代码;</p> <p>兼容原有代码, 只需要将 redis-proxy 依赖替换成 component-redis 即可使用.</p> <h4 id="功能"><a href="#功能" aria-hidden="true" class="header-anchor">#</a> 功能</h4> <ol><li>多种模式任君选择 (standalone, sentinel, shard, shard-sentinel, cluster, hybrid);</li> <li>使用简单, 引入 jar 即可使用;</li> <li>扩展方便, 如果 <code>RedisService</code> 满足不了现有业务需要, 可直接使用各种 Pool 获取 jedis, shardedJedis, jedisCluster 自由发挥;</li></ol> <h4 id="使用方式"><a href="#使用方式" aria-hidden="true" class="header-anchor">#</a> 使用方式</h4> <h5 id="_1-引入依赖"><a href="#_1-引入依赖" aria-hidden="true" class="header-anchor">#</a> 1. 引入依赖</h5> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.iflytek.musicsearch<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>component-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>最新版本<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="_2-配置"><a href="#_2-配置" aria-hidden="true" class="header-anchor">#</a> 2. 配置</h5> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token operator">#</span> jedis pool 配置
<span class="token operator">#</span> 连接超时时间（毫秒）
redis<span class="token punctuation">.</span>connectionTimeout<span class="token operator">=</span><span class="token number">2000</span>
<span class="token operator">#</span> 等待Response超时时间 <span class="token punctuation">(</span>新增<span class="token punctuation">)</span>
redis<span class="token punctuation">.</span>soTimeout<span class="token operator">=</span><span class="token number">5000</span>
redis<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>maxActive<span class="token operator">=</span><span class="token number">5000</span>
redis<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>maxWait<span class="token operator">=</span><span class="token number">5000</span>
redis<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>maxIdle<span class="token operator">=</span><span class="token number">200</span>
redis<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>minIdleTime<span class="token operator">=</span><span class="token number">120</span>
redis<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>testOnBorrow<span class="token operator">=</span><span class="token keyword">true</span>
redis<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>testOnReturn<span class="token operator">=</span><span class="token keyword">false</span>
<span class="token operator">#</span> Redis 配置
redis<span class="token punctuation">.</span>model<span class="token operator">=</span>standalone
redis<span class="token punctuation">.</span>node<span class="token operator">=</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6379</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h5 id="_3-注入-service"><a href="#_3-注入-service" aria-hidden="true" class="header-anchor">#</a> 3. 注入 service</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RedisService</span> redisService<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testRedisService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    redisService<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;redisServiceTest&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;redisServiceTest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="component-redis-配置规范"><a href="#component-redis-配置规范" aria-hidden="true" class="header-anchor">#</a> component-redis 配置规范</h3> <blockquote><p>由于 component-redis 组件需要支持多种模式, 配置需要规范的格式才能避免出错.</p></blockquote> <ol><li>节点使用 <code>,</code> 分隔, 模式分组使用 <code>;</code> 分隔;</li> <li>使用某个 Redis 时, 不要把所有配置全部加上;</li></ol> <p>jedisPool 配置是固定配置, 每种模式都会使用到, 只需要根据业务调整即可.</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token operator">#</span><span class="token operator">#</span> 连接超时时间（毫秒）
redis<span class="token punctuation">.</span>connectionTimeout<span class="token operator">=</span><span class="token number">2000</span>
<span class="token operator">#</span> 等待Response超时时间 <span class="token punctuation">(</span>新增<span class="token punctuation">)</span>
redis<span class="token punctuation">.</span>soTimeout<span class="token operator">=</span><span class="token number">5000</span>
<span class="token operator">#</span> 连接池最大连接数（使用负值表示没有限制）
redis<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>maxActive<span class="token operator">=</span><span class="token number">5000</span>
<span class="token operator">#</span> 连接池最大阻塞等待时间（使用负值表示没有限制）
redis<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>maxWait<span class="token operator">=</span><span class="token number">5000</span>
<span class="token operator">#</span> 连接池中的最大空闲连接
redis<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>maxIdle<span class="token operator">=</span><span class="token number">200</span>
<span class="token operator">#</span> 连接池中的最小空闲连接
redis<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>minIdleTime<span class="token operator">=</span><span class="token number">120</span>
<span class="token operator">#</span> 当调用borrow Object方法时<span class="token punctuation">,</span> 是否进行有效性检查
redis<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>testOnBorrow<span class="token operator">=</span><span class="token keyword">true</span>
<span class="token operator">#</span> 调用<span class="token keyword">return</span> 一个对象方法时<span class="token punctuation">,</span> 是否检查其有效性
redis<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>testOnReturn<span class="token operator">=</span><span class="token keyword">false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-lua line-numbers-mode"><pre class="language-lua"><code>redis<span class="token punctuation">.</span>model<span class="token operator">=</span>模式名
redis<span class="token punctuation">.</span>node<span class="token operator">=</span>业务名<span class="token operator">#</span>模式名<span class="token punctuation">:</span><span class="token operator">//</span><span class="token punctuation">[</span><span class="token punctuation">:</span>password@<span class="token punctuation">]</span>ip<span class="token punctuation">:</span>port<span class="token punctuation">[</span><span class="token operator">/</span>database<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这里以现有业务为例子:</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code>redis<span class="token punctuation">.</span>model<span class="token operator">=</span>hybrid
<span class="token operator">#</span> callout 使用单机模式<span class="token punctuation">,</span> biz 使用哨兵模式
redis<span class="token punctuation">.</span>node<span class="token operator">=</span>callout<span class="token operator">#</span>standalone<span class="token punctuation">:</span><span class="token operator">//</span><span class="token punctuation">:</span><span class="token number">1234</span>@<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6382</span><span class="token punctuation">;</span>biz<span class="token operator">#</span>sentinel<span class="token punctuation">:</span><span class="token operator">//</span><span class="token punctuation">:</span><span class="token number">5678</span>@<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">26379</span><span class="token punctuation">,</span>sentinel<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">26380</span><span class="token punctuation">,</span>sentinel<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">26381</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="配置优化"><a href="#配置优化" aria-hidden="true" class="header-anchor">#</a> 配置优化</h4> <p><strong>使用标准的 uri 协议代替 host 和 port</strong></p> <p>避免手动解析出错</p> <p>格式如下:</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token operator">#</span> 完整格式
redis<span class="token punctuation">:</span><span class="token operator">//</span>user<span class="token punctuation">:</span>password@ip<span class="token punctuation">:</span>port<span class="token operator">/</span>database
<span class="token operator">#</span> 不需要用户名的格式
redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token punctuation">:</span>password@ip<span class="token punctuation">:</span>port<span class="token operator">/</span>database
<span class="token operator">#</span> 不需要密码的格式
redis<span class="token punctuation">:</span><span class="token operator">//</span>ip<span class="token punctuation">:</span>port<span class="token operator">/</span>database
<span class="token operator">#</span> 不需要 database 的配置<span class="token punctuation">,</span> 将默认使用 <span class="token number">0</span> db
redis<span class="token punctuation">:</span><span class="token operator">//</span>ip<span class="token punctuation">:</span>port
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>密码设置</strong></p> <p>redis的查询速度是非常快的, 外部用户一秒内可以尝试多大150K个密码；所以密码要尽量长;</p> <p>建议设置为 64 位长度密码</p> <h5 id="standalone-单机-模式配置"><a href="#standalone-单机-模式配置" aria-hidden="true" class="header-anchor">#</a> standalone (单机)模式配置</h5> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code>redis<span class="token punctuation">.</span>model<span class="token operator">=</span>standalone
<span class="token operator">#</span> password 前面的 <span class="token punctuation">:</span> 不能少
redis<span class="token punctuation">.</span>node<span class="token operator">=</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token punctuation">:</span>password@<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6382</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>demo:</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code>redis<span class="token punctuation">.</span>model<span class="token operator">=</span>standalone
redis<span class="token punctuation">.</span>node<span class="token operator">=</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6379</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="sentinel"><a href="#sentinel" aria-hidden="true" class="header-anchor">#</a> sentinel</h5> <p>哨兵模式是对单机模式高可用的一种实现方式, 可以实现故障主从自动切换</p> <p>哨兵模式需要配置 master name, 和 <code>redis-sentinel</code>.conf 中的 <code>sentinel monitor masterName xxx</code> 保持一致</p> <p>哨兵模式只能接收一个密码, 密码设置在任意节点即可(第一个最好了)</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code>redis<span class="token punctuation">.</span>model<span class="token operator">=</span>sentinel
redis<span class="token punctuation">.</span>node<span class="token operator">=</span>mymaster<span class="token operator">#</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token punctuation">:</span><span class="token number">1234</span>@<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">26379</span><span class="token punctuation">,</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">26380</span><span class="token punctuation">,</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">26381</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>哨兵模式就是单机模式的增强版, 需要配置多个哨兵节点(避免造成主从切换失败, 最少3组哨兵), 节点之间使用 <code>,</code> 分隔</p> <p>demo:</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code>redis<span class="token punctuation">.</span>model<span class="token operator">=</span>sentinel
redis<span class="token punctuation">.</span>node<span class="token operator">=</span>mymaster<span class="token operator">#</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token punctuation">:</span>s4jRcLhAcUdKrNmqv9XQxwbEUZ6p4sK3kTFE4k9ts3PLahnswEzE4aPgXEQ6QdMa@<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">26379</span><span class="token punctuation">,</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">26380</span><span class="token punctuation">,</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">26381</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="sharding-分片-模式配置"><a href="#sharding-分片-模式配置" aria-hidden="true" class="header-anchor">#</a> sharding (分片)模式配置</h5> <p><strong>每组 redis 实例可以设置不同的密码</strong></p> <p>分片实例之间使用 <code>,</code> 分隔</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code>redis<span class="token punctuation">.</span>model<span class="token operator">=</span>sharding
redis<span class="token punctuation">.</span>node<span class="token operator">=</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token punctuation">:</span><span class="token number">1234</span>@<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6382</span><span class="token punctuation">,</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token punctuation">:</span><span class="token number">5678</span>@<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6382</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>demo:</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code><span class="token operator">#</span> redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token punctuation">:</span>password@ip<span class="token punctuation">:</span>port<span class="token operator">/</span>database 没有密码则使用 redis<span class="token punctuation">:</span><span class="token operator">//</span>ip<span class="token punctuation">:</span>port<span class="token operator">/</span>database
redis<span class="token punctuation">.</span>model<span class="token operator">=</span>sharding
redis<span class="token punctuation">.</span>node<span class="token operator">=</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token punctuation">:</span><span class="token number">1234</span>@<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6382</span><span class="token punctuation">,</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token punctuation">:</span>s4jRcLhAcUdKrNmqv9XQxwbEUZ6p4sK3kTFE4k9ts3PLahnswEzE4aPgXEQ6QdMa@<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6379</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="sharding-sentinel"><a href="#sharding-sentinel" aria-hidden="true" class="header-anchor">#</a> sharding-sentinel</h5> <p>分片哨兵模式是对分片模式高可用的一种实现方式, 可以实现分片模式下, 故障主从自动切换</p> <p>分片哨兵模式是哨兵模式和分片模式的结合, 配置可</p> <p>demo:</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code>redis<span class="token punctuation">.</span>model<span class="token operator">=</span>sharding<span class="token operator">-</span>sentinel
redis<span class="token punctuation">.</span>node<span class="token operator">=</span>mymaster<span class="token operator">#</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">26379</span><span class="token punctuation">,</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">26380</span><span class="token punctuation">,</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">26381</span><span class="token punctuation">;</span>mymaster1<span class="token operator">#</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">26379</span><span class="token punctuation">,</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">26380</span><span class="token punctuation">,</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">26381</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="cluster"><a href="#cluster" aria-hidden="true" class="header-anchor">#</a> cluster</h5> <p>redis 3.x 远程集群模式</p> <p>demo:</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code>redis<span class="token punctuation">.</span>model<span class="token operator">=</span>cluster
redis<span class="token punctuation">.</span>node<span class="token operator">=</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6379</span><span class="token punctuation">,</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6380</span><span class="token punctuation">,</span>redis<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6381</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h5 id="hybrid"><a href="#hybrid" aria-hidden="true" class="header-anchor">#</a> hybrid</h5> <p>混合模式, 为了兼容现有 Redis 环境, 一种临时的解决方案, 改造完成后, 将配置修改为 <code>sentinel</code> 即可</p> <p>demo:</p> <div class="language-lua line-numbers-mode"><pre class="language-lua"><code>redis<span class="token punctuation">.</span>model<span class="token operator">=</span>hybrid
redis<span class="token punctuation">.</span>node<span class="token operator">=</span>callout<span class="token operator">#</span>standalone<span class="token punctuation">:</span><span class="token operator">//</span><span class="token punctuation">:</span><span class="token number">1234</span>@<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">6382</span><span class="token punctuation">;</span>mymaster<span class="token operator">#</span>sentinel<span class="token punctuation">:</span><span class="token operator">//</span><span class="token punctuation">:</span>s4jRcLhAcUdKrNmqv9XQxwbEUZ6p4sK3kTFE4k9ts3PLahnswEzE4aPgXEQ6QdMa@<span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">26379</span><span class="token punctuation">,</span>sentinel<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">26380</span><span class="token punctuation">,</span>sentinel<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">26381</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>混合模式实现了 <code>standalone</code>, <code>sentinel</code>, <code>sharding</code> 模式的混合使用</p> <h3 id="代码重构"><a href="#代码重构" aria-hidden="true" class="header-anchor">#</a> 代码重构</h3> <ol><li>使用 <code>@Value</code> 实现自动配置, 代替 xml 中的 bean 标签;</li> <li>使用 logbok 简化代码;</li> <li>不在使用 RedisServiceFacotry 获取 redisService, 某个模块需要使用该组件时, import xml 即可 (多容器问题);</li> <li>使用 log4j2 代替 log4j;</li> <li>编译版本由 jdk1.6 改为 jdk1.7;</li> <li>使用代理类重构安全关闭 jedis 连接的方式;</li></ol> <p>重构前:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> flag<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RedisCallBack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">doCallback</span><span class="token punctuation">(</span><span class="token class-name">Jedis</span> jedis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token function">getJedisPoolByFlag</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>重构后:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">String</span> flag<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">RedisUtil</span><span class="token punctuation">.</span><span class="token function">jedisProxy</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></div> <!----> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">7/3/2019, 6:17:56 PM</span></div></footer> <!----> </main> <div class="valine-wrapper" data-v-0162251c><div id="valine" data-v-0162251c></div></div></div> <div class="back-to-ceiling" style="right:1rem;bottom:3rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;background-color:rgba(231, 234, 241,.5);display:none;" data-v-d0bfeaa4 data-v-d0bfeaa4><i class="iconfont reco-up" data-v-d0bfeaa4></i></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.23d4d300.js" defer></script><script src="/assets/js/4.28fd9624.js" defer></script><script src="/assets/js/1.928d15b1.js" defer></script><script src="/assets/js/70.2308210c.js" defer></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>深入理解 Java 内存模型-final | Black House</title>
    <meta name="description" content="代码千万行, 注释第一行, 编码不规范, 同事两行泪.">
    <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.35477964.css" as="style"><link rel="preload" href="/assets/js/app.23d4d300.js" as="script"><link rel="preload" href="/assets/js/4.28fd9624.js" as="script"><link rel="preload" href="/assets/js/1.928d15b1.js" as="script"><link rel="preload" href="/assets/js/55.33da5078.js" as="script"><link rel="prefetch" href="/assets/js/10.c2349238.js"><link rel="prefetch" href="/assets/js/100.031b764c.js"><link rel="prefetch" href="/assets/js/11.597103f4.js"><link rel="prefetch" href="/assets/js/12.01e326a5.js"><link rel="prefetch" href="/assets/js/13.6937eabc.js"><link rel="prefetch" href="/assets/js/14.0e95ab13.js"><link rel="prefetch" href="/assets/js/15.43c0e778.js"><link rel="prefetch" href="/assets/js/16.8c75ae64.js"><link rel="prefetch" href="/assets/js/17.02d12878.js"><link rel="prefetch" href="/assets/js/18.6b597676.js"><link rel="prefetch" href="/assets/js/19.524d893b.js"><link rel="prefetch" href="/assets/js/20.11686f52.js"><link rel="prefetch" href="/assets/js/21.ad025f0d.js"><link rel="prefetch" href="/assets/js/22.dca96777.js"><link rel="prefetch" href="/assets/js/23.121a28ab.js"><link rel="prefetch" href="/assets/js/24.99537c05.js"><link rel="prefetch" href="/assets/js/25.8f31fa14.js"><link rel="prefetch" href="/assets/js/26.a121c6cc.js"><link rel="prefetch" href="/assets/js/27.a57ec579.js"><link rel="prefetch" href="/assets/js/28.3f009b45.js"><link rel="prefetch" href="/assets/js/29.9c269e5b.js"><link rel="prefetch" href="/assets/js/30.168f09f3.js"><link rel="prefetch" href="/assets/js/31.ed454542.js"><link rel="prefetch" href="/assets/js/32.5f77ac76.js"><link rel="prefetch" href="/assets/js/33.3b921274.js"><link rel="prefetch" href="/assets/js/34.2e2dd8bc.js"><link rel="prefetch" href="/assets/js/35.457382a4.js"><link rel="prefetch" href="/assets/js/36.097474f8.js"><link rel="prefetch" href="/assets/js/37.2914dab3.js"><link rel="prefetch" href="/assets/js/38.bd900eff.js"><link rel="prefetch" href="/assets/js/39.00b0bb76.js"><link rel="prefetch" href="/assets/js/40.6d5aae82.js"><link rel="prefetch" href="/assets/js/41.e00929aa.js"><link rel="prefetch" href="/assets/js/42.b0c12805.js"><link rel="prefetch" href="/assets/js/43.7a60ce77.js"><link rel="prefetch" href="/assets/js/44.adf74ab9.js"><link rel="prefetch" href="/assets/js/45.36b6b8e2.js"><link rel="prefetch" href="/assets/js/46.a254f56a.js"><link rel="prefetch" href="/assets/js/47.aec9ad68.js"><link rel="prefetch" href="/assets/js/48.e3477ba7.js"><link rel="prefetch" href="/assets/js/49.5d974cde.js"><link rel="prefetch" href="/assets/js/5.c7e63593.js"><link rel="prefetch" href="/assets/js/50.c71471a2.js"><link rel="prefetch" href="/assets/js/51.de15920e.js"><link rel="prefetch" href="/assets/js/52.1eabf9c1.js"><link rel="prefetch" href="/assets/js/53.ada4082c.js"><link rel="prefetch" href="/assets/js/54.985c146e.js"><link rel="prefetch" href="/assets/js/56.8b899006.js"><link rel="prefetch" href="/assets/js/57.f7ea6441.js"><link rel="prefetch" href="/assets/js/58.55ca22b7.js"><link rel="prefetch" href="/assets/js/59.3b16a882.js"><link rel="prefetch" href="/assets/js/6.8843ac12.js"><link rel="prefetch" href="/assets/js/60.7365ec6c.js"><link rel="prefetch" href="/assets/js/61.0508510a.js"><link rel="prefetch" href="/assets/js/62.8c3a0bf0.js"><link rel="prefetch" href="/assets/js/63.99503945.js"><link rel="prefetch" href="/assets/js/64.1193b17d.js"><link rel="prefetch" href="/assets/js/65.40a7b476.js"><link rel="prefetch" href="/assets/js/66.c95c74fb.js"><link rel="prefetch" href="/assets/js/67.dcc1ce00.js"><link rel="prefetch" href="/assets/js/68.e8aeba6d.js"><link rel="prefetch" href="/assets/js/69.13b69234.js"><link rel="prefetch" href="/assets/js/7.cda98f34.js"><link rel="prefetch" href="/assets/js/70.2308210c.js"><link rel="prefetch" href="/assets/js/71.bdac7c88.js"><link rel="prefetch" href="/assets/js/72.d5e7dabc.js"><link rel="prefetch" href="/assets/js/73.f1cec72d.js"><link rel="prefetch" href="/assets/js/74.13cbda62.js"><link rel="prefetch" href="/assets/js/75.5ec77696.js"><link rel="prefetch" href="/assets/js/76.e80c98fb.js"><link rel="prefetch" href="/assets/js/77.edf10bf3.js"><link rel="prefetch" href="/assets/js/78.9472aec2.js"><link rel="prefetch" href="/assets/js/79.2f59f6d2.js"><link rel="prefetch" href="/assets/js/8.64e66a3d.js"><link rel="prefetch" href="/assets/js/80.9d9b311d.js"><link rel="prefetch" href="/assets/js/81.112c831f.js"><link rel="prefetch" href="/assets/js/82.e98222ae.js"><link rel="prefetch" href="/assets/js/83.a7741563.js"><link rel="prefetch" href="/assets/js/84.47f9ec86.js"><link rel="prefetch" href="/assets/js/85.4b288089.js"><link rel="prefetch" href="/assets/js/86.d01d1b2a.js"><link rel="prefetch" href="/assets/js/87.26f71539.js"><link rel="prefetch" href="/assets/js/88.0cdca4ad.js"><link rel="prefetch" href="/assets/js/89.fca9f86b.js"><link rel="prefetch" href="/assets/js/9.8fcc4a9b.js"><link rel="prefetch" href="/assets/js/90.49e1e9ad.js"><link rel="prefetch" href="/assets/js/91.58ec2d07.js"><link rel="prefetch" href="/assets/js/92.0da2a72c.js"><link rel="prefetch" href="/assets/js/93.9d312aaf.js"><link rel="prefetch" href="/assets/js/94.e94db684.js"><link rel="prefetch" href="/assets/js/95.ed2aa34a.js"><link rel="prefetch" href="/assets/js/96.6a2e264d.js"><link rel="prefetch" href="/assets/js/97.8a055f18.js"><link rel="prefetch" href="/assets/js/98.1284385e.js"><link rel="prefetch" href="/assets/js/99.830ddc7a.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.3ceaf8af.js">
    <link rel="stylesheet" href="/assets/css/0.styles.35477964.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container"><div><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/head.png" alt="Black House" class="logo"> <span class="site-name">Black House</span></a> <div class="links"><div class="color-picker"><a href="#" class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><!----> <div class="dark-theme-options toggle-option"><label for="dark-theme-toggle">Enable Dark Theme?</label> <input id="dark-theme-toggle" type="checkbox" checked="checked"></div></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/Design.html" class="nav-link"><i class="iconfont undefined"></i>
  Design
</a></li><li class="dropdown-item"><!----> <a href="/category/Framework.html" class="nav-link"><i class="iconfont undefined"></i>
  Framework
</a></li><li class="dropdown-item"><!----> <a href="/category/Spring.html" class="nav-link"><i class="iconfont undefined"></i>
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/category/Issue.html" class="nav-link"><i class="iconfont undefined"></i>
  Issue
</a></li><li class="dropdown-item"><!----> <a href="/category/Java.html" class="nav-link"><i class="iconfont undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/category/Mac.html" class="nav-link"><i class="iconfont undefined"></i>
  Mac
</a></li><li class="dropdown-item"><!----> <a href="/category/Other.html" class="nav-link"><i class="iconfont undefined"></i>
  Other
</a></li><li class="dropdown-item"><!----> <a href="/category/Middleware.html" class="nav-link"><i class="iconfont undefined"></i>
  Middleware
</a></li><li class="dropdown-item"><!----> <a href="/category/NoSQL.html" class="nav-link"><i class="iconfont undefined"></i>
  NoSQL
</a></li><li class="dropdown-item"><!----> <a href="/category/Python.html" class="nav-link"><i class="iconfont undefined"></i>
  Python
</a></li><li class="dropdown-item"><!----> <a href="/category/Tools.html" class="nav-link"><i class="iconfont undefined"></i>
  Tools
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/dong4j" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/Design.html" class="nav-link"><i class="iconfont undefined"></i>
  Design
</a></li><li class="dropdown-item"><!----> <a href="/category/Framework.html" class="nav-link"><i class="iconfont undefined"></i>
  Framework
</a></li><li class="dropdown-item"><!----> <a href="/category/Spring.html" class="nav-link"><i class="iconfont undefined"></i>
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/category/Issue.html" class="nav-link"><i class="iconfont undefined"></i>
  Issue
</a></li><li class="dropdown-item"><!----> <a href="/category/Java.html" class="nav-link"><i class="iconfont undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/category/Mac.html" class="nav-link"><i class="iconfont undefined"></i>
  Mac
</a></li><li class="dropdown-item"><!----> <a href="/category/Other.html" class="nav-link"><i class="iconfont undefined"></i>
  Other
</a></li><li class="dropdown-item"><!----> <a href="/category/Middleware.html" class="nav-link"><i class="iconfont undefined"></i>
  Middleware
</a></li><li class="dropdown-item"><!----> <a href="/category/NoSQL.html" class="nav-link"><i class="iconfont undefined"></i>
  NoSQL
</a></li><li class="dropdown-item"><!----> <a href="/category/Python.html" class="nav-link"><i class="iconfont undefined"></i>
  Python
</a></li><li class="dropdown-item"><!----> <a href="/category/Tools.html" class="nav-link"><i class="iconfont undefined"></i>
  Tools
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/dong4j" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>深入理解 Java 内存模型-final</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/views/java/2016/08061501.html#写final域的重排序规则" class="sidebar-link">写final域的重排序规则</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/java/2016/08061501.html#读final域的重排序规则" class="sidebar-link">读final域的重排序规则</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/java/2016/08061501.html#如果final域是引用类型" class="sidebar-link">如果final域是引用类型</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/java/2016/08061501.html#为什么-final-引用不能从构造函数内“逸出”" class="sidebar-link">为什么 final 引用不能从构造函数内“逸出”</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/java/2016/08061501.html#final-语义在处理器中的实现" class="sidebar-link">final 语义在处理器中的实现</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/java/2016/08061501.html#jsr-133-为什么要增强-final-的语义" class="sidebar-link">JSR-133 为什么要增强 final 的语义</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/java/2016/08061501.html#参考文献" class="sidebar-link">参考文献</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page reco-hide"> <div class="page-title"><h1>深入理解 Java 内存模型-final</h1> <hr> <div data-v-0b496ca7><i class="iconfont reco-account" data-v-0b496ca7><span data-v-0b496ca7>weakish</span></i> <i class="iconfont reco-date" data-v-0b496ca7><span data-v-0b496ca7>8/6/2016</span></i> <!----> <i class="iconfont reco-tag tags" data-v-0b496ca7><span class="tag-item" data-v-0b496ca7>
      JavaSE
    </span><span class="tag-item" data-v-0b496ca7>
      JVM
    </span><span class="tag-item" data-v-0b496ca7>
      JMM
    </span></i></div></div> <div class="content__default"><div class="tip custom-block"><ol><li><p>在构造函数内对一个final域的写入, 与随后把这个被构造对象的引用赋值给一个引用变量, 这两个操作之间不能重排序.</p></li> <li><p>初次读一个包含final域的对象的引用, 与随后初次读这个final域, 这两个操作之间不能重排序.</p></li></ol></div> <p><a href="https://segmentfault.com/a/1190000000453976" target="_blank" rel="noopener noreferrer">原文出处 https://segmentfault.com/a/1190000000453976<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>与前面介绍的<a href="http://segmentfault.com/a/1190000000460772" target="_blank" rel="noopener noreferrer">锁<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>和<a href="http://segmentfault.com/a/1190000000453976" target="_blank" rel="noopener noreferrer">volatile<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>相比较, 对final域的读和写更像是普通的变量访问. 对于final域, 编译器和处理器要遵守两个重排序规则:</p> <ol><li>在构造函数内对一个final域的写入, 与随后把这个被构造对象的引用赋值给一个引用变量, 这两个操作之间不能重排序.</li> <li>初次读一个包含final域的对象的引用, 与随后初次读这个final域, 这两个操作之间不能重排序.</li></ol> <p>下面, 我们通过一些示例性的代码来分别说明这两个规则:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FinalExample</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>                            <span class="token comment">//普通变量</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> j<span class="token punctuation">;</span>                      <span class="token comment">//final变量</span>
    <span class="token keyword">static</span> <span class="token class-name">FinalExample</span> obj<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">FinalExample</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">//构造函数</span>
        i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                        <span class="token comment">//写普通域</span>
        j <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                        <span class="token comment">//写final域</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> writer <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">//写线程A执行</span>
        obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalExample</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> reader <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token comment">//读线程B执行</span>
        <span class="token class-name">FinalExample</span> object <span class="token operator">=</span> obj<span class="token punctuation">;</span>       <span class="token comment">//读对象引用</span>
        <span class="token keyword">int</span> a <span class="token operator">=</span> object<span class="token punctuation">.</span>i<span class="token punctuation">;</span>                <span class="token comment">//读普通域</span>
        <span class="token keyword">int</span> b <span class="token operator">=</span> object<span class="token punctuation">.</span>j<span class="token punctuation">;</span>                <span class="token comment">//读final域</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>这里假设一个线程A执行writer ()方法, 随后另一个线程B执行reader ()方法. 下面我们通过这两个线程的交互来说明这两个规则.</p> <h2 id="写final域的重排序规则"><a href="#写final域的重排序规则" aria-hidden="true" class="header-anchor">#</a> 写final域的重排序规则</h2> <p>写final域的重排序规则禁止把final域的写重排序到构造函数之外. 这个规则的实现包含下面2个方面:</p> <ul><li>JMM禁止编译器把final域的写重排序到构造函数之外.</li> <li>编译器会在final域的写之后, 构造函数return之前, 插入一个StoreStore屏障. 这个屏障禁止处理器把final域的写重排序到构造函数之外.</li></ul> <p>现在让我们分析writer ()方法. writer ()方法只包含一行代码: finalExample = new FinalExample (). 这行代码包含两个步骤:</p> <ol><li>构造一个FinalExample类型的对象；</li> <li>把这个对象的引用赋值给引用变量obj.</li></ol> <p>假设线程B读对象引用与读对象的成员域之间没有重排序（马上会说明为什么需要这个假设）, 下图是一种可能的执行时序:</p> <p><img src="http://qiniu.dong4j.info/2019-07-02-bVb738.." alt=""></p> <p>在上图中, 写普通域的操作被编译器重排序到了构造函数之外, 读线程B错误的读取了普通变量i初始化之前的值. 而写final域的操作, 被写final域的重排序规则“限定”在了构造函数之内, 读线程B正确的读取了final变量初始化之后的值.</p> <p>写final域的重排序规则可以确保: 在对象引用为任意线程可见之前, 对象的final域已经被正确初始化过了, 而普通域不具有这个保障. 以上图为例, 在读线程B“看到”对象引用obj时, 很可能obj对象还没有构造完成（对普通域i的写操作被重排序到构造函数外, 此时初始值2还没有写入普通域i）.</p> <h2 id="读final域的重排序规则"><a href="#读final域的重排序规则" aria-hidden="true" class="header-anchor">#</a> 读final域的重排序规则</h2> <p>读final域的重排序规则如下:</p> <ul><li>在一个线程中, 初次读对象引用与初次读该对象包含的final域, JMM禁止处理器重排序这两个操作（注意, 这个规则仅仅针对处理器）. 编译器会在读final域操作的前面插入一个LoadLoad屏障.</li></ul> <p>初次读对象引用与初次读该对象包含的final域, 这两个操作之间存在间接依赖关系. 由于编译器遵守间接依赖关系, 因此编译器不会重排序这两个操作. 大多数处理器也会遵守间接依赖, 大多数处理器也不会重排序这两个操作. 但有少数处理器允许对存在间接依赖关系的操作做重排序（比如alpha处理器）, 这个规则就是专门用来针对这种处理器.</p> <p>reader()方法包含三个操作:</p> <ol><li>初次读引用变量obj;</li> <li>初次读引用变量obj指向对象的普通域j.</li> <li>初次读引用变量obj指向对象的final域i.</li></ol> <p>现在我们假设写线程A没有发生任何重排序, 同时程序在不遵守间接依赖的处理器上执行, 下面是一种可能的执行时序:</p> <p><img src="http://qiniu.dong4j.info/2019-07-02-bVb739.." alt=""></p> <p>在上图中, 读对象的普通域的操作被处理器重排序到读对象引用之前. 读普通域时, 该域还没有被写线程A写入, 这是一个错误的读取操作. 而读final域的重排序规则会把读对象final域的操作“限定”在读对象引用之后, 此时该final域已经被A线程初始化过了, 这是一个正确的读取操作.</p> <p>读final域的重排序规则可以确保: 在读一个对象的final域之前, 一定会先读包含这个final域的对象的引用. 在这个示例程序中, 如果该引用不为null, 那么引用对象的final域一定已经被A线程初始化过了.</p> <h2 id="如果final域是引用类型"><a href="#如果final域是引用类型" aria-hidden="true" class="header-anchor">#</a> 如果final域是引用类型</h2> <p>上面我们看到的final域是基础数据类型, 下面让我们看看如果final域是引用类型, 将会有什么效果？</p> <p>请看下列示例代码:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FinalReferenceExample</span> <span class="token punctuation">{</span>
<span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> intArray<span class="token punctuation">;</span>                     <span class="token comment">//final是引用类型</span>
<span class="token keyword">static</span> <span class="token class-name">FinalReferenceExample</span> obj<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">FinalReferenceExample</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">//构造函数</span>
    intArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>              <span class="token comment">//1</span>
    intArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                   <span class="token comment">//2</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> writerOne <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment">//写线程A执行</span>
    obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalReferenceExample</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//3</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> writerTwo <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment">//写线程B执行</span>
    obj<span class="token punctuation">.</span>intArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                 <span class="token comment">//4</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> reader <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token comment">//读线程C执行</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment">//5</span>
        <span class="token keyword">int</span> temp1 <span class="token operator">=</span> obj<span class="token punctuation">.</span>intArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token comment">//6</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>这里final域为一个引用类型, 它引用一个int型的数组对象. 对于引用类型, 写final域的重排序规则对编译器和处理器增加了如下约束:</p> <ol><li>在构造函数内对一个final引用的对象的成员域的写入, 与随后在构造函数外把这个被构造对象的引用赋值给一个引用变量, 这两个操作之间不能重排序.</li></ol> <p>对上面的示例程序, 我们假设首先线程A执行writerOne()方法, 执行完后线程B执行writerTwo()方法, 执行完后线程C执行reader ()方法. 下面是一种可能的线程执行时序:</p> <p><img src="http://qiniu.dong4j.info/2019-07-02-bVb74a.." alt=""></p> <p>在上图中, 1是对final域的写入, 2是对这个final域引用的对象的成员域的写入, 3是把被构造的对象的引用赋值给某个引用变量. 这里除了前面提到的1不能和3重排序外, 2和3也不能重排序.</p> <p>JMM可以确保读线程C至少能看到写线程A在构造函数中对final引用对象的成员域的写入. 即C至少能看到数组下标0的值为1. 而写线程B对数组元素的写入, 读线程C可能看的到, 也可能看不到. JMM不保证线程B的写入对读线程C可见, 因为写线程B和读线程C之间存在数据竞争, 此时的执行结果不可预知.</p> <p>如果想要确保读线程C看到写线程B对数组元素的写入, 写线程B和读线程C之间需要使用同步原语（lock或volatile）来确保内存可见性.</p> <h2 id="为什么-final-引用不能从构造函数内“逸出”"><a href="#为什么-final-引用不能从构造函数内“逸出”" aria-hidden="true" class="header-anchor">#</a> 为什么 final 引用不能从构造函数内“逸出”</h2> <p>前面我们提到过, 写final域的重排序规则可以确保: 在引用变量为任意线程可见之前, 该引用变量指向的对象的final域已经在构造函数中被正确初始化过了. 其实要得到这个效果, 还需要一个保证: 在构造函数内部, 不能让这个被构造对象的引用为其他线程可见, 也就是对象引用不能在构造函数中“逸出”. 为了说明问题, 让我们来看下面示例代码:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FinalReferenceEscapeExample</span> <span class="token punctuation">{</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token class-name">FinalReferenceEscapeExample</span> obj<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">FinalReferenceEscapeExample</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                              <span class="token comment">//1写final域</span>
    obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>                          <span class="token comment">//2 this引用在此“逸出”</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">FinalReferenceEscapeExample</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> reader <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                     <span class="token comment">//3</span>
        <span class="token keyword">int</span> temp <span class="token operator">=</span> obj<span class="token punctuation">.</span>i<span class="token punctuation">;</span>                 <span class="token comment">//4</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>假设一个线程A执行writer()方法, 另一个线程B执行reader()方法. 这里的操作2使得对象还未完成构造前就为线程B可见. 即使这里的操作2是构造函数的最后一步, 且即使在程序中操作2排在操作1后面, 执行read()方法的线程仍然可能无法看到final域被初始化后的值, 因为这里的操作1和操作2之间可能被重排序. 实际的执行时序可能如下图所示:</p> <p><img src="http://qiniu.dong4j.info/2019-07-02-bVb74f.." alt=""></p> <p>从上图我们可以看出: 在构造函数返回前, 被构造对象的引用不能为其他线程可见, 因为此时的final域可能还没有被初始化. 在构造函数返回后, 任意线程都将保证能看到final域正确初始化之后的值.</p> <h2 id="final-语义在处理器中的实现"><a href="#final-语义在处理器中的实现" aria-hidden="true" class="header-anchor">#</a> final 语义在处理器中的实现</h2> <p>现在我们以x86处理器为例, 说明final语义在处理器中的具体实现.</p> <p>上面我们提到, 写final域的重排序规则会要求译编器在final域的写之后, 构造函数return之前, 插入一个StoreStore障屏. 读final域的重排序规则要求编译器在读final域的操作前面插入一个LoadLoad屏障.</p> <p>由于x86处理器不会对写-写操作做重排序, 所以在x86处理器中, 写final域需要的StoreStore障屏会被省略掉. 同样, 由于x86处理器不会对存在间接依赖关系的操作做重排序, 所以在x86处理器中, 读final域需要的LoadLoad屏障也会被省略掉. 也就是说在x86处理器中, final域的读/写不会插入任何内存屏障！</p> <h2 id="jsr-133-为什么要增强-final-的语义"><a href="#jsr-133-为什么要增强-final-的语义" aria-hidden="true" class="header-anchor">#</a> JSR-133 为什么要增强 final 的语义</h2> <p>在旧的Java内存模型中 , 最严重的一个缺陷就是线程可能看到final域的值会改变. 比如, 一个线程当前看到一个整形final域的值为0（还未初始化之前的默认值）, 过一段时间之后这个线程再去读这个final域的值时, 却发现值变为了1（被某个线程初始化之后的值）. 最常见的例子就是在旧的Java内存模型中, String的值可能会改变（参考文献2中有一个具体的例子, 感兴趣的读者可以自行参考, 这里就不赘述了）.</p> <p>为了修补这个漏洞, JSR-133专家组增强了final的语义. 通过为final域增加写和读重排序规则, 可以为java程序员提供初始化安全保证: 只要对象是正确构造的（被构造对象的引用在构造函数中没有“逸出”）, 那么不需要使用同步（指lock和volatile的使用）, 就可以保证任意线程都能看到这个final域在构造函数中被初始化之后的值.</p> <h2 id="参考文献"><a href="#参考文献" aria-hidden="true" class="header-anchor">#</a> 参考文献</h2> <ol><li><a href="http://www.cs.umd.edu/users/pugh/java/memoryModel/jsr-133-faq.html" target="_blank" rel="noopener noreferrer"> JSR 133 (Java Memory Model) FAQ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://www.amazon.com/Java-Concurrency-Practice-Brian-Goetz/dp/0321349601/ref=pd_sim_b_1" target="_blank" rel="noopener noreferrer"> Java Concurrency in Practice<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://gee.cs.oswego.edu/dl/jmm/cookbook.html" target="_blank" rel="noopener noreferrer"> The JSR-133 Cookbook for Compiler Writers<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://download.intel.com/products/processor/manual/253668.pdf" target="_blank" rel="noopener noreferrer">Intel® 64 and IA-32 ArchitecturesvSoftware Developer’s Manual Volume 3A: System Programming Guide, Part 1<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol></div> <!----> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">7/3/2019, 6:17:56 PM</span></div></footer> <!----> </main> <div class="valine-wrapper" data-v-0162251c><div id="valine" data-v-0162251c></div></div></div> <div class="back-to-ceiling" style="right:1rem;bottom:3rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;background-color:rgba(231, 234, 241,.5);display:none;" data-v-d0bfeaa4 data-v-d0bfeaa4><i class="iconfont reco-up" data-v-d0bfeaa4></i></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.23d4d300.js" defer></script><script src="/assets/js/4.28fd9624.js" defer></script><script src="/assets/js/1.928d15b1.js" defer></script><script src="/assets/js/55.33da5078.js" defer></script>
  </body>
</html>

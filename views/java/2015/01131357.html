<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Java 8 的元空间 | Black House</title>
    <meta name="description" content="代码千万行, 注释第一行, 编码不规范, 同事两行泪.">
    <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.35477964.css" as="style"><link rel="preload" href="/assets/js/app.23d4d300.js" as="script"><link rel="preload" href="/assets/js/4.28fd9624.js" as="script"><link rel="preload" href="/assets/js/1.928d15b1.js" as="script"><link rel="preload" href="/assets/js/30.168f09f3.js" as="script"><link rel="prefetch" href="/assets/js/10.c2349238.js"><link rel="prefetch" href="/assets/js/100.031b764c.js"><link rel="prefetch" href="/assets/js/11.597103f4.js"><link rel="prefetch" href="/assets/js/12.01e326a5.js"><link rel="prefetch" href="/assets/js/13.6937eabc.js"><link rel="prefetch" href="/assets/js/14.0e95ab13.js"><link rel="prefetch" href="/assets/js/15.43c0e778.js"><link rel="prefetch" href="/assets/js/16.8c75ae64.js"><link rel="prefetch" href="/assets/js/17.02d12878.js"><link rel="prefetch" href="/assets/js/18.6b597676.js"><link rel="prefetch" href="/assets/js/19.524d893b.js"><link rel="prefetch" href="/assets/js/20.11686f52.js"><link rel="prefetch" href="/assets/js/21.ad025f0d.js"><link rel="prefetch" href="/assets/js/22.dca96777.js"><link rel="prefetch" href="/assets/js/23.121a28ab.js"><link rel="prefetch" href="/assets/js/24.99537c05.js"><link rel="prefetch" href="/assets/js/25.8f31fa14.js"><link rel="prefetch" href="/assets/js/26.a121c6cc.js"><link rel="prefetch" href="/assets/js/27.a57ec579.js"><link rel="prefetch" href="/assets/js/28.3f009b45.js"><link rel="prefetch" href="/assets/js/29.9c269e5b.js"><link rel="prefetch" href="/assets/js/31.ed454542.js"><link rel="prefetch" href="/assets/js/32.5f77ac76.js"><link rel="prefetch" href="/assets/js/33.3b921274.js"><link rel="prefetch" href="/assets/js/34.2e2dd8bc.js"><link rel="prefetch" href="/assets/js/35.457382a4.js"><link rel="prefetch" href="/assets/js/36.097474f8.js"><link rel="prefetch" href="/assets/js/37.2914dab3.js"><link rel="prefetch" href="/assets/js/38.bd900eff.js"><link rel="prefetch" href="/assets/js/39.00b0bb76.js"><link rel="prefetch" href="/assets/js/40.6d5aae82.js"><link rel="prefetch" href="/assets/js/41.e00929aa.js"><link rel="prefetch" href="/assets/js/42.b0c12805.js"><link rel="prefetch" href="/assets/js/43.7a60ce77.js"><link rel="prefetch" href="/assets/js/44.adf74ab9.js"><link rel="prefetch" href="/assets/js/45.36b6b8e2.js"><link rel="prefetch" href="/assets/js/46.a254f56a.js"><link rel="prefetch" href="/assets/js/47.aec9ad68.js"><link rel="prefetch" href="/assets/js/48.e3477ba7.js"><link rel="prefetch" href="/assets/js/49.5d974cde.js"><link rel="prefetch" href="/assets/js/5.c7e63593.js"><link rel="prefetch" href="/assets/js/50.c71471a2.js"><link rel="prefetch" href="/assets/js/51.de15920e.js"><link rel="prefetch" href="/assets/js/52.1eabf9c1.js"><link rel="prefetch" href="/assets/js/53.ada4082c.js"><link rel="prefetch" href="/assets/js/54.985c146e.js"><link rel="prefetch" href="/assets/js/55.33da5078.js"><link rel="prefetch" href="/assets/js/56.8b899006.js"><link rel="prefetch" href="/assets/js/57.f7ea6441.js"><link rel="prefetch" href="/assets/js/58.55ca22b7.js"><link rel="prefetch" href="/assets/js/59.3b16a882.js"><link rel="prefetch" href="/assets/js/6.8843ac12.js"><link rel="prefetch" href="/assets/js/60.7365ec6c.js"><link rel="prefetch" href="/assets/js/61.0508510a.js"><link rel="prefetch" href="/assets/js/62.8c3a0bf0.js"><link rel="prefetch" href="/assets/js/63.99503945.js"><link rel="prefetch" href="/assets/js/64.1193b17d.js"><link rel="prefetch" href="/assets/js/65.40a7b476.js"><link rel="prefetch" href="/assets/js/66.c95c74fb.js"><link rel="prefetch" href="/assets/js/67.dcc1ce00.js"><link rel="prefetch" href="/assets/js/68.e8aeba6d.js"><link rel="prefetch" href="/assets/js/69.13b69234.js"><link rel="prefetch" href="/assets/js/7.cda98f34.js"><link rel="prefetch" href="/assets/js/70.2308210c.js"><link rel="prefetch" href="/assets/js/71.bdac7c88.js"><link rel="prefetch" href="/assets/js/72.d5e7dabc.js"><link rel="prefetch" href="/assets/js/73.f1cec72d.js"><link rel="prefetch" href="/assets/js/74.13cbda62.js"><link rel="prefetch" href="/assets/js/75.5ec77696.js"><link rel="prefetch" href="/assets/js/76.e80c98fb.js"><link rel="prefetch" href="/assets/js/77.edf10bf3.js"><link rel="prefetch" href="/assets/js/78.9472aec2.js"><link rel="prefetch" href="/assets/js/79.2f59f6d2.js"><link rel="prefetch" href="/assets/js/8.64e66a3d.js"><link rel="prefetch" href="/assets/js/80.9d9b311d.js"><link rel="prefetch" href="/assets/js/81.112c831f.js"><link rel="prefetch" href="/assets/js/82.e98222ae.js"><link rel="prefetch" href="/assets/js/83.a7741563.js"><link rel="prefetch" href="/assets/js/84.47f9ec86.js"><link rel="prefetch" href="/assets/js/85.4b288089.js"><link rel="prefetch" href="/assets/js/86.d01d1b2a.js"><link rel="prefetch" href="/assets/js/87.26f71539.js"><link rel="prefetch" href="/assets/js/88.0cdca4ad.js"><link rel="prefetch" href="/assets/js/89.fca9f86b.js"><link rel="prefetch" href="/assets/js/9.8fcc4a9b.js"><link rel="prefetch" href="/assets/js/90.49e1e9ad.js"><link rel="prefetch" href="/assets/js/91.58ec2d07.js"><link rel="prefetch" href="/assets/js/92.0da2a72c.js"><link rel="prefetch" href="/assets/js/93.9d312aaf.js"><link rel="prefetch" href="/assets/js/94.e94db684.js"><link rel="prefetch" href="/assets/js/95.ed2aa34a.js"><link rel="prefetch" href="/assets/js/96.6a2e264d.js"><link rel="prefetch" href="/assets/js/97.8a055f18.js"><link rel="prefetch" href="/assets/js/98.1284385e.js"><link rel="prefetch" href="/assets/js/99.830ddc7a.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.3ceaf8af.js">
    <link rel="stylesheet" href="/assets/css/0.styles.35477964.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container"><div><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/head.png" alt="Black House" class="logo"> <span class="site-name">Black House</span></a> <div class="links"><div class="color-picker"><a href="#" class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><!----> <div class="dark-theme-options toggle-option"><label for="dark-theme-toggle">Enable Dark Theme?</label> <input id="dark-theme-toggle" type="checkbox" checked="checked"></div></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/Design.html" class="nav-link"><i class="iconfont undefined"></i>
  Design
</a></li><li class="dropdown-item"><!----> <a href="/category/Framework.html" class="nav-link"><i class="iconfont undefined"></i>
  Framework
</a></li><li class="dropdown-item"><!----> <a href="/category/Spring.html" class="nav-link"><i class="iconfont undefined"></i>
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/category/Issue.html" class="nav-link"><i class="iconfont undefined"></i>
  Issue
</a></li><li class="dropdown-item"><!----> <a href="/category/Java.html" class="nav-link"><i class="iconfont undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/category/Mac.html" class="nav-link"><i class="iconfont undefined"></i>
  Mac
</a></li><li class="dropdown-item"><!----> <a href="/category/Other.html" class="nav-link"><i class="iconfont undefined"></i>
  Other
</a></li><li class="dropdown-item"><!----> <a href="/category/Middleware.html" class="nav-link"><i class="iconfont undefined"></i>
  Middleware
</a></li><li class="dropdown-item"><!----> <a href="/category/NoSQL.html" class="nav-link"><i class="iconfont undefined"></i>
  NoSQL
</a></li><li class="dropdown-item"><!----> <a href="/category/Python.html" class="nav-link"><i class="iconfont undefined"></i>
  Python
</a></li><li class="dropdown-item"><!----> <a href="/category/Tools.html" class="nav-link"><i class="iconfont undefined"></i>
  Tools
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/dong4j" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/Design.html" class="nav-link"><i class="iconfont undefined"></i>
  Design
</a></li><li class="dropdown-item"><!----> <a href="/category/Framework.html" class="nav-link"><i class="iconfont undefined"></i>
  Framework
</a></li><li class="dropdown-item"><!----> <a href="/category/Spring.html" class="nav-link"><i class="iconfont undefined"></i>
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/category/Issue.html" class="nav-link"><i class="iconfont undefined"></i>
  Issue
</a></li><li class="dropdown-item"><!----> <a href="/category/Java.html" class="nav-link"><i class="iconfont undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/category/Mac.html" class="nav-link"><i class="iconfont undefined"></i>
  Mac
</a></li><li class="dropdown-item"><!----> <a href="/category/Other.html" class="nav-link"><i class="iconfont undefined"></i>
  Other
</a></li><li class="dropdown-item"><!----> <a href="/category/Middleware.html" class="nav-link"><i class="iconfont undefined"></i>
  Middleware
</a></li><li class="dropdown-item"><!----> <a href="/category/NoSQL.html" class="nav-link"><i class="iconfont undefined"></i>
  NoSQL
</a></li><li class="dropdown-item"><!----> <a href="/category/Python.html" class="nav-link"><i class="iconfont undefined"></i>
  Python
</a></li><li class="dropdown-item"><!----> <a href="/category/Tools.html" class="nav-link"><i class="iconfont undefined"></i>
  Tools
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/dong4j" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Java 8 的元空间</span> <!----></p> <!----></section></li></ul> </aside> <div><main class="page reco-hide"> <div class="page-title"><h1>Java 8 的元空间</h1> <hr> <div data-v-0b496ca7><i class="iconfont reco-account" data-v-0b496ca7><span data-v-0b496ca7>dong4j</span></i> <i class="iconfont reco-date" data-v-0b496ca7><span data-v-0b496ca7>1/13/2015</span></i> <!----> <i class="iconfont reco-tag tags" data-v-0b496ca7><span class="tag-item" data-v-0b496ca7>
      JavaSE
    </span></i></div></div> <div class="content__default"><div class="tip custom-block"><p>方法区是 JVM 的规范, 永久代（PermGen space）是 HotSpot 对这种规范的实现, 在 JDK 1.8 中,  HotSpot 已经没有 <code>PermGen space</code> 这个区间了, 取而代之的是 Metaspace（元空间）.</p></div> <p>Java 6 中的堆结构是这样的:</p> <p><img src="http://qiniu.dong4j.info/2019-07-02-2000.." alt=""></p> <h3 id="持久代"><a href="#持久代" aria-hidden="true" class="header-anchor">#</a> 持久代</h3> <p>持久代中包含了虚拟机中所有可通过反射获取到的数据, 比如 Class 和 Method 对象. 不同的 Java 虚拟机之间可能会进行类共享, 因此持久代又分为只读区和读写区.</p> <p>JVM 用于描述应用程序中用到的类和方法的元数据也存储在持久代中. JVM 运行时会用到多少持久代的空间取决于应用程序用到了多少类. 除此之外, Java SE 库中的类和方法也都存储在这里.</p> <p>如果 JVM 发现有的类已经不再需要了, 它会去回收（卸载）这些类, 将它们的空间释放出来给其它类使用. Full GC 会进行持久代的回收.</p> <ul><li>JVM 中类的元数据在 Java 堆中的存储区域.</li> <li>Java 类对应的 HotSpot 虚拟机中的内部表示也存储在这里.</li> <li>类的层级信息, 字段, 名字.</li> <li>方法的编译信息及字节码.</li> <li>变量</li> <li>常量池和符号解析</li></ul> <h4 id="持久代的大小"><a href="#持久代的大小" aria-hidden="true" class="header-anchor">#</a> 持久代的大小</h4> <ul><li>它的上限是 MaxPermSize, 默认是 64M</li> <li>Java 堆中的连续区域 : 如果存储在非连续的堆空间中的话, 要定位出持久代到新对象的引用非常复杂并且耗时. 卡表（card table）, 是一种记忆集（Remembered Set）, 它用来记录某个内存代中普通对象指针（oops）的修改.</li> <li>持久代用完后, 会抛出 OutOfMemoryError &quot;PermGen space&quot; 异常. 解决方案: 应用程序清理引用来触发类卸载；增加 MaxPermSize 的大小.</li> <li>需要多大的持久代空间取决于类的数量, 方法的大小, 以及常量池的大小.</li></ul> <h4 id="为什么移除持久代"><a href="#为什么移除持久代" aria-hidden="true" class="header-anchor">#</a> 为什么移除持久代</h4> <ul><li>它的大小是在启动时固定好的——很难进行调优. -XX:MaxPermSize, 设置成多少好呢？</li> <li>HotSpot 的内部类型也是 Java 对象: 它可能会在 Full GC 中被移动, 同时它对应用不透明, 且是非强类型的, 难以跟踪调试, 还需要存储元数据的元数据信息（meta-metadata）.</li> <li>简化 Full GC: 每一个回收器有专门的元数据迭代器.</li> <li>可以在 GC 不进行暂停的情况下并发地释放类数据.</li> <li>使得原来受限于持久代的一些改进未来有可能实现</li></ul> <h4 id="那么-jvm-的元数据都去哪儿了？"><a href="#那么-jvm-的元数据都去哪儿了？" aria-hidden="true" class="header-anchor">#</a> 那么 JVM 的元数据都去哪儿了？</h4> <p><img src="http://qiniu.dong4j.info/2019-07-02-2000.." alt=""></p> <h3 id="元空间-metaspace"><a href="#元空间-metaspace" aria-hidden="true" class="header-anchor">#</a> 元空间 (metaspace)</h3> <p>持久代的空间被彻底地删除了, 它被一个叫元空间的区域所替代了. 持久代删除了之后, 很明显, JVM 会忽略 PermSize 和 MaxPermSize 这两个参数, 还有就是你再也看不到 java.lang.OutOfMemoryError: PermGen error 的异常了.</p> <p>JDK 8 的 HotSpot JVM 现在使用的是本地内存来表示类的元数据, 这个区域就叫做元空间.</p> <p>元空间的特点:</p> <ul><li>充分利用了 Java 语言规范中的好处: 类及相关的元数据的生命周期与类加载器的一致.</li> <li>每个加载器有专门的存储空间</li> <li>只进行线性分配</li> <li>不会单独回收某个类</li> <li>省掉了 GC 扫描及压缩的时间</li> <li>元空间里的对象的位置是固定的</li> <li>如果 GC 发现某个类加载器不再存活了, 会把相关的空间整个回收掉</li></ul> <h4 id="元空间的内存分配模型"><a href="#元空间的内存分配模型" aria-hidden="true" class="header-anchor">#</a> 元空间的内存分配模型</h4> <ul><li>绝大多数的类元数据的空间都从本地内存中分配</li> <li>用来描述类元数据的类也被删除了</li> <li>分元数据分配了多个虚拟内存空间</li> <li>给每个类加载器分配一个内存块的列表. 块的大小取决于类加载器的类型; sun / 反射 / 代理对应的类加载器的块会小一些</li> <li>归还内存块, 释放内存块列表</li> <li>一旦元空间的数据被清空了, 虚拟内存的空间会被回收掉</li> <li>减少碎片的策略</li></ul> <p>我们来看下 JVM 是如何给元数据分配虚拟内存的空间的</p> <p><img src="http://qiniu.dong4j.info/2019-07-02-2000.." alt=""></p> <p>你可以看到虚拟内存空间是如何分配的 (vs1,vs2,vs3) , 以及类加载器的内存块是如何分配的. CL 是 Class Loader 的缩写.</p> <h4 id="理解-mark-和-klass-指针"><a href="#理解-mark-和-klass-指针" aria-hidden="true" class="header-anchor">#</a> 理解_mark 和_klass 指针</h4> <p>要想理解下面这张图, 你得搞清楚这些指针都是什么东西.</p> <p>JVM 中, 每个对象都有一个指向它自身类的指针, 不过这个指针只是指向具体的实现类, 而不是接口或者抽象类.</p> <p>对于 32 位的 JVM:</p> <p>_mark : 4 字节常量</p> <p>_klass: 指向类的 4 字节指针 对象的内存布局中的第二个字段 (_klass, 在 32 位 JVM 中, 相对对象在内存中的位置的偏移量是 4, 64 位的是 8) 指向的是内存中对象的类定义.</p> <p>64 位的 JVM:</p> <p>_mark : 8 字节常量</p> <p>_klass: 指向类的 8 字节的指针</p> <p>开启了指针压缩的 64 位 JVM:  _mark : 8 字节常量</p> <p>_klass: 指向类的 4 字节的指针</p> <h4 id="java-对象的内存布局"><a href="#java-对象的内存布局" aria-hidden="true" class="header-anchor">#</a> Java 对象的内存布局</h4> <p><img src="http://qiniu.dong4j.info/2019-07-02-2000.." alt=""></p> <p>类指针压缩空间（Compressed Class Pointer Space）</p> <p>只有是 64 位平台上启用了类指针压缩才会存在这个区域. 对于 64 位平台, 为了压缩 JVM 对象中的_klass 指针的大小, 引入了类指针压缩空间（Compressed Class Pointer Space）.</p> <p><img src="http://qiniu.dong4j.info/2019-07-02-2000.." alt=""></p> <p>压缩指针后的内存布局</p> <p><img src="http://qiniu.dong4j.info/2019-07-02-2000.." alt=""></p> <p>指针压缩概要</p> <ul><li><p>64 位平台上默认打开</p></li> <li><p>使用 - XX:+UseCompressedOops 压缩对象指针 &quot;oops&quot; 指的是普通对象指针 (&quot;ordinary&quot; object pointers).  Java 堆中对象指针会被压缩成 32 位.  使用堆基地址（如果堆在低 26G 内存中的话, 基地址为 0）</p></li> <li><p>使用 - XX:+UseCompressedClassPointers 选项来压缩类指针</p></li> <li><p>对象中指向类元数据的指针会被压缩成 32 位</p></li> <li><p>类指针压缩空间会有一个基地址</p></li></ul> <h4 id="元空间和类指针压缩空间的区别"><a href="#元空间和类指针压缩空间的区别" aria-hidden="true" class="header-anchor">#</a> 元空间和类指针压缩空间的区别</h4> <ul><li><p>类指针压缩空间只包含类的元数据, 比如 InstanceKlass, ArrayKlass 仅当打开了 UseCompressedClassPointers 选项才生效 为了提高性能, Java 中的虚方法表也存放到这里 这里到底存放哪些元数据的类型, 目前仍在减少</p></li> <li><p>元空间包含类的其它比较大的元数据, 比如方法, 字节码, 常量池等.</p></li></ul> <h3 id="元空间的调优"><a href="#元空间的调优" aria-hidden="true" class="header-anchor">#</a> 元空间的调优</h3> <p>使用 - XX:MaxMetaspaceSize 参数可以设置元空间的最大值, 默认是没有上限的, 也就是说你的系统内存上限是多少它就是多少. -XX:MetaspaceSize 选项指定的是元空间的初始大小, 如果没有指定的话, 元空间会根据应用程序运行时的需要动态地调整大小.</p> <h4 id="maxmetaspacesize-的调优"><a href="#maxmetaspacesize-的调优" aria-hidden="true" class="header-anchor">#</a> MaxMetaspaceSize 的调优</h4> <ul><li>-XX:MaxMetaspaceSize={unlimited}</li> <li>元空间的大小受限于你机器的内存</li> <li>限制类的元数据使用的内存大小, 以免出现虚拟内存切换以及本地内存分配失败. 如果怀疑有类加载器出现泄露, 应当使用这个参数；32 位机器上, 如果地址空间可能会被耗尽, 也应当设置这个参数.</li> <li>元空间的初始大小是 21M——这是 GC 的初始的高水位线, 超过这个大小会进行 Full GC 来进行类的回收.</li> <li>如果启动后 GC 过于频繁, 请将该值设置得大一些</li> <li>可以设置成和持久代一样的大小, 以便推迟 GC 的执行时间</li></ul> <h4 id="compressedclassspacesize-的调优"><a href="#compressedclassspacesize-的调优" aria-hidden="true" class="header-anchor">#</a> CompressedClassSpaceSize 的调优</h4> <ul><li>只有当 - XX:+UseCompressedClassPointers 开启了才有效</li> <li>-XX:CompressedClassSpaceSize=1G</li> <li>由于这个大小在启动的时候就固定了的, 因此最好设置得大点.</li> <li>没有使用到的话不要进行设置</li> <li>JVM 后续可能会让这个区可以动态的增长. 不需要是连续的区域, 只要从基地址可达就行；可能会将更多的类元信息放回到元空间中；未来会基于 PredictedLoadedClassCount 的值来自动的设置该空间的大小</li></ul> <h4 id="元空间的一些工具"><a href="#元空间的一些工具" aria-hidden="true" class="header-anchor">#</a> 元空间的一些工具</h4> <ul><li>jmap -permstat 改成了 jmap -clstats. 它用来打印 Java 堆的类加载器的统计数据. 对每一个类加载器, 会输出它的名字, 是否存活, 地址, 父类加载器, 以及它已经加载的类的数量及大小. 除此之外, 驻留的字符串（intern）的数量及大小也会打印出来.</li> <li>jstat -gc, 这个命令输出的是元空间的信息而非持久代的</li> <li>jcmd GC.class_stats 提供类元数据大小的详细信息. 使用这个功能启动程序时需要加上 - XX:+UnlockDiagnosticVMOptions 选项.</li></ul> <h4 id="提高-gc-的性能"><a href="#提高-gc-的性能" aria-hidden="true" class="header-anchor">#</a> 提高 GC 的性能</h4> <p>如果你理解了元空间的概念, 很容易发现 GC 的性能得到了提升.</p> <ul><li>Full GC 中, 元数据指向元数据的那些指针都不用再扫描了. 很多复杂的元数据扫描的代码（尤其是 CMS 里面的那些）都删除了.</li> <li>元空间只有少量的指针指向 Java 堆. 这包括: 类的元数据中指向 java/lang/Class 实例的指针; 数组类的元数据中, 指向 java/lang/Class 集合的指针.</li> <li>没有元数据压缩的开销</li> <li>减少了根对象的扫描（不再扫描虚拟机里面的已加载类的字典以及其它的内部哈希表）</li> <li>减少了 Full GC 的时间</li> <li>G1 回收器中, 并发标记阶段完成后可以进行类的卸载</li></ul> <h4 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h4> <ul><li>Hotspot 中的元数据现在存储到了元空间里. mmap 中的内存块的生命周期与类加载器的一致.</li> <li>类指针压缩空间（Compressed class pointer space）目前仍然是固定大小的, 但它的空间较大</li> <li>可以进行参数的调优, 不过这不是必需的.</li> <li>未来可能会增加其它的优化及新特性. 比如,  应用程序类数据共享；新生代 GC 优化, G1 回收器进行类的回收；减少元数据的大小, 以及 JVM 内部对象的内存占用量.</li></ul></div> <!----> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">7/3/2019, 6:17:56 PM</span></div></footer> <!----> </main> <div class="valine-wrapper" data-v-0162251c><div id="valine" data-v-0162251c></div></div></div> <div class="back-to-ceiling" style="right:1rem;bottom:3rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;background-color:rgba(231, 234, 241,.5);display:none;" data-v-d0bfeaa4 data-v-d0bfeaa4><i class="iconfont reco-up" data-v-d0bfeaa4></i></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.23d4d300.js" defer></script><script src="/assets/js/4.28fd9624.js" defer></script><script src="/assets/js/1.928d15b1.js" defer></script><script src="/assets/js/30.168f09f3.js" defer></script>
  </body>
</html>

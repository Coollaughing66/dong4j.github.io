<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>捋一捋 async-tool 的问题 | Black House</title>
    <meta name="description" content="代码千万行, 注释第一行, 编码不规范, 同事两行泪.">
    <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.35477964.css" as="style"><link rel="preload" href="/assets/js/app.23d4d300.js" as="script"><link rel="preload" href="/assets/js/4.28fd9624.js" as="script"><link rel="preload" href="/assets/js/1.928d15b1.js" as="script"><link rel="preload" href="/assets/js/24.99537c05.js" as="script"><link rel="prefetch" href="/assets/js/10.c2349238.js"><link rel="prefetch" href="/assets/js/100.031b764c.js"><link rel="prefetch" href="/assets/js/11.597103f4.js"><link rel="prefetch" href="/assets/js/12.01e326a5.js"><link rel="prefetch" href="/assets/js/13.6937eabc.js"><link rel="prefetch" href="/assets/js/14.0e95ab13.js"><link rel="prefetch" href="/assets/js/15.43c0e778.js"><link rel="prefetch" href="/assets/js/16.8c75ae64.js"><link rel="prefetch" href="/assets/js/17.02d12878.js"><link rel="prefetch" href="/assets/js/18.6b597676.js"><link rel="prefetch" href="/assets/js/19.524d893b.js"><link rel="prefetch" href="/assets/js/20.11686f52.js"><link rel="prefetch" href="/assets/js/21.ad025f0d.js"><link rel="prefetch" href="/assets/js/22.dca96777.js"><link rel="prefetch" href="/assets/js/23.121a28ab.js"><link rel="prefetch" href="/assets/js/25.8f31fa14.js"><link rel="prefetch" href="/assets/js/26.a121c6cc.js"><link rel="prefetch" href="/assets/js/27.a57ec579.js"><link rel="prefetch" href="/assets/js/28.3f009b45.js"><link rel="prefetch" href="/assets/js/29.9c269e5b.js"><link rel="prefetch" href="/assets/js/30.168f09f3.js"><link rel="prefetch" href="/assets/js/31.ed454542.js"><link rel="prefetch" href="/assets/js/32.5f77ac76.js"><link rel="prefetch" href="/assets/js/33.3b921274.js"><link rel="prefetch" href="/assets/js/34.2e2dd8bc.js"><link rel="prefetch" href="/assets/js/35.457382a4.js"><link rel="prefetch" href="/assets/js/36.097474f8.js"><link rel="prefetch" href="/assets/js/37.2914dab3.js"><link rel="prefetch" href="/assets/js/38.bd900eff.js"><link rel="prefetch" href="/assets/js/39.00b0bb76.js"><link rel="prefetch" href="/assets/js/40.6d5aae82.js"><link rel="prefetch" href="/assets/js/41.e00929aa.js"><link rel="prefetch" href="/assets/js/42.b0c12805.js"><link rel="prefetch" href="/assets/js/43.7a60ce77.js"><link rel="prefetch" href="/assets/js/44.adf74ab9.js"><link rel="prefetch" href="/assets/js/45.36b6b8e2.js"><link rel="prefetch" href="/assets/js/46.a254f56a.js"><link rel="prefetch" href="/assets/js/47.aec9ad68.js"><link rel="prefetch" href="/assets/js/48.e3477ba7.js"><link rel="prefetch" href="/assets/js/49.5d974cde.js"><link rel="prefetch" href="/assets/js/5.c7e63593.js"><link rel="prefetch" href="/assets/js/50.c71471a2.js"><link rel="prefetch" href="/assets/js/51.de15920e.js"><link rel="prefetch" href="/assets/js/52.1eabf9c1.js"><link rel="prefetch" href="/assets/js/53.ada4082c.js"><link rel="prefetch" href="/assets/js/54.985c146e.js"><link rel="prefetch" href="/assets/js/55.33da5078.js"><link rel="prefetch" href="/assets/js/56.8b899006.js"><link rel="prefetch" href="/assets/js/57.f7ea6441.js"><link rel="prefetch" href="/assets/js/58.55ca22b7.js"><link rel="prefetch" href="/assets/js/59.3b16a882.js"><link rel="prefetch" href="/assets/js/6.8843ac12.js"><link rel="prefetch" href="/assets/js/60.7365ec6c.js"><link rel="prefetch" href="/assets/js/61.0508510a.js"><link rel="prefetch" href="/assets/js/62.8c3a0bf0.js"><link rel="prefetch" href="/assets/js/63.99503945.js"><link rel="prefetch" href="/assets/js/64.1193b17d.js"><link rel="prefetch" href="/assets/js/65.40a7b476.js"><link rel="prefetch" href="/assets/js/66.c95c74fb.js"><link rel="prefetch" href="/assets/js/67.dcc1ce00.js"><link rel="prefetch" href="/assets/js/68.e8aeba6d.js"><link rel="prefetch" href="/assets/js/69.13b69234.js"><link rel="prefetch" href="/assets/js/7.cda98f34.js"><link rel="prefetch" href="/assets/js/70.2308210c.js"><link rel="prefetch" href="/assets/js/71.bdac7c88.js"><link rel="prefetch" href="/assets/js/72.d5e7dabc.js"><link rel="prefetch" href="/assets/js/73.f1cec72d.js"><link rel="prefetch" href="/assets/js/74.13cbda62.js"><link rel="prefetch" href="/assets/js/75.5ec77696.js"><link rel="prefetch" href="/assets/js/76.e80c98fb.js"><link rel="prefetch" href="/assets/js/77.edf10bf3.js"><link rel="prefetch" href="/assets/js/78.9472aec2.js"><link rel="prefetch" href="/assets/js/79.2f59f6d2.js"><link rel="prefetch" href="/assets/js/8.64e66a3d.js"><link rel="prefetch" href="/assets/js/80.9d9b311d.js"><link rel="prefetch" href="/assets/js/81.112c831f.js"><link rel="prefetch" href="/assets/js/82.e98222ae.js"><link rel="prefetch" href="/assets/js/83.a7741563.js"><link rel="prefetch" href="/assets/js/84.47f9ec86.js"><link rel="prefetch" href="/assets/js/85.4b288089.js"><link rel="prefetch" href="/assets/js/86.d01d1b2a.js"><link rel="prefetch" href="/assets/js/87.26f71539.js"><link rel="prefetch" href="/assets/js/88.0cdca4ad.js"><link rel="prefetch" href="/assets/js/89.fca9f86b.js"><link rel="prefetch" href="/assets/js/9.8fcc4a9b.js"><link rel="prefetch" href="/assets/js/90.49e1e9ad.js"><link rel="prefetch" href="/assets/js/91.58ec2d07.js"><link rel="prefetch" href="/assets/js/92.0da2a72c.js"><link rel="prefetch" href="/assets/js/93.9d312aaf.js"><link rel="prefetch" href="/assets/js/94.e94db684.js"><link rel="prefetch" href="/assets/js/95.ed2aa34a.js"><link rel="prefetch" href="/assets/js/96.6a2e264d.js"><link rel="prefetch" href="/assets/js/97.8a055f18.js"><link rel="prefetch" href="/assets/js/98.1284385e.js"><link rel="prefetch" href="/assets/js/99.830ddc7a.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.3ceaf8af.js">
    <link rel="stylesheet" href="/assets/css/0.styles.35477964.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container"><div><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/head.png" alt="Black House" class="logo"> <span class="site-name">Black House</span></a> <div class="links"><div class="color-picker"><a href="#" class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><!----> <div class="dark-theme-options toggle-option"><label for="dark-theme-toggle">Enable Dark Theme?</label> <input id="dark-theme-toggle" type="checkbox" checked="checked"></div></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/Design.html" class="nav-link"><i class="iconfont undefined"></i>
  Design
</a></li><li class="dropdown-item"><!----> <a href="/category/Framework.html" class="nav-link"><i class="iconfont undefined"></i>
  Framework
</a></li><li class="dropdown-item"><!----> <a href="/category/Spring.html" class="nav-link"><i class="iconfont undefined"></i>
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/category/Issue.html" class="nav-link"><i class="iconfont undefined"></i>
  Issue
</a></li><li class="dropdown-item"><!----> <a href="/category/Java.html" class="nav-link"><i class="iconfont undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/category/Mac.html" class="nav-link"><i class="iconfont undefined"></i>
  Mac
</a></li><li class="dropdown-item"><!----> <a href="/category/Other.html" class="nav-link"><i class="iconfont undefined"></i>
  Other
</a></li><li class="dropdown-item"><!----> <a href="/category/Middleware.html" class="nav-link"><i class="iconfont undefined"></i>
  Middleware
</a></li><li class="dropdown-item"><!----> <a href="/category/NoSQL.html" class="nav-link"><i class="iconfont undefined"></i>
  NoSQL
</a></li><li class="dropdown-item"><!----> <a href="/category/Python.html" class="nav-link"><i class="iconfont undefined"></i>
  Python
</a></li><li class="dropdown-item"><!----> <a href="/category/Tools.html" class="nav-link"><i class="iconfont undefined"></i>
  Tools
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/dong4j" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/Design.html" class="nav-link"><i class="iconfont undefined"></i>
  Design
</a></li><li class="dropdown-item"><!----> <a href="/category/Framework.html" class="nav-link"><i class="iconfont undefined"></i>
  Framework
</a></li><li class="dropdown-item"><!----> <a href="/category/Spring.html" class="nav-link"><i class="iconfont undefined"></i>
  Spring
</a></li><li class="dropdown-item"><!----> <a href="/category/Issue.html" class="nav-link"><i class="iconfont undefined"></i>
  Issue
</a></li><li class="dropdown-item"><!----> <a href="/category/Java.html" class="nav-link"><i class="iconfont undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/category/Mac.html" class="nav-link"><i class="iconfont undefined"></i>
  Mac
</a></li><li class="dropdown-item"><!----> <a href="/category/Other.html" class="nav-link"><i class="iconfont undefined"></i>
  Other
</a></li><li class="dropdown-item"><!----> <a href="/category/Middleware.html" class="nav-link"><i class="iconfont undefined"></i>
  Middleware
</a></li><li class="dropdown-item"><!----> <a href="/category/NoSQL.html" class="nav-link"><i class="iconfont undefined"></i>
  NoSQL
</a></li><li class="dropdown-item"><!----> <a href="/category/Python.html" class="nav-link"><i class="iconfont undefined"></i>
  Python
</a></li><li class="dropdown-item"><!----> <a href="/category/Tools.html" class="nav-link"><i class="iconfont undefined"></i>
  Tools
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/dong4j" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>捋一捋 async-tool 的问题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/views/issue/2019/03072233.html#定位问题" class="sidebar-link">定位问题</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/issue/2019/03072233.html#追踪代码" class="sidebar-link">追踪代码</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/issue/2019/03072233.html#进入主题" class="sidebar-link">进入主题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/issue/2019/03072233.html#spring-初始化问题" class="sidebar-link">Spring 初始化问题</a></li><li class="sidebar-sub-header"><a href="/views/issue/2019/03072233.html#并发问题" class="sidebar-link">并发问题</a></li></ul></li><li><a href="/views/issue/2019/03072233.html#解决问题" class="sidebar-link">解决问题</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/issue/2019/03072233.html#为什么会出现并发问题" class="sidebar-link">为什么会出现并发问题</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/issue/2019/03072233.html#可靠的单元测试" class="sidebar-link">可靠的单元测试</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/issue/2019/03072233.html#问题总结" class="sidebar-link">问题总结</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/issue/2019/03072233.html#对于-12530-重构的想法" class="sidebar-link">对于 12530 重构的想法</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page reco-hide"> <div class="page-title"><h1>捋一捋 async-tool 的问题</h1> <hr> <div data-v-0b496ca7><i class="iconfont reco-account" data-v-0b496ca7><span data-v-0b496ca7>dong4j</span></i> <i class="iconfont reco-date" data-v-0b496ca7><span data-v-0b496ca7>3/7/2019</span></i> <!----> <i class="iconfont reco-tag tags" data-v-0b496ca7><span class="tag-item" data-v-0b496ca7>
      Issue
    </span></i></div></div> <div class="content__default"><div class="tip custom-block"><p>处理一个并发问题</p></div> <p>昨天做完精准营销的需求后, 提测版本一直连不上 MQ, 然后在本地启动后也未发现问题, 直到监听的消息队列有消息而且是<strong>大量消息</strong>时才会出现的错误:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>javax<span class="token punctuation">.</span>jms<span class="token punctuation">.</span><span class="token class-name">JMSException</span><span class="token operator">:</span> <span class="token class-name">Cannot</span> send<span class="token punctuation">,</span> channel has already failed<span class="token operator">:</span> tcp<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">172.31</span><span class="token number">.205</span><span class="token number">.58</span><span class="token operator">:</span><span class="token number">61616</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token class-name">JMSExceptionSupport</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">JMSExceptionSupport</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">62</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span><span class="token class-name">ActiveMQConnection</span><span class="token punctuation">.</span><span class="token function">syncSendPacket</span><span class="token punctuation">(</span><span class="token class-name">ActiveMQConnection</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1409</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span><span class="token class-name">ActiveMQConnection</span><span class="token punctuation">.</span><span class="token function">ensureConnectionInfoSent</span><span class="token punctuation">(</span><span class="token class-name">ActiveMQConnection</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1496</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span><span class="token class-name">ActiveMQConnection</span><span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token class-name">ActiveMQConnection</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">325</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>pool<span class="token punctuation">.</span><span class="token class-name">ConnectionPool</span>$<span class="token number">2.</span><span class="token function">makeObject</span><span class="token punctuation">(</span><span class="token class-name">ConnectionPool</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">105</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>pool<span class="token punctuation">.</span><span class="token class-name">ConnectionPool</span>$<span class="token number">2.</span><span class="token function">makeObject</span><span class="token punctuation">(</span><span class="token class-name">ConnectionPool</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">90</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>impl<span class="token punctuation">.</span><span class="token class-name">GenericKeyedObjectPool</span><span class="token punctuation">.</span><span class="token function">borrowObject</span><span class="token punctuation">(</span><span class="token class-name">GenericKeyedObjectPool</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1179</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>pool<span class="token punctuation">.</span><span class="token class-name">ConnectionPool</span><span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token class-name">ConnectionPool</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">142</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>pool<span class="token punctuation">.</span><span class="token class-name">PooledConnection</span><span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token class-name">PooledConnection</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">174</span><span class="token punctuation">)</span>
	at com<span class="token punctuation">.</span>iflytek<span class="token punctuation">.</span>musicsearch<span class="token punctuation">.</span>core<span class="token punctuation">.</span>support<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>producer<span class="token punctuation">.</span><span class="token class-name">JmsProducer</span><span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token class-name">JmsProducer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">137</span><span class="token punctuation">)</span>
	at com<span class="token punctuation">.</span>iflytek<span class="token punctuation">.</span>musicsearch<span class="token punctuation">.</span>core<span class="token punctuation">.</span>support<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>producer<span class="token punctuation">.</span><span class="token class-name">JmsProducer</span><span class="token punctuation">.</span>access$<span class="token function">100</span><span class="token punctuation">(</span><span class="token class-name">JmsProducer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">19</span><span class="token punctuation">)</span>
	at com<span class="token punctuation">.</span>iflytek<span class="token punctuation">.</span>musicsearch<span class="token punctuation">.</span>core<span class="token punctuation">.</span>support<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>producer<span class="token punctuation">.</span><span class="token class-name">JmsProducer</span>$<span class="token number">2.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">JmsProducer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">114</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">.</span><span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1149</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span><span class="token class-name">ThreadPoolExecutor</span>$<span class="token class-name">Worker</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">624</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">748</span><span class="token punctuation">)</span>
<span class="token class-name">Caused</span> by<span class="token operator">:</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>transport<span class="token punctuation">.</span><span class="token class-name">InactivityIOException</span><span class="token operator">:</span> <span class="token class-name">Cannot</span> send<span class="token punctuation">,</span> channel has already failed<span class="token operator">:</span> tcp<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">172.31</span><span class="token number">.205</span><span class="token number">.58</span><span class="token operator">:</span><span class="token number">61616</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>transport<span class="token punctuation">.</span><span class="token class-name">AbstractInactivityMonitor</span><span class="token punctuation">.</span><span class="token function">doOnewaySend</span><span class="token punctuation">(</span><span class="token class-name">AbstractInactivityMonitor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">315</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>transport<span class="token punctuation">.</span><span class="token class-name">AbstractInactivityMonitor</span><span class="token punctuation">.</span><span class="token function">oneway</span><span class="token punctuation">(</span><span class="token class-name">AbstractInactivityMonitor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">304</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>transport<span class="token punctuation">.</span><span class="token class-name">TransportFilter</span><span class="token punctuation">.</span><span class="token function">oneway</span><span class="token punctuation">(</span><span class="token class-name">TransportFilter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">85</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>transport<span class="token punctuation">.</span><span class="token class-name">WireFormatNegotiator</span><span class="token punctuation">.</span><span class="token function">oneway</span><span class="token punctuation">(</span><span class="token class-name">WireFormatNegotiator</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">104</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>transport<span class="token punctuation">.</span><span class="token class-name">MutexTransport</span><span class="token punctuation">.</span><span class="token function">oneway</span><span class="token punctuation">(</span><span class="token class-name">MutexTransport</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">68</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>transport<span class="token punctuation">.</span><span class="token class-name">ResponseCorrelator</span><span class="token punctuation">.</span><span class="token function">asyncRequest</span><span class="token punctuation">(</span><span class="token class-name">ResponseCorrelator</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">81</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>transport<span class="token punctuation">.</span><span class="token class-name">ResponseCorrelator</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token class-name">ResponseCorrelator</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">86</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span><span class="token class-name">ActiveMQConnection</span><span class="token punctuation">.</span><span class="token function">syncSendPacket</span><span class="token punctuation">(</span><span class="token class-name">ActiveMQConnection</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1380</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">13</span> more
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>因此开始走上 debug 这条不归路...</p> <h2 id="定位问题"><a href="#定位问题" aria-hidden="true" class="header-anchor">#</a> 定位问题</h2> <p>上面报的错误, 一开始怀疑是 ActiveMQ 消费者连接断开, 导致发送不了消息, 因此一来就开始 debug <code>sendMsg()</code> 这个最终发送消息的方法.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> queue<span class="token punctuation">,</span> <span class="token class-name">String</span> jsonStr<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Connection</span> connection <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">Session</span> session <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">MessageProducer</span> producer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//从连接池工厂中获取一个连接</span>
        connection <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connectionFactory<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//false 参数表示 为非事务型消息，后面的参数表示消息的确认类型</span>
        session <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">,</span> <span class="token class-name">Session</span><span class="token punctuation">.</span>AUTO_ACKNOWLEDGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//PTP消息方式</span>
        <span class="token class-name">Destination</span> destination <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//Destination is superinterface of Queue</span>
        producer <span class="token operator">=</span> <span class="token function">createProducer</span><span class="token punctuation">(</span>producer<span class="token punctuation">,</span> session<span class="token punctuation">,</span> destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//map convert to javax message</span>
        <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token function">getMessage</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> jsonStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;send message, producer = {}&quot;</span><span class="token punctuation">,</span> producer<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token function">closeSession</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">closeConnection</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>先说这个方法的问题:</p> <p>当每次发送消息时都会创建一个 ActiveMQ 连接, 然后创建一个 session, 最后创建一个 producer, 消息发送完成后关闭连接.
频繁的创建关闭连接将消耗大量系统资源, 降低性能, 因此一般使用连接池来保存连接.</p> <p><img src="http://qiniu.dong4j.info/2019-07-04-15520024926324.jpg" alt="-w999"> <img src="http://qiniu.dong4j.info/2019-07-04-15520025329609.jpg" alt="-w974"></p> <p>从 debug 日志中也可以看出来, 连接后又 close 了.</p> <p>因此将 Connection, Session, Producer 进行复用. (这也是 ActiveMQ 官方推荐的做法).</p> <p>将创建 producer 的整个操作放到 init() 中, 只执行一次.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">MessageProducer</span> producer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">//设置JAVA线程池</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>threadPoolSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//ActiveMQ的连接工厂</span>
    <span class="token class-name">ActiveMQConnectionFactory</span> actualConnectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveMQConnectionFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>userName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>password<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    actualConnectionFactory<span class="token punctuation">.</span><span class="token function">setUseAsyncSend</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>useAsyncSendForJMS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//Active中的连接池工厂</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>connectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PooledConnectionFactory</span><span class="token punctuation">(</span>actualConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>connectionFactory<span class="token punctuation">.</span><span class="token function">setCreateConnectionOnStartup</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>connectionFactory<span class="token punctuation">.</span><span class="token function">setMaxConnections</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>maxConnections<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>connectionFactory<span class="token punctuation">.</span><span class="token function">setMaximumActiveSessionPerConnection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>maximumActiveSessionPerConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Connection</span> connection<span class="token punctuation">;</span>
    <span class="token class-name">Session</span> session<span class="token punctuation">;</span>
    <span class="token comment">//从连接池工厂中获取一个连接</span>
    connection <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connectionFactory<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//false 参数表示 为非事务型消息，后面的参数表示消息的确认类型</span>
    session <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span>FALSE<span class="token punctuation">,</span> <span class="token class-name">Session</span><span class="token punctuation">.</span>AUTO_ACKNOWLEDGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//PTP消息方式</span>
    <span class="token class-name">Destination</span> destination <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">createQueue</span><span class="token punctuation">(</span><span class="token string">&quot;BiUserStatusSignal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//Destination is superinterface of Queue</span>
    producer <span class="token operator">=</span> <span class="token function">createProducer</span><span class="token punctuation">(</span>producer<span class="token punctuation">,</span> session<span class="token punctuation">,</span> destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>重写 <code>sendMsg()</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token class-name">String</span> jsonStr<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">ActiveMQTextMessage</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActiveMQTextMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    message<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;send&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>当我以为就这么容易的把问题解决的时候, 新的错误又来了(如果问题就这么解决了, 我也不会写这个文档了).</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Caused</span> by<span class="token operator">:</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>transport<span class="token punctuation">.</span><span class="token class-name">InactivityIOException</span><span class="token operator">:</span> <span class="token class-name">Cannot</span> send<span class="token punctuation">,</span> channel has already failed<span class="token operator">:</span> tcp<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">172.31</span><span class="token number">.205</span><span class="token number">.58</span><span class="token operator">:</span><span class="token number">61616</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>transport<span class="token punctuation">.</span><span class="token class-name">AbstractInactivityMonitor</span><span class="token punctuation">.</span><span class="token function">doOnewaySend</span><span class="token punctuation">(</span><span class="token class-name">AbstractInactivityMonitor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">315</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>transport<span class="token punctuation">.</span><span class="token class-name">AbstractInactivityMonitor</span><span class="token punctuation">.</span><span class="token function">oneway</span><span class="token punctuation">(</span><span class="token class-name">AbstractInactivityMonitor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">304</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>transport<span class="token punctuation">.</span><span class="token class-name">WireFormatNegotiator</span><span class="token punctuation">.</span><span class="token function">sendWireFormat</span><span class="token punctuation">(</span><span class="token class-name">WireFormatNegotiator</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">168</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>transport<span class="token punctuation">.</span><span class="token class-name">WireFormatNegotiator</span><span class="token punctuation">.</span><span class="token function">sendWireFormat</span><span class="token punctuation">(</span><span class="token class-name">WireFormatNegotiator</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">84</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>transport<span class="token punctuation">.</span><span class="token class-name">WireFormatNegotiator</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token class-name">WireFormatNegotiator</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">74</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>transport<span class="token punctuation">.</span><span class="token class-name">TransportFilter</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token class-name">TransportFilter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">58</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>transport<span class="token punctuation">.</span><span class="token class-name">TransportFilter</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token class-name">TransportFilter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">58</span><span class="token punctuation">)</span>
	at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span><span class="token class-name">ActiveMQConnectionFactory</span><span class="token punctuation">.</span><span class="token function">createActiveMQConnection</span><span class="token punctuation">(</span><span class="token class-name">ActiveMQConnectionFactory</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">273</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">25</span> more
java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span><span class="token class-name">NullPointerException</span>
	at com<span class="token punctuation">.</span>iflytek<span class="token punctuation">.</span>musicsearch<span class="token punctuation">.</span>core<span class="token punctuation">.</span>support<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>producer<span class="token punctuation">.</span><span class="token class-name">JmsProducer</span><span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token class-name">JmsProducer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">155</span><span class="token punctuation">)</span>
	at com<span class="token punctuation">.</span>iflytek<span class="token punctuation">.</span>musicsearch<span class="token punctuation">.</span>core<span class="token punctuation">.</span>support<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>producer<span class="token punctuation">.</span><span class="token class-name">JmsProducer</span><span class="token punctuation">.</span>access$<span class="token function">100</span><span class="token punctuation">(</span><span class="token class-name">JmsProducer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">24</span><span class="token punctuation">)</span>
	at com<span class="token punctuation">.</span>iflytek<span class="token punctuation">.</span>musicsearch<span class="token punctuation">.</span>core<span class="token punctuation">.</span>support<span class="token punctuation">.</span>activemq<span class="token punctuation">.</span>producer<span class="token punctuation">.</span><span class="token class-name">JmsProducer</span>$<span class="token number">2.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">JmsProducer</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">137</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">.</span><span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1149</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span><span class="token class-name">ThreadPoolExecutor</span>$<span class="token class-name">Worker</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">624</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">748</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>这次不仅出现了 <code>NullPointerException</code>, 以前的异常还是存在, ActiveMQ 的连接依然很多</p> <p><img src="http://qiniu.dong4j.info/2019-07-04-15520036248777.jpg" alt="-w368"></p> <p>唯一改善的就是<strong>异常出现的频率降低了</strong>. 因此这个不是最根本的原因.</p> <p>那么思考一下为什么会出现 <code>NullPointerException</code>.</p> <p>上面的代码肯定是没有问题的, 除非是在<strong>多线程环境</strong>下.</p> <p>另一个很严重的问题:</p> <p><img src="http://qiniu.dong4j.info/2019-07-04-15520037941428.jpg" alt="-w897"></p> <p>😳😳 居然能有 40 多个线程池......
好了, 基本知道什么原因导致的了, **并发 + 线程池 **问题.</p> <p>看看运行时的线程:</p> <p><img src="http://qiniu.dong4j.info/2019-07-04-15520165022849.jpg" alt="-w1440"></p> <p>垃圾回收频繁, 线程数还在不断增长.....</p> <h2 id="追踪代码"><a href="#追踪代码" aria-hidden="true" class="header-anchor">#</a> 追踪代码</h2> <p>初始化 producer 的连接池就是 <code>init()</code> 的这段代码</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//设置JAVA线程池</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>threadPool <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>threadPoolSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>能初始化多个连接池,  <code>init()</code> 肯定被错误的执行了多次. 通过查看 <code>BiUserStatusTask</code> 这个类,能执行 <code>init()</code> 的也只有下面的代码了.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">JmsProducerFactory</span> jmsProducerFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JmsProducerFactory</span><span class="token punctuation">(</span>producerJmsConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
jmsProducerFactory<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>start()</code> 方法会判断 JmsProducer 是否 null, 为 null 才会调用 <code>init()</code> 来创建线程池</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>started<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//配置下发到相关组件</span>
    <span class="token function">deliverConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    started<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">deliverConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>jmsProducer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        jmsProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JmsProducer</span><span class="token punctuation">(</span>jmsConfig<span class="token punctuation">.</span><span class="token function">getBrokerURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jmsConfig<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jmsConfig<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>整个 <code>BiUserStatusTask</code> 类的代码也没有看出哪个地方会多次创建线程池. 没办法只有加日志.</p> <p><img src="http://qiniu.dong4j.info/2019-07-04-15520047474642.jpg" alt="-w718"></p> <p>问题找到了, 是进入 catch 了 😥.</p> <p><img src="http://qiniu.dong4j.info/2019-07-04-15520049296247.jpg" alt="-w945"></p> <p>原来是 <code>JsonUtil.jsonToMap(text)</code> 解析抛异常了 😰. (为什么我没有在 <code>BiUserStatusTask</code> 中打断点, 因为一直以为是 producer 发送消息的代码有问题).</p> <p>最好的 debug 方式就是<strong>日志</strong>, 因为 debug 很慢, 而且多线程的时候并不好 debug. 上面的代码在 catch 中直接就发送异常消息然后入库, 导致日志中没有错误信息.</p> <div class="tip custom-block"><p class="custom-block-title">正确的做法是</p> <p>catch 中一定要打印日志, 因为这个属于系统异常日志, 是给开发的人看的, 而需要入库的日志一般都是业务日志或者业务异常日志, 开发的时候谁再去查一下数据库有没有异常日志啊! 直接打印到日志不是更好吗? <strong>效率就是生命</strong>!</p></div> <p>也请不要把所有代码都包裹在 try-catch 里面, 最好把异常分类处理, 一个 catch 就把所有异常捕获了倒是简单, 但是不好排查问题, 也会影响执行效率.</p> <p>写代码的时候, 尽量把异常暴露出来, 不要忽略 catch. 在编码阶段就尽可能多的处理异常, 而不是上线了写到数据库, 然后统计异常数据来报警.</p> <p>以前写过些方面的问题, 估计也没人在意吧.</p> <h2 id="进入主题"><a href="#进入主题" aria-hidden="true" class="header-anchor">#</a> 进入主题</h2> <p>好了, 重点来了.</p> <p>catch 里面也会发送 MQ 消息, 会不会是这里面的问题呢? 那我们先来捋一捋 <code>LogSupportException.writeFuncExceptionLog()</code> 这个方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogSupportException</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">LogService</span> logService <span class="token operator">=</span> <span class="token class-name">LogServiceFactory</span><span class="token punctuation">.</span><span class="token function">getLogService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/**
     * 封装错误信息
     */</span> 
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">writeSupportExceptionLog</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">,</span> <span class="token class-name">String</span> componentName<span class="token punctuation">,</span> <span class="token class-name">String</span> methodName<span class="token punctuation">,</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">String</span> inputParams<span class="token punctuation">,</span> <span class="token class-name">String</span> logDesc<span class="token punctuation">,</span> <span class="token class-name">LogSupportException</span><span class="token punctuation">.</span><span class="token class-name">ErrorLevel</span> errorLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">saveException</span><span class="token punctuation">(</span>logField<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>    
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><code>writeSupportExceptionLog()</code> 是封装处理信息的处理 (性能很低, 就不吐槽了, 自己去看吧). 会调用 <code>logService.saveLog()</code> 发送异步消息.</p> <p>那么 <code>logService</code> 是哪里来的呢?</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">LogService</span> logService <span class="token operator">=</span> <span class="token class-name">LogServiceFactory</span><span class="token punctuation">.</span><span class="token function">getLogService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>是一个静态属性, 这里复习一下类的初始化顺序.</p> <div class="tip custom-block"><p>.java 被编译成 .class 被 Classloader 加载到 JVM 的时候, 首先会调用 <strong>static 代码块 <strong>和初始化 <strong>静态属性</strong> (这个看 2 者代码的顺序), 如果新创建一个对象的时候, 会先执行</strong>代码块</strong>, 然后才是<strong>构造方法</strong>. 那么问题来了, 子类父类初始化的顺序是什么呢?</p></div> <p><code>logService</code> 是一个静态属性, 会在被 JVM 加载的时候就初始化, 不管有没有创建这个类的实例.
因此我们进入到 <code>LogServiceFactory.getLogService()</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogServiceFactory</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">LogService</span> logService <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">LogService</span> logServiceB <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> initFlag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">synchronized</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>initFlag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;classpath*:applicationContext-jms.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            initFlag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">synchronized</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initLogService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>initFlag <span class="token operator">&amp;&amp;</span> logService <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">LogService</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;logServiceConcurrent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logServiceB <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">LogService</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;logServiceConcurrentB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            initFlag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>



    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">LogService</span> <span class="token function">getLogService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>initFlag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>initFlag <span class="token operator">&amp;&amp;</span> logService <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">initLogService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> logService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">LogService</span> <span class="token function">getLogServiceB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>initFlag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>initFlag <span class="token operator">&amp;&amp;</span> logServiceB <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">initLogService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> logServiceB<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>哈哈哈 熟悉吧, 使用静态代码块来初始化 Spring 容器</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">synchronized</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>initFlag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span>
                <span class="token string">&quot;classpath*:applicationContext-jms.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        initFlag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="tip custom-block"><p>其实这里使用 <code>synchronized</code> 是多余的, 因为 Classloader 从 JVM 底层上就保证了加载一个类的同步性, 避免了并发问题.</p></div> <p>记住哦, 这里是<strong>第一次</strong>使用 <code>new ClassPathXmlApplicationContext()</code> 来初始化 Spring 容器, 配置文件是 <code>applicationContext-jms.xml</code>, 在<strong>第二次</strong>的时候再说这么做存在的问题.</p> <p>那么 <code>logService</code> 从 Spring 容器中获取到了, 然后调用 <code>saveLog()</code>, 下面是 <code>saveLog()</code> 的实现:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">saveLog</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> logMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token class-name">JmsTemplateFacotry</span><span class="token punctuation">.</span><span class="token function">getJmsConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ObjectEvent</span> objectEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectEvent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> logMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">sendToMq</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> objectEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>没什么特别之处, 就是从配置中获取队列名, 然后调用 <code>sendToMq()</code>, 但是得一步一步跟代码呀, 不然怎么知道有什么问题.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> queueName <span class="token operator">=</span> <span class="token class-name">JmsTemplateFacotry</span><span class="token punctuation">.</span><span class="token function">getJmsConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>那我们就看看 <code>JmsTemplateFacotry</code> 这个类,</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JmsTemplateFacotry</span> <span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">JmsProducer</span> jmsProducer<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">JmsConsumer</span> jmsConsumer<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">JmsConfig</span> jmsConfig<span class="token punctuation">;</span>

	<span class="token keyword">static</span> <span class="token punctuation">{</span>
		<span class="token class-name">ApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span>
				<span class="token string">&quot;classpath*:applicationContext-jms.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		jmsConfig <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token class-name">JmsConfig</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;jmsTemplateConfig&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>jmsProducer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			jmsProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JmsProducer</span><span class="token punctuation">(</span>jmsConfig<span class="token punctuation">.</span><span class="token function">getBrokerURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jmsConfig<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jmsConfig<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>jmsConsumer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			jmsConsumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JmsConsumer</span><span class="token punctuation">(</span>jmsConfig<span class="token punctuation">.</span><span class="token function">getBrokerURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>jmsConfig<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>jmsConfig<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">messageSender</span><span class="token punctuation">(</span><span class="token class-name">String</span> queue<span class="token punctuation">,</span><span class="token class-name">String</span> jsonStr<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">initProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		jmsProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> jsonStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">JmsConsumer</span> <span class="token function">getJmsConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">initConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> jmsConsumer<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">JmsConfig</span> <span class="token function">getJmsConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> jmsConfig<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>😁 看见没,又是个静态代码块, <strong>第二次</strong>通过 <code>new ClassPathXmlApplicationContext()</code> 初始化 Spring 容器了哦, 配置文件还是 <code>applicationContext-jms.xml</code>.</p> <h3 id="spring-初始化问题"><a href="#spring-初始化问题" aria-hidden="true" class="header-anchor">#</a> Spring 初始化问题</h3> <p>那我们来说说两次初始化 Spring 容器的问题.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span>
				<span class="token string">&quot;classpath*:applicationContext-jms.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如果调用多次上面的方法, 将导致初始化多个 Spring 容器</p> <p>第一个:</p> <p><img src="http://qiniu.dong4j.info/2019-07-04-15520078707481.jpg" alt="-w1130"> <img src="http://qiniu.dong4j.info/2019-07-04-15520083196922.jpg" alt="-w971"></p> <p>第二个:</p> <p><img src="http://qiniu.dong4j.info/2019-07-04-15520078912104.jpg" alt="-w1022"> <img src="http://qiniu.dong4j.info/2019-07-04-15520082941976.jpg" alt="-w1081"></p> <p>也就是说同一个 bean 会被初始化 2 次.</p> <div class="tip custom-block"><p><strong>Spring 容器中的 bean 默认是单例的</strong>, 说的是<strong>同一个 Spring 容器</strong>只能存在一个相同的 bean.</p></div> <p>如果是 Spring + Spring MVC 相同的 bean 被初始化2次, 会导致事务不生效, @Value 不生效等各种各样的问题, 因此最佳实践是把 Spring 容器和 Spring MVC 容器分开加载, 每个容器只初始化对应的 bean.</p> <p>重复的初始化造成资源浪费, 而且还会导致不确定性问题出现, 所以以前老的初始化方式不可取, 正确的做法:</p> <div class="tip custom-block"><p>子包只需要提供功能即可, <strong>不要自作主张的初始化</strong>. 初始化的工作统一由部署包(需要运行的主类或 Web)来做, 通过 import 子包的 xml 配置, 统一由父容器来管理所有 bean. 这样可以统一管控, 避免随意初始化. 对于配置文件也是这个道理.</p></div> <h3 id="并发问题"><a href="#并发问题" aria-hidden="true" class="header-anchor">#</a> 并发问题</h3> <p>说了这么多, 终于要说根本的问题了.</p> <p>LogServiceAsyncJmsImpl 异步向 mq 中发送异常日志的方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">sendToMq</span><span class="token punctuation">(</span><span class="token class-name">String</span> queue<span class="token punctuation">,</span> <span class="token class-name">ObjectEvent</span> objectEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> jsonEvent <span class="token operator">=</span> objectEvent<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span>
                <span class="token operator">+</span> <span class="token class-name">JsonUtil</span><span class="token punctuation">.</span><span class="token function">objectToJson</span><span class="token punctuation">(</span>objectEvent
                <span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 注意重点代码</span>
        <span class="token class-name">JmsTemplateFacotry</span><span class="token punctuation">.</span><span class="token function">messageSender</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> jsonEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;JmsTemplateFacotry messageSender Error : {}&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>messageSender() 的实现</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">messageSender</span><span class="token punctuation">(</span><span class="token class-name">String</span> queue<span class="token punctuation">,</span><span class="token class-name">String</span> jsonStr<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">initProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		jmsProducer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> jsonStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>jmsProducer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		jmsProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JmsProducer</span><span class="token punctuation">(</span>jmsConfig<span class="token punctuation">.</span><span class="token function">getBrokerURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jmsConfig<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jmsConfig<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>	
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>messageSender()</code> 会先判断 jmsProducer 是否为 null, 为 null 就实例化一个 <code>JmsProducer</code> 对象, 实例化 <code>JmsProducer</code> 对象时, 会调用上面创建线程池的 <code>init()</code>.</p> <p>看着是个很合理的逻辑, 但是却没有考虑<strong>并发</strong>的问题. 如果是多线程, 会出现上面情况?
在分析之前, 先来复习下使用 new 创建一个对象的过程:</p> <p><img src="http://qiniu.dong4j.info/2019-07-04-NewInstance.png" alt="NewInstance"></p> <p>一个类被 JVM 加载的时机:</p> <ol><li>使用 new 关键字实例化对象的时候;</li> <li>读取或设置这个类的静态字段(被final修饰，已在编译器把结果放入常量池的静态字段除外)的时候;</li> <li>调用这个类的静态方法的时候;</li> <li>使用 java.lang.reflect 包对这个类进行反射调用的时候;</li> <li>当虚拟机启动, 直接指定一个要执行的类(也就是包含 main() 的主类);</li></ol> <p>上面是类的初始化的 5 种情况, 通过阅读 <code>JmsProducer</code> 类的代码, 我们可以确定<strong>第一次初始化</strong> <code>JmsProducer</code> 时, 就是通过 new 关键字. 因此先执行 <code>JmsProducer</code> 的初始化流程, 最终创建 <code>JmsProducer</code> 类的 class 对象.
注意哦, 如果一开始 JVM 没有加载过 <code>JmsProducer</code> 这个类, 会先对类进行加载从而生成当前类的 class 对象, 并不会生成 <code>JmsProducer</code> 类的实例对象.</p> <p>以上流程, JVM 都能保证是同步的,  因此同一个类型只能被<strong>同一个类加载器</strong>加载一次.</p> <div class="tip custom-block"><p>具体可见 「深入理解 Java 虚拟机」第 7 章</p></div> <p>只有当使用 <code>new</code> 关键字时, 如果没有被 JVM 初始化就走上面的流程, 如果已被初始化了, 才开始走<strong>类的实例化流程</strong>,</p> <p><img src="http://qiniu.dong4j.info/2019-07-04-15520104037450.jpg" alt="-w739"></p> <p>那我们来分析一下这段代码在多线程的情况下会出现上面问题:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>jmsProducer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		jmsProducer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JmsProducer</span><span class="token punctuation">(</span>jmsConfig<span class="token punctuation">.</span><span class="token function">getBrokerURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                                  jmsConfig<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                                  jmsConfig<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>	
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>先说第一个好理解的情况:</strong></p> <p>因为是多线程环境, 可能同时多个线程一起进入 if 判断逻辑, 因为 <code>jmsProducer == null</code> 为 true, 会执行多次实例化流程.</p> <p><strong>先来说说另一个复杂点的情况:</strong></p> <p>当第一次执行 <code>JmsTemplateFacotry.initProducer()</code> 时, <code>jmsProducer == null</code> .
当 <strong>线程1</strong> 进入 if 判断, 由于 <code>jmsProducer == null</code> 为 true, 会执行实例化流程.
这个时候 <strong>线程2</strong> 进入 if 判断逻辑, 由于实例化流程也需要时间, 在还没有实例化完成之前, <code>jmsProducer == null</code> 为 true, 因此 <strong>线程2</strong> 会再次实例化一个 <code>jmsProducer</code>.</p> <p>总结一下实例化对象的过程:</p> <ol><li>分配内存</li> <li>初始化对象（内存赋值）</li> <li>内存地址赋给 instance （instance != null）</li></ol> <p>以上原因也就直接<strong>导致了创建多个线程池</strong> !!!</p> <p>就这么简单, 由于多线程并发执行同一段代码. 做事要验证, 那我们来验证一下</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;jsmProducer = {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">JmsTemplateFacotry</span><span class="token punctuation">.</span><span class="token function">getJmsProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>输出:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@546dd457
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@63666aa6
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@63a9e6ce
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@65da9f79
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@3c657f0b
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@679c614
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@619ef7cf
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@27081999
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@1e4acc1c
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@52370b34
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@e8a0743
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@d882d64
....
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>对吧, 实例化了好多次吧</p> <h2 id="解决问题"><a href="#解决问题" aria-hidden="true" class="header-anchor">#</a> 解决问题</h2> <p>知道了问题所在, 解决问题就很容易了, 我们只需要保证 <code>JmsProducer</code> 是单例的就可以了</p> <p><a href="http://interview.dong4j.info/design-patterns/singleton.html" target="_blank" rel="noopener noreferrer"><strong>单例的所有写法会了吗?</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>这里只使用最可靠最简单的一种方式: <strong>枚举</strong> (第二个推荐静态内部类, 不推荐 DCL, 因为 DCL 并不完全可靠)</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * &lt;p&gt;Company: 科大讯飞股份有限公司-四川分公司&lt;/p&gt;
 * &lt;p&gt;Description: 枚举单例获取 JmsProducer, 保证只有一个实例&lt;/p&gt;
 *
 * @author dong4j
 * @date 2019-03-08 11:04
 * @email sjdong3@iflytek.com
 */</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">JmsProducerEnum</span> <span class="token punctuation">{</span>
    INSTANCE<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">JmsProducer</span> instance<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">JmsConfig</span> jmsConfig<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setJmsConfig</span><span class="token punctuation">(</span><span class="token class-name">JmsConfig</span> jmsConfig<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>jmsConfig <span class="token operator">=</span> jmsConfig<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">JmsProducer</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JmsProducer</span><span class="token punctuation">(</span>jmsConfig<span class="token punctuation">.</span><span class="token function">getBrokerURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jmsConfig<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jmsConfig<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>测试一下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">JmsProducerEnum</span> instance <span class="token operator">=</span> <span class="token class-name">JmsProducerEnum</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">;</span>
                    instance<span class="token punctuation">.</span><span class="token function">setJmsConfig</span><span class="token punctuation">(</span><span class="token class-name">JmsTemplateFacotry</span><span class="token punctuation">.</span><span class="token function">getJmsConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;jsmProducer = {}&quot;</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>输出:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@6aa6a851
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@6aa6a851
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@6aa6a851
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@6aa6a851
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@6aa6a851
com.iflytek.musicsearch.core.support.activemq.producer.JmsProducer@6aa6a851
...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>最终的修改方案</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JmsTemplateFacotry</span> <span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">JmsProducer</span> jmsProducer<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">JmsConsumer</span> jmsConsumer<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">JmsConfig</span> jmsConfig<span class="token punctuation">;</span>

	<span class="token keyword">static</span> <span class="token punctuation">{</span>
		<span class="token class-name">ApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span>
				<span class="token string">&quot;classpath*:applicationContext-jms.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		jmsConfig <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token class-name">JmsConfig</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;jmsTemplateConfig&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">JmsProducerEnum</span> instance <span class="token operator">=</span> <span class="token class-name">JmsProducerEnum</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">;</span>
		instance<span class="token punctuation">.</span><span class="token function">setJmsConfig</span><span class="token punctuation">(</span>jmsConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
		jmsProducer <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>这里还用了双重保证, JVM 保证 static 代码块只执行一次, 枚举单例再保证唯一实例.</p> <h2 id="为什么会出现并发问题"><a href="#为什么会出现并发问题" aria-hidden="true" class="header-anchor">#</a> 为什么会出现并发问题</h2> <p><code>BiUserStatusTask</code> 类中的初始化代码</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ringAdapter <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RingAdapter</span><span class="token punctuation">)</span> <span class="token class-name">DataCache</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;ringAdapter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JmsConfig</span> producerJmsConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JmsConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    producerJmsConfig<span class="token punctuation">.</span><span class="token function">setBrokerURL</span><span class="token punctuation">(</span>MQ_URL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    producerJmsConfig<span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span>MQ_USER_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    producerJmsConfig<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>MQ_USER_PASSWORD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    jmsProducerFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JmsProducerFactory</span><span class="token punctuation">(</span>producerJmsConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JmsConfig</span> consumerJmsConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JmsConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    consumerJmsConfig<span class="token punctuation">.</span><span class="token function">setBrokerURL</span><span class="token punctuation">(</span>MQ_URL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JmsConsumerFactory</span> jmsConsumerFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JmsConsumerFactory</span><span class="token punctuation">(</span>consumerJmsConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    jmsConsumerFactory<span class="token punctuation">.</span><span class="token function">getJmsConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setQueue</span><span class="token punctuation">(</span>MQ_SIGNAL_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    jmsConsumerFactory<span class="token punctuation">.</span><span class="token function">getJmsConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setQueuePrefetch</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>QUEUE_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jmsConsumerFactory<span class="token punctuation">.</span><span class="token function">getJmsConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MultiThreadMessageListener</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>MQ_THREAD<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MessageHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;执行任务：&quot;</span> <span class="token operator">+</span> taskName <span class="token operator">+</span> <span class="token string">&quot;休眠！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>MQ_SLEEP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">getUserStatusData</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        jmsConsumerFactory<span class="token punctuation">.</span><span class="token function">getJmsConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">CommonFunc</span><span class="token punctuation">.</span><span class="token function">getExceptionStack</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LogSupportException</span><span class="token punctuation">.</span><span class="token function">writeFuncExceptionLog</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">&quot;异步工具&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;run-BiUserStatusTask&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">LogSupportException</span><span class="token punctuation">.</span><span class="token class-name">ErrorLevel</span><span class="token punctuation">.</span>ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>用于接收 <code>BiUserStatusSignal</code> 队列消息的消费者也维护了一个线程池, 在 <code>MessageListener</code> 里面, 当拿到一批消息后, 会通过<strong>多线程</strong>来处理, 也就是 <code>getUserStatusData()</code> 方法, 当这个方法进入 catch 时, 最终会通过 <code>JmsTemplateFacotry</code> 来发送消息, 然后在实例化 <code>JmsProducer</code> 时没有考虑到多线程问题, 导致创建多个线程池.</p> <h2 id="可靠的单元测试"><a href="#可靠的单元测试" aria-hidden="true" class="header-anchor">#</a> 可靠的单元测试</h2> <p><code>iconmons-mq</code> 这个组件只测试了 <code>JMSProducer</code> 和 <code>JMSConsumer</code>, 却没有测试几个 Factory 类, 而且单元测试应该使用 Junit, <strong>不要使用 main()</strong>, 更不要使用 <code>System.out.println</code>.
尽量做到规范化, 可测试化.</p> <p>为什么 <code>JMSProducer</code> 测试了 100w 次也没问题, 因为是通过手动 new 的方式创建, 而且只有一次, 这样就保证了 JMSProducer 单例.</p> <p>最后进行集成测试</p> <p><img src="http://qiniu.dong4j.info/2019-07-04-15520175081138.jpg" alt="-w623"></p> <p>没再出现错误日志</p> <p>运行时数据:</p> <p><img src="http://qiniu.dong4j.info/2019-07-04-15520167800260.jpg" alt="-w1440"></p> <p>长时间运行, GC 次数少, 线程数保持在 117.</p> <h2 id="问题总结"><a href="#问题总结" aria-hidden="true" class="header-anchor">#</a> 问题总结</h2> <p><img src="http://qiniu.dong4j.info/2019-07-04-%E7%AC%94%E8%AE%B0%E6%9C%AC%20-5--9.jpg" alt="笔记本 -5--9"></p> <p>通过这次的问题修复, 我们涉及到了, 并发, 线程池, 类的初始化, 类的实例化, Spring 容器的初始化等相关知识点, 也清楚了说明了老代码中存在的一些框架问题.</p> <h2 id="对于-12530-重构的想法"><a href="#对于-12530-重构的想法" aria-hidden="true" class="header-anchor">#</a> 对于 12530 重构的想法</h2> <p>个人觉得老框架不需要改了, 真改不动了, 如果没有改完或者没有经过大量的测试, 是很容易出现问题的.</p> <p>主要是以前的代码结构太烂, 框架结构也不合理, 最重要的是相关依赖管理太随意了, 根本就没有<strong>管理</strong>.各组件的版本管理也不规范, 导致后期维护性大打折扣. 现在能做的就是在不动主体框架的情况下, 尽量重构代码.</p> <p>当然我们也做过这方面的努力, 重构项目依赖管理, 重构日志, 重构配置, 重构组件, 但是改出来的东西却不尽人意, 给其他同事造成了工作上的负担. 不过这是重构阶段必须要经历的情况.</p> <p>12530 业务多, 代码多, 组件多, 基本上是牵一发而动全身, 因此在没有大量测试的情况下, 很难保证重构后的正确性与稳定性.</p> <p>因此按照我的建议就是不要改老代码了, 把业务迁移到 <code>ms-project</code> 上来, 至少依赖管理, 配置管理, 日志管理这些做的比老框架好, 代码也更规范.</p> <p>怎么重构代码以前或多或少说过一点, 这里再重申一下:</p> <p><strong>只要把 IDEA 提示的警告改完就可以了</strong>, 这种重构是对业务和测试影响最小的方式. 以前也说过怎么通过修改警告来学习底层的知识, 为什么 IDEA 对这段代码提出警告, 有没有更好的更规范的代码实现这段逻辑?</p> <p>在写业务逻辑的时候是不是沿用以前的代码规范和思考逻辑? 以前的代码就一定正确吗? 有没有优化的空间呢?</p> <p>举个例子:</p> <p>在做精准营销的时候, 先把相关代码捋一遍, 清楚个大概逻辑, 不需要深入看代码.</p> <p><strong>第一遍: 把遇到的所有警告提示看一遍</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inputStrings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这段代码有问题吗? IDEA 已经给出了提示</p> <ol><li><code>new HashMap&lt;String, String&gt;</code> 可以简化为 <code>new HashMap&lt;&gt;</code>;</li> <li>初始化 HashMap 时设置初始大小;</li></ol> <p>如果你看到这个提示, 你会不会想为什么能简化成 <code>new HashMap&lt;&gt;</code>?
为什么最好为 HashMap 设置初始值?</p> <p>你就会去查资料, 因为 JDK7 的新特性, 叫钻石语法, 那么你还可以查一下 JDK7 其他新的语法, 看是否能用到项目中.
给 HashMap 设置初始值是为了合理分配内存, 减少 resize 的次数, 从而提高效率.
那你就会去看 HashMap 源码, 你就会知道:</p> <ol><li>什么情况下回 resize;</li> <li>resize 后的容量是多少;</li> <li>负载因子又是什么;</li> <li>为什么 HashMap 不是线程安全的;</li> <li>有没有线程安全的 HashMap, 有哪些;</li> <li>HashMap 的存储方式是怎样的; JDK7 和 JDK8 的实现方式有什么不同;</li> <li>如果 key 是对象为什么要重写 hashCode() 和 equals()方法;</li> <li>为什么 HashMap 一般使用 String 做 key;</li> <li>....</li></ol> <p>然后再深入一些:</p> <ol><li>在多线程的情况下, 使用 HashMap 存在的问题;</li> <li>HashMap 与 ConcurrentHashMap 的区别; ConcurrentHashMap 又是怎么实现的;</li> <li>能不能说出 put() 的逻辑;</li> <li>更深入的了解 hashCode() 的作用;</li> <li>自己设计一个 hash 方法, 减少 hash 碰撞;</li> <li>能通过什么方式提高 HashMap 的查询效率;</li> <li>....</li></ol> <p>那说到 String, 又可以去看 String 的源码了, 然后你就会明白:</p> <ol><li>为什么 String 是不可变类; 自己怎么设计一个不可变类;</li> <li>为什么我们在循环里面不使用 <code>+</code> 来拼接字符串;</li> <li>与 StringBuffer, StringBuilder 的区别是什么;</li> <li>...</li></ol> <p>然后再深入一些:</p> <ol><li>String 的在内存中的存储位置;</li> <li>从 JDK6 开始, 是怎么优化 String 的;</li> <li>String 的不可变性是绝对的吗? 可不可以使用一些手段修改 String;</li> <li>....</li></ol> <p><strong>就看 1 行代码, 你能联想到这些问题吗?</strong></p> <p>不是说只写业务代码就不能学到东西, 学东西在哪儿都可以学到, 只要有这个心就行.</p> <p>先把基础知识学好了, 框架这些都是锦上添花的事.</p> <p><strong>第二遍: 把代码结构梳理一遍</strong></p> <p>简单的重构从第二遍开始, 一个方法超过 <strong>80</strong> 行, 就该拆分了.</p> <ol><li>有没有代码是共用的?</li> <li>能不能抽离成工具类?</li> <li>注释写好了吗?</li> <li>代码逻辑清晰了吗?</li> <li>注释掉的代码删没删? 留着干嘛? 算代码行数? 我们有版本管理, 不要的请直接删除.</li> <li>字段名, 方法名命名规范吗?</li> <li>有魔法值吗?</li> <li>tay-catch 合理包裹合理吗? 异常处理方式合理吗? 有没处理到的异常吗?</li> <li>必要的日志打印了吗? 日志等级设置合理吗?</li> <li>重载的方法写 <code>@Override</code> 注释了吗?</li> <li>方法的访问修饰符合理吗? 返回值合理吗? 入参合理吗?</li> <li>switch case 到了全部情况吗?</li> <li>if 判断合理吗?</li> <li>return 的地方合理吗?</li> <li>...</li></ol> <p>把你看到的不合理的地方全部重构了, 这一步也全部是借助 IDEA 强大的重构功能, 比如选中你想抽离为方法的代码, <code>ctl + shift + m</code> (windows 的快捷键不清楚, 好像是这个)自动重构, 只需要命名就可以了</p> <p><img src="http://qiniu.dong4j.info/2019-07-04-15520229273664.jpg" alt="-w636"></p> <p>其他的重构快捷键和功能自己去了解和使用.</p> <p><strong>把吃饭的工具使用熟练是最基本的要求</strong>, 然后就是效率问题, <strong>能自动化绝不手动, 能节约 1秒 时间的事, 我宁愿话 1 个小时来学习.</strong></p> <p>现在使用的工具有没有更好的工具可以替代? 有没有去了解过同类工具?
请记住, <strong>工具就是你的兵器</strong>, 一把趁手的兵器比手无寸铁好得多</p> <p><strong>第三遍: 梳理业务逻辑</strong></p> <p>这一遍就可以开始开发业务了.
了解需求, 先想怎么写, 不要一上来就开始写代码, 想一个方案出来, 相关的单元测试写出来, 再想想:</p> <ol><li>还有没有更好的实现方式?</li> <li>以前的代码存在的问题?</li> <li>以前的逻辑还能怎样优化?</li> <li>以前的接口定义合理吗?</li> <li>能不能运用到设计模式把业务抽离出来? 提高维护性和可扩展性?</li> <li>....</li></ol> <p>这部分没有太多话语权, 毕竟做的少. 举个例子吧:</p> <p><img src="http://qiniu.dong4j.info/2019-07-04-7D088AFA086A607BEC9864A0A89F31B4.jpg" alt="7D088AFA086A607BEC9864A0A89F31B4"></p> <p><img src="http://qiniu.dong4j.info/2019-07-04-F8CE288A6E38D46565D71B0A00D27F24.jpg" alt="F8CE288A6E38D46565D71B0A00D27F24"></p> <p>不是代码写得越多就越好, 不是方法越多代码结构就清晰.</p> <p><img src="http://qiniu.dong4j.info/2019-07-04-15520240417737.jpg" alt="-w1915"></p> <p>不要按照以前老的思路来写代码, 要有自己的思考.
以前的逻辑合理吗? 接口规范合理吗? 返回结果合理吗?</p> <p><img src="http://qiniu.dong4j.info/2019-07-04-70C9386E0369D3F1837F611BBB843072.png" alt="70C9386E0369D3F1837F611BBB843072"></p> <p>业务端传入 servicedId 来查指定的业务的订购状态, 为什么还要通过接口的 serviceId 返回类型来判断是不是查询的当前业务? 难道我查询的什么业务还要通过接口来告诉我吗?</p> <p>那传个 serviceId 还有什么意义?</p> <p>当然这里也有历史原因, 或者都可以说全部是历史原因, 但是我们现在可以改变, 可以重构, 为了更好的将来, 为了下一批维护者少掉坑里面, 这些都可以改....</p> <p>写得代码不是<strong>能跑通</strong>就可以了(「又不是不能跑」 😳), 需要思考和反思.</p> <p>最后多回顾自己的代码, 随着自己知识面的扩展, 知识点的加深, 再看看以前的代码是不是又有更好的实现方式, 再次重构啊.</p></div> <!----> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">7/5/2019, 4:26:09 PM</span></div></footer> <!----> </main> <div class="valine-wrapper" data-v-0162251c><div id="valine" data-v-0162251c></div></div></div> <div class="back-to-ceiling" style="right:1rem;bottom:3rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;background-color:rgba(231, 234, 241,.5);display:none;" data-v-d0bfeaa4 data-v-d0bfeaa4><i class="iconfont reco-up" data-v-d0bfeaa4></i></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.23d4d300.js" defer></script><script src="/assets/js/4.28fd9624.js" defer></script><script src="/assets/js/1.928d15b1.js" defer></script><script src="/assets/js/24.99537c05.js" defer></script>
  </body>
</html>
